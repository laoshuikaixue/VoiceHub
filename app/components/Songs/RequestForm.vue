<template>
  <div class="request-form">
    <div class="rules-section desktop-only-rules">
      <h2 class="section-title">æŠ•ç¨¿é¡»çŸ¥</h2>
      <div class="rules-content-desktop">
        <div
          v-if="submissionGuidelines"
          class="guidelines-content"
          v-html="submissionGuidelines.replace(/\n/g, '<br>')"
        />
        <div v-else class="default-guidelines">
          <p>1. æŠ•ç¨¿æ—¶æ— éœ€åŠ å…¥ä¹¦åå·</p>
          <p>2. é™¤DJå¤–ï¼Œå…¶ä»–ç±»å‹æ­Œæ›²å‡æ¥æ”¶ï¼ˆåŒ…æ‹¬å°è¯­ç§ï¼‰</p>
          <p>3. ç¦æ­¢æŠ•é€’å«æœ‰è¿è§„å†…å®¹çš„æ­Œæ›²</p>
          <p>4. ç‚¹æ’­çš„æ­Œæ›²å°†ç”±ç®¡ç†å‘˜è¿›è¡Œå®¡æ ¸</p>
          <p>5. å®¡æ ¸é€šè¿‡åå°†å®‰æ’åœ¨æ’­æ”¾æ—¶æ®µæ’­å‡º</p>
          <p>6. æäº¤å³è¡¨æ˜æˆ‘å·²é˜…è¯»æŠ•ç¨¿é¡»çŸ¥å¹¶å·²çŸ¥è¯¥æ­Œæ›²æœ‰æ¦‚ç‡æ— æ³•æ’­å‡º</p>
          <p>
            7.
            æœ¬ç³»ç»Ÿä»…æä¾›éŸ³ä¹æœç´¢å’Œæ’­æ”¾ç®¡ç†åŠŸèƒ½ï¼Œä¸å­˜å‚¨ä»»ä½•éŸ³ä¹æ–‡ä»¶ã€‚æ‰€æœ‰éŸ³ä¹å†…å®¹å‡æ¥è‡ªç¬¬ä¸‰æ–¹éŸ³ä¹å¹³å°ï¼Œç‰ˆæƒå½’åŸå¹³å°åŠç‰ˆæƒæ–¹æ‰€æœ‰ã€‚ç”¨æˆ·ç‚¹æ­Œæ—¶è¯·ç¡®ä¿éµå®ˆç›¸å…³éŸ³ä¹å¹³å°çš„æœåŠ¡æ¡æ¬¾ï¼Œå°Šé‡éŸ³ä¹ä½œå“ç‰ˆæƒã€‚æˆ‘ä»¬é¼“åŠ±ç”¨æˆ·æ”¯æŒæ­£ç‰ˆéŸ³ä¹ï¼Œåœ¨å®˜æ–¹å¹³å°è´­ä¹°å’Œæ”¶å¬å–œçˆ±çš„éŸ³ä¹ä½œå“ã€‚
          </p>
          <p>8. æœ€ç»ˆè§£é‡Šæƒå½’å¹¿æ’­ç«™æ‰€æœ‰</p>
        </div>
      </div>
    </div>

    <!-- Mobile Rules Section (Original RequestForm.vue style) -->
    <div class="rules-section mobile-only-rules">
      <h3 class="rules-title">
        <Icon :size="16" class="rules-icon" name="bell" />
        æŠ•ç¨¿é¡»çŸ¥
      </h3>
      <div class="rules-content">
        <div
          v-if="submissionGuidelines"
          class="guidelines-content"
          v-html="submissionGuidelines.replace(/\n/g, '<br>')"
        />
        <div v-else class="default-guidelines">
          <div class="rule-item"><span>1.</span> æŠ•ç¨¿æ—¶æ— éœ€åŠ å…¥ä¹¦åå·</div>
          <div class="rule-item"><span>2.</span> é™¤DJå¤–ï¼Œå…¶ä»–ç±»å‹æ­Œæ›²å‡æ¥æ”¶ï¼ˆåŒ…æ‹¬å°è¯­ç§ï¼‰</div>
          <div class="rule-item"><span>3.</span> ç¦æ­¢æŠ•é€’å«æœ‰è¿è§„å†…å®¹çš„æ­Œæ›²</div>
          <div class="rule-item"><span>4.</span> ç‚¹æ’­çš„æ­Œæ›²å°†ç”±ç®¡ç†å‘˜è¿›è¡Œå®¡æ ¸</div>
          <div class="rule-item"><span>5.</span> å®¡æ ¸é€šè¿‡åå°†å®‰æ’åœ¨æ’­æ”¾æ—¶æ®µæ’­å‡º</div>
          <div class="rule-item">
            <span>6.</span> æäº¤å³è¡¨æ˜æˆ‘å·²é˜…è¯»æŠ•ç¨¿é¡»çŸ¥å¹¶å·²çŸ¥è¯¥æ­Œæ›²æœ‰æ¦‚ç‡æ— æ³•æ’­å‡º
          </div>
          <div class="rule-item">
            <span>7.</span>
            æœ¬ç³»ç»Ÿä»…æä¾›éŸ³ä¹æœç´¢å’Œæ’­æ”¾ç®¡ç†åŠŸèƒ½ï¼Œä¸å­˜å‚¨ä»»ä½•éŸ³ä¹æ–‡ä»¶ã€‚æ‰€æœ‰éŸ³ä¹å†…å®¹å‡æ¥è‡ªç¬¬ä¸‰æ–¹éŸ³ä¹å¹³å°ï¼Œç‰ˆæƒå½’åŸå¹³å°åŠç‰ˆæƒæ–¹æ‰€æœ‰ã€‚
          </div>
          <div class="rule-item"><span>8.</span> æœ€ç»ˆè§£é‡Šæƒå½’å¹¿æ’­ç«™æ‰€æœ‰</div>
        </div>
      </div>
    </div>

    <div class="form-container">
      <form class="song-request-form" @submit.prevent="handleSearch">
        <!-- é¡¶éƒ¨è¡Œï¼šæœç´¢å’Œè”åˆæŠ•ç¨¿ -->
        <div class="form-header-row">
          <!-- æ­Œæ›²æœç´¢åŒºåŸŸ -->
          <div class="search-section">
            <div class="search-label">æ­Œæ›²æœç´¢</div>
            <div class="search-input-group">
              <input
                id="title"
                v-model="title"
                class="search-input"
                placeholder="è¯·è¾“å…¥æ­Œæ›²åç§°"
                required
                type="text"
                @input="checkSimilarSongs"
              >
              <button
                :disabled="loading || searching || !title.trim()"
                class="search-button"
                type="submit"
              >
                {{ loading || searching ? 'å¤„ç†ä¸­...' : 'æœç´¢' }}
              </button>
            </div>
            <button
              v-if="showImportSemesterBtn"
              class="import-semester-btn"
              type="button"
              title="ä»å¾€æœŸå¯¼å…¥"
              @click="showImportSongsModal = true"
            >
              <Icon :size="16" name="history" />
              <span class="btn-text">ä»å¾€æœŸå¯¼å…¥</span>
            </button>
          </div>

          <!-- è”åˆæŠ•ç¨¿äººåŒºåŸŸ -->
          <div v-if="user" class="collaborators-section">
            <div class="section-label">è”åˆæŠ•ç¨¿</div>
            <div class="collaborators-list">
              <div v-for="user in collaborators" :key="user.id" class="collaborator-tag">
                <span class="collaborator-name">{{ user.name }}</span>
                <button
                  class="remove-collaborator"
                  type="button"
                  @click="removeCollaborator(user.id)"
                >
                  <Icon :size="12" name="close" />
                </button>
              </div>
              <button
                class="add-collaborator-btn"
                type="button"
                @click="showUserSearchModal = true"
              >
                <Icon :size="14" name="plus" />
                æ·»åŠ 
              </button>
            </div>
          </div>
        </div>

        <!-- æœç´¢ç»“æœå®¹å™¨ -->
        <div class="search-results-container">
          <!-- æŠ•ç¨¿çŠ¶æ€æ˜¾ç¤º - æ¨ªå‘å¸ƒå±€ï¼Œåªåœ¨è®¾ç½®äº†é™é¢æ—¶æ˜¾ç¤º -->
          <div
            v-if="user && submissionStatus && submissionStatus.limitEnabled"
            class="submission-status-horizontal"
          >
            <!-- è¶…çº§ç®¡ç†å‘˜æç¤º -->
            <div
              v-if="user && (user.role === 'SUPER_ADMIN' || user.role === 'ADMIN')"
              class="admin-notice-horizontal"
            >
              <span class="admin-icon">ğŸ‘‘</span>
              <span class="admin-text">æ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œä¸å—æŠ•ç¨¿é™åˆ¶</span>
            </div>

            <!-- æŠ•ç¨¿å…³é—­æç¤º -->
            <div v-else-if="submissionStatus.submissionClosed" class="submission-closed-notice">
              <span class="closed-icon">ğŸš«</span>
              <span class="closed-text">
                {{
                  submissionStatus.timeLimitationEnabled && !submissionStatus.currentTimePeriod
                    ? 'å½“å‰ä¸åœ¨æŠ•ç¨¿å¼€æ”¾æ—¶æ®µ'
                    : 'æŠ•ç¨¿åŠŸèƒ½å·²å…³é—­'
                }}
              </span>
            </div>

            <!-- æŠ•ç¨¿çŠ¶æ€å†…å®¹ -->
            <div v-else class="status-content-horizontal">
              <!-- å½“å‰æ—¶æ®µä¿¡æ¯ -->
              <div
                v-if="submissionStatus.timeLimitationEnabled && submissionStatus.currentTimePeriod"
                class="status-item-horizontal"
              >
                <span class="status-label">å½“å‰æ—¶æ®µï¼š</span>
                <span class="status-value">{{ submissionStatus.currentTimePeriod.name }}</span>
                <span
                  v-if="submissionStatus.currentTimePeriod.expected > 0"
                  class="status-remaining"
                >
                  (å·²æ¥çº³ {{ submissionStatus.currentTimePeriod.accepted }} /
                  {{ submissionStatus.currentTimePeriod.expected }})
                </span>
              </div>

              <div v-if="submissionStatus.dailyLimit" class="status-item-horizontal">
                <span class="status-label">ä»Šæ—¥æŠ•ç¨¿ï¼š</span>
                <span class="status-value"
                  >{{ submissionStatus.dailyUsed }} / {{ submissionStatus.dailyLimit }}</span
                >
                <span class="status-remaining"
                  >å‰©ä½™
                  {{ Math.max(0, submissionStatus.dailyLimit - submissionStatus.dailyUsed) }}</span
                >
              </div>

              <div v-if="submissionStatus.weeklyLimit" class="status-item-horizontal">
                <span class="status-label">æœ¬å‘¨æŠ•ç¨¿ï¼š</span>
                <span class="status-value"
                  >{{ submissionStatus.weeklyUsed }} / {{ submissionStatus.weeklyLimit }}</span
                >
                <span class="status-remaining"
                  >å‰©ä½™
                  {{
                    Math.max(0, submissionStatus.weeklyLimit - submissionStatus.weeklyUsed)
                  }}</span
                >
              </div>
            </div>
          </div>

          <!-- éŸ³ä¹å¹³å°é€‰æ‹©æŒ‰é’® -->
          <div class="platform-selection-container">
            <div class="platform-selection">
              <button
                :class="['platform-btn', { active: platform === 'netease' }]"
                type="button"
                @click="switchPlatform('netease')"
              >
                ç½‘æ˜“äº‘éŸ³ä¹
              </button>
              <button
                :class="['platform-btn', { active: platform === 'tencent' }]"
                type="button"
                @click="switchPlatform('tencent')"
              >
                QQéŸ³ä¹
              </button>
              <button
                :class="['platform-btn', { active: platform === 'bilibili' }]"
                type="button"
                @click="switchPlatform('bilibili')"
              >
                å“”å“©å“”å“©
              </button>
            </div>

            <!-- ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•çŠ¶æ€å’Œé€‰é¡¹ -->
            <div v-if="platform === 'netease'" class="netease-options">
              <div class="netease-header">
                <div class="netease-badge">
                  <span class="netease-dot" />
                  <span class="netease-title">ç½‘æ˜“äº‘éŸ³ä¹è´¦å·</span>
                </div>
                <div class="header-actions">
                  <button
                    v-if="isNeteaseLoggedIn"
                    class="header-btn"
                    title="å¯¼å‡ºCookieæ•°æ®"
                    type="button"
                    @click="handleExportData"
                  >
                    <Icon :size="14" name="download" />
                    å¯¼å‡º
                  </button>
                  <button
                    v-if="isNeteaseLoggedIn"
                    class="logout-btn"
                    type="button"
                    @click="handleLogoutNetease"
                  >
                    <Icon :size="14" name="logout" />
                    é€€å‡º
                  </button>
                </div>
              </div>

              <!-- åŠ è½½ä¸­çŠ¶æ€ -->
              <div v-if="checkingNeteaseLogin" class="netease-loading-state">
                <div class="loading-content">
                  <div class="loading-spinner" />
                  <span class="loading-text">åˆ·æ–°ä¸­</span>
                </div>
              </div>

              <!-- æœªç™»å½•çŠ¶æ€ -->
              <div v-else-if="!isNeteaseLoggedIn" class="login-entry">
                <div class="login-desc">
                  <p class="login-title">ç™»å½•ç½‘æ˜“äº‘éŸ³ä¹</p>
                  <p class="login-hint">æ”¯æŒæœç´¢æ‚¨çš„ä¸ªäººæ­Œå•ã€æ”¶è—åŠæ’­å®¢å†…å®¹</p>
                </div>
                <div class="login-actions">
                  <button class="login-btn" type="button" @click="showLoginModal = true">
                    ç«‹å³ç™»å½•
                  </button>
                  <button class="import-btn" type="button" @click="handleImportClick">
                    <Icon :size="14" name="upload" />
                    å¯¼å…¥æ•°æ®
                  </button>
                </div>
              </div>

              <!-- å·²ç™»å½•çŠ¶æ€ -->
              <div v-else class="user-status">
                <div class="user-compact-row">
                  <div class="user-profile">
                    <img
                      v-if="neteaseUser?.avatarUrl"
                      :src="convertToHttps(neteaseUser.avatarUrl)"
                      alt="avatar"
                      class="user-avatar"
                    >
                    <span class="user-name">{{ neteaseUser?.nickname || 'å·²ç™»å½•' }}</span>
                  </div>

                  <div class="search-type-switch">
                    <label :class="['radio-label', { active: searchType === 1 }]">
                      <input v-model="searchType" :value="1" type="radio" > å•æ›²
                    </label>
                    <label :class="['radio-label', { active: searchType === 1009 }]">
                      <input v-model="searchType" :value="1009" type="radio" > æ’­å®¢
                    </label>
                  </div>

                  <div class="user-actions-row">
                    <button
                      class="action-btn-compact"
                      title="æœ€è¿‘æ’­æ”¾"
                      type="button"
                      @click="showRecentSongsModal = true"
                    >
                      <Icon :size="14" name="history" />
                      <span>æœ€è¿‘æ’­æ”¾</span>
                    </button>
                    <button
                      class="action-btn-compact"
                      title="ä»æ­Œå•æŠ•ç¨¿"
                      type="button"
                      @click="showPlaylistModal = true"
                    >
                      <Icon :size="14" name="playlist" />
                      <span>ä»æ­Œå•æŠ•ç¨¿</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="results-content">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="searching" class="loading-state">
              <div class="loading-spinner" />
              <p class="loading-text">å¤„ç†ä¸­...</p>
            </div>

            <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
            <Transition mode="out-in" name="results-fade">
              <div v-if="searchResults.length > 0 && !searching" key="results" class="results-list">
                <TransitionGroup class="results-grid" name="result-item" tag="div">
                  <div
                    v-for="(result, index) in searchResults"
                    :key="`${platform}-${result.id || index}`"
                    class="result-item group"
                  >
                    <div
                      class="result-cover"
                      @click.stop="isBilibiliMultiP(result) ? submitSong(result) : playSong(result)"
                    >
                      <img
                        :src="convertToHttps(result.cover)"
                        alt="å°é¢"
                        class="cover-img"
                        referrerpolicy="no-referrer"
                      >
                      <div v-if="!isBilibiliMultiP(result)" class="play-overlay-container">
                        <div class="play-button-wrapper">
                          <Icon name="play" :size="20" class="play-icon" />
                        </div>
                      </div>
                    </div>
                    <div class="result-info">
                      <h4 class="result-title">{{ result.song || result.title }}</h4>
                      <p class="result-artist">{{ result.singer || result.artist }}</p>
                      <p v-if="result.album" class="result-album">ä¸“è¾‘ï¼š{{ result.album }}</p>
                    </div>
                    <div class="result-actions">
                      <!-- QQéŸ³ä¹ä¸Šä¼ åˆ°ç½‘æ˜“äº‘æŒ‰é’® -->
                      <button
                        v-if="platform === 'tencent'"
                        class="cloud-disk-btn"
                        title="ä¸Šä¼ åˆ°ç½‘æ˜“äº‘éŸ³ä¹äº‘ç›˜"
                        @click.stop.prevent="openUploadDialog(result)"
                      >
                        <Icon name="cloud-upload" :size="18" />
                      </button>

                      <!-- å¤šPè§†é¢‘çš„ç‰¹æ®Šå¤„ç† -->
                      <div
                        v-if="
                          isBilibiliMultiP(result) && getBilibiliEpisodeStatus(result)?.allSubmitted
                        "
                        class="similar-song-info"
                      >
                        <span class="similar-text">æ‰€æœ‰å‰§é›†å·²å­˜åœ¨</span>
                      </div>
                      <div
                        v-else-if="
                          isBilibiliMultiP(result) &&
                          getBilibiliEpisodeStatus(result)?.partialSubmitted
                        "
                        class="similar-song-info"
                      >
                        <span class="similar-text">éƒ¨åˆ†å‰§é›†å·²å­˜åœ¨</span>
                        <button
                          :disabled="submitting"
                          class="select-btn"
                          @click.stop.prevent="submitSong(result)"
                        >
                          é€‰æ‹©å‰§é›†
                        </button>
                      </div>
                      <!-- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸ä¼¼æ­Œæ›² -->
                      <div v-else-if="getSimilarSong(result)" class="similar-song-info">
                        <!-- æ ¹æ®æ­Œæ›²çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ–‡æœ¬ -->
                        <span
                          v-if="getSimilarSong(result)?.played"
                          class="similar-text status-played"
                        >
                          {{
                            isSuperAdmin
                              ? 'æ­Œæ›²å·²æ’­æ”¾'
                              : enableReplayRequests
                                ? 'æ­Œæ›²å·²æ’­æ”¾'
                                : 'æ­Œæ›²å·²æ’­æ”¾'
                          }}
                        </span>
                        <span
                          v-else-if="getSimilarSong(result)?.scheduled"
                          class="similar-text status-scheduled"
                          >æ­Œæ›²å·²æ’æœŸ</span
                        >
                        <span v-else class="similar-text">æ­Œæ›²å·²å­˜åœ¨</span>

                        <!-- è¶…çº§ç®¡ç†å‘˜å¯¹å·²æ’­æ”¾çš„ç›¸ä¼¼æ­Œæ›²ï¼šæ˜¾ç¤ºç»§ç»­æŠ•ç¨¿ -->
                        <button
                          v-if="getSimilarSong(result)?.played && isSuperAdmin"
                          :disabled="submitting"
                          class="select-btn"
                          @click.stop.prevent="submitSong(result, { forceResubmit: true })"
                        >
                          ç»§ç»­æŠ•ç¨¿
                        </button>

                        <!-- å¼€å¯é‡æ’­ç”³è¯·ä¸”éç®¡ç†å‘˜å¯¹å·²æ’­æ”¾çš„ç›¸ä¼¼æ­Œæ›²ï¼šæ˜¾ç¤ºç”³è¯·é‡æ’­ -->
                        <button
                          v-else-if="getSimilarSong(result)?.played && enableReplayRequests"
                          :disabled="isReplayButtonDisabled(getSimilarSong(result))"
                          :title="getReplayButtonTitle(getSimilarSong(result))"
                          class="replay-btn"
                          @click.stop.prevent="handleRequestReplay(getSimilarSong(result))"
                        >
                          {{ getReplayButtonText(getSimilarSong(result)) }}
                        </button>

                        <!-- å…¶ä»–ç”¨æˆ·ï¼šæ˜¾ç¤ºç‚¹èµæŒ‰é’®ï¼Œæ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒæ ·å¼ -->
                        <button
                          v-else
                          :class="{
                            disabled:
                              getSimilarSong(result)?.played ||
                              getSimilarSong(result)?.scheduled ||
                              getSimilarSong(result)?.voted ||
                              submitting
                          }"
                          :disabled="
                            getSimilarSong(result)?.played ||
                            getSimilarSong(result)?.scheduled ||
                            getSimilarSong(result)?.voted ||
                            submitting
                          "
                          :title="
                            getSimilarSong(result)?.played
                              ? 'å·²æ’­æ”¾çš„æ­Œæ›²ä¸èƒ½ç‚¹èµ'
                              : getSimilarSong(result)?.scheduled
                                ? 'å·²æ’æœŸçš„æ­Œæ›²ä¸èƒ½ç‚¹èµ'
                                : getSimilarSong(result)?.voted
                                  ? 'å·²ç‚¹èµ'
                                  : 'ç‚¹èµ'
                          "
                          class="like-btn"
                          @click.stop.prevent="
                            getSimilarSong(result)?.played || getSimilarSong(result)?.scheduled
                              ? null
                              : handleLikeFromSearch(getSimilarSong(result), result)
                          "
                        >
                          <svg
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            viewBox="0 0 24 24"
                          >
                            <path
                              d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                            />
                          </svg>
                          {{
                            getSimilarSong(result)?.played
                              ? 'å·²æ’­æ”¾'
                              : getSimilarSong(result)?.scheduled
                                ? 'å·²æ’æœŸ'
                                : getSimilarSong(result)?.voted
                                  ? 'å·²ç‚¹èµ'
                                  : 'ç‚¹èµ'
                          }}
                        </button>
                      </div>
                      <button
                        v-else
                        :disabled="submitting"
                        class="select-btn"
                        @click.stop.prevent="submitSong(result)"
                      >
                        {{
                          submitting
                            ? 'å¤„ç†ä¸­...'
                            : platform === 'netease' && searchType === 1009
                              ? 'é€‰æ‹©èŠ‚ç›®'
                              : isBilibiliMultiP(result)
                                ? 'é€‰æ‹©å‰§é›†'
                                : 'é€‰æ‹©æŠ•ç¨¿'
                        }}
                      </button>
                    </div>
                  </div>
                </TransitionGroup>

                <!-- æ‰‹åŠ¨è¾“å…¥æŒ‰é’® -->
                <div class="no-results-action">
                  <button class="manual-submit-btn" type="button" @click="showManualModal = true">
                    ä»¥ä¸Šæ²¡æœ‰æˆ‘æƒ³è¦çš„æ­Œæ›²ï¼Œæ‰‹åŠ¨è¾“å…¥æäº¤
                  </button>
                </div>
              </div>

              <!-- ç©ºçŠ¶æ€ -->
              <div v-else-if="!searching && hasSearched" key="empty" class="empty-state">
                <div class="empty-icon">ğŸ”</div>
                <p class="empty-text">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</p>
                <p class="empty-hint">è¯•è¯•å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢å¹³å°</p>
                <button class="manual-submit-btn" type="button" @click="showManualModal = true">
                  æ‰‹åŠ¨è¾“å…¥æäº¤
                </button>
              </div>

              <!-- åˆå§‹çŠ¶æ€ -->
              <div v-else-if="!searching" key="initial" class="initial-state">
                <div class="search-illustration">
                  <img alt="æœç´¢æ­Œæ›²" class="search-svg" :src="searchIcon" >
                </div>
              </div>
            </Transition>
          </div>
        </div>

        <!-- æ’­å‡ºæ—¶æ®µé€‰æ‹© -->
        <div v-if="playTimeSelectionEnabled && playTimes.length > 0" class="form-group">
          <div class="input-wrapper">
            <CustomSelect
              v-model="preferredPlayTimeId"
              :options="formattedPlayTimes"
              label="æœŸæœ›æ’­å‡ºæ—¶æ®µ"
              label-key="displayName"
              value-key="id"
              placeholder="é€‰æ‹©æ—¶æ®µ"
            />
          </div>
        </div>
      </form>

      <div v-if="groupedSimilarSongs.length > 0" class="similar-song-alert">
        <div class="alert-header">
          <div class="alert-header-left">
            <Icon :size="16" class="alert-icon" name="warning" />
            <span class="alert-title">å‘ç°å¯èƒ½ç›¸ä¼¼çš„æ­Œæ›²</span>
          </div>
          <!-- å®½å±æ—¶æ˜¾ç¤ºåœ¨å³ä¸Šè§’çš„ç»§ç»­æŠ•ç¨¿æŒ‰é’® -->
          <button
            :disabled="submitting"
            class="ignore-btn desktop-continue-btn"
            type="button"
            @click="ignoreSimilar"
          >
            ç»§ç»­æŠ•ç¨¿
          </button>
        </div>
        <div class="similar-songs-list">
          <!-- éå†åˆ†ç»„åçš„ç›¸ä¼¼æ­Œæ›² -->
          <div
            v-for="group in groupedSimilarSongs"
            :key="group.isSingle ? group.song.id : group.bvid"
            class="similar-song-item"
          >
            <!-- å•ä¸ªæ­Œæ›²ï¼ˆéå“”å“©å“”å“©å¤šPï¼‰ -->
            <template v-if="group.isSingle">
              <div class="song-info">
                <p class="song-title">
                  ã€Š{{ group.song.title }} - {{ group.song.artist }}ã€‹
                  <span v-if="group.song.played" class="song-status status-played">å·²æ’­æ”¾</span>
                  <span v-else-if="group.song.scheduled" class="song-status status-scheduled"
                    >å·²æ’æœŸ</span
                  >
                </p>
                <!-- æ ¹æ®æ­Œæ›²çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æç¤º -->
                <p v-if="group.song.played" class="alert-hint">
                  {{
                    isSuperAdmin
                      ? 'è¯¥æ­Œæ›²å·²æ’­æ”¾ï¼Œæ‚¨å¯ä»¥ç»§ç»­æŠ•ç¨¿'
                      : enableReplayRequests
                        ? 'è¯¥æ­Œæ›²å·²æ’­æ”¾'
                        : 'è¯¥æ­Œæ›²å·²æ’­æ”¾ï¼Œæ— æ³•è¿›è¡ŒæŠ•ç¥¨æ“ä½œ'
                  }}
                </p>
                <p v-else-if="group.song.scheduled" class="alert-hint">
                  è¯¥æ­Œæ›²å·²æ’æœŸï¼Œæ— æ³•è¿›è¡ŒæŠ•ç¥¨æ“ä½œ
                </p>
                <p v-else-if="!group.song.voted" class="alert-hint">
                  è¯¥æ­Œæ›²å·²åœ¨åˆ—è¡¨ä¸­ï¼Œæ˜¯å¦è¦æŠ•ç¥¨æ”¯æŒï¼Ÿ
                </p>
                <p v-else-if="group.song.voted" class="voted-status">
                  <Icon :size="14" name="success" style="margin-right: 4px" />
                  æ‚¨å·²ä¸ºæ­¤æ­Œæ›²æŠ•ç¥¨
                </p>
              </div>
              <!-- åªæœ‰åœ¨æ­Œæ›²æœªæ’æœŸã€æœªæ’­æ”¾ä¸”æœªæŠ•ç¥¨æ—¶æ‰æ˜¾ç¤ºæŠ•ç¥¨æŒ‰é’® -->
              <div
                v-if="!group.song.voted && !group.song.played && !group.song.scheduled"
                class="song-actions"
              >
                <button
                  :disabled="voting || submitting"
                  class="vote-btn small"
                  type="button"
                  @click="voteForSimilar(group.song)"
                >
                  {{ voting ? 'æŠ•ç¥¨ä¸­...' : 'æŠ•ç¥¨æ”¯æŒ' }}
                </button>
              </div>
              <!-- å¦‚æœæ­Œæ›²å·²æ’­æ”¾ä¸”å¼€å¯äº†é‡æ’­ç”³è¯·ï¼ˆè¶…çº§ç®¡ç†å‘˜ä¸æ˜¾ç¤ºï¼‰ -->
              <div
                v-if="
                  group.song.played &&
                  enableReplayRequests &&
                  !isSuperAdmin &&
                  group.song.semester === currentSemester?.name
                "
                class="song-actions"
              >
                <button
                  :disabled="isReplayButtonDisabled(group.song)"
                  :title="getReplayButtonTitle(group.song)"
                  class="replay-btn small"
                  type="button"
                  @click="handleRequestReplay(group.song)"
                >
                  {{ getReplayButtonText(group.song) }}
                </button>
              </div>
            </template>

            <!-- å“”å“©å“”å“©å¤šPåˆé›† -->
            <template v-else>
              <div class="song-info">
                <p class="song-title">
                  ã€Š{{ group.title }} - {{ group.artist }}ã€‹
                  <span v-if="group.allPlayed" class="song-status status-played">å…¨éƒ¨å·²æ’­æ”¾</span>
                  <span v-else-if="group.allScheduled" class="song-status status-scheduled"
                    >å…¨éƒ¨å·²æ’æœŸ</span
                  >
                  <span v-else class="song-status">{{ group.episodes.length }} ä¸ªå‰§é›†</span>
                </p>
                <p class="alert-hint">è¯¥åˆé›†æœ‰ {{ group.episodes.length }} ä¸ªå‰§é›†åœ¨åˆ—è¡¨ä¸­</p>
              </div>
              <div class="song-actions">
                <button
                  :disabled="submitting"
                  class="vote-btn small"
                  type="button"
                  @click.stop="openSimilarEpisodesModal(group)"
                >
                  æŸ¥çœ‹è¯¦æƒ…
                </button>
              </div>
            </template>
          </div>
        </div>
        <!-- ç§»åŠ¨ç«¯æ—¶æ˜¾ç¤ºåœ¨åº•éƒ¨çš„ç»§ç»­æŠ•ç¨¿æŒ‰é’® -->
        <div class="alert-actions mobile-continue-actions">
          <button
            :disabled="submitting"
            class="ignore-btn mobile-continue-btn"
            type="button"
            @click="ignoreSimilar"
          >
            ç»§ç»­æŠ•ç¨¿
          </button>
        </div>
      </div>
    </div>

    <!-- å†å²å­¦æœŸå¯¼å…¥å¼¹çª— -->
    <ImportSongsModal
      :show="showImportSongsModal"
      @close="showImportSongsModal = false"
      @import-success="handleImportSuccess"
    />

    <!-- ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•å¼¹çª— -->
    <NeteaseLoginModal
      :show="showLoginModal"
      @close="showLoginModal = false"
      @login-success="handleLoginSuccess"
    />

    <!-- æ’­å®¢èŠ‚ç›®åˆ—è¡¨å¼¹çª— -->
    <PodcastEpisodesModal
      ref="podcastModalRef"
      :cookie="podcastCookie"
      :radio-id="selectedPodcastId"
      :radio-name="selectedPodcastName"
      :show="showPodcastModal"
      @close="showPodcastModal = false"
      @play="handlePodcastPlay"
      @submit="handlePodcastSubmit"
    />

    <!-- Bilibili å‰§é›†é€‰æ‹©å¼¹çª— -->
    <BilibiliEpisodesModal
      ref="bilibiliModalRef"
      :show="showBilibiliEpisodesModal"
      :video="selectedBilibiliVideo"
      :episodes="bilibiliEpisodes"
      :submitted-episodes="getBilibiliEpisodeStatus(selectedBilibiliVideo)?.submittedEpisodes || []"
      :current-user-id="user?.id"
      @close="showBilibiliEpisodesModal = false"
      @play="handleBilibiliEpisodePlay"
      @submit="handleBilibiliEpisodeSelect"
      @vote="handleEpisodeVote"
    />

    <!-- ä¸Šä¼ åˆ°ç½‘æ˜“äº‘éŸ³ä¹å¼¹çª— -->
    <NeteaseUploadDialog
      :show="showUploadDialog"
      :song="selectedUploadSong"
      @close="showUploadDialog = false"
      @show-login="handleShowLogin"
    />

    <!-- æœ€è¿‘æ’­æ”¾æ­Œæ›²å¼¹çª— -->
    <RecentSongsModal
      ref="recentSongsModalRef"
      :cookie="neteaseCookie"
      :show="showRecentSongsModal"
      @close="showRecentSongsModal = false"
      @play="handleRecentSongPlay"
      @submit="handleRecentSongSubmit"
    />

    <!-- æ­Œå•é€‰æ‹©å¼¹çª— -->
    <PlaylistSelectionModal
      ref="playlistModalRef"
      :cookie="neteaseCookie"
      :show="showPlaylistModal"
      :uid="neteaseUser?.userId || neteaseUser?.id"
      @close="showPlaylistModal = false"
      @play="handlePlaylistPlay"
      @submit="handlePlaylistSubmit"
    />

    <!-- ç”¨æˆ·æœç´¢å¼¹çª— -->
    <UserSearchModal
      v-model:show="showUserSearchModal"
      :exclude-ids="[user?.id, ...collaborators.map((u) => u.id)]"
      :multiple="true"
      title="æ·»åŠ è”åˆæŠ•ç¨¿äºº"
      @select="handleUserSelect"
    />

    <!-- æ‰‹åŠ¨è¾“å…¥å¼¹çª— -->
    <Teleport to="body">
      <Transition
        enter-active-class="transition duration-300 ease-out"
        enter-from-class="opacity-0 scale-95"
        enter-to-class="opacity-100 scale-100"
        leave-active-class="transition duration-200 ease-in"
        leave-from-class="opacity-100 scale-100"
        leave-to-class="opacity-0 scale-95"
      >
        <div
          v-if="showManualModal"
          class="fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6"
          @click.self="showManualModal = false"
        >
          <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" />

          <div
            class="relative w-full max-w-lg bg-zinc-900 border border-zinc-800 rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden"
            @click.stop
          >
            <!-- Header -->
            <div class="flex items-center justify-between p-8 pb-4">
              <h3 class="text-xl font-black text-zinc-100 tracking-tight">æ‰‹åŠ¨è¾“å…¥æ­Œæ›²ä¿¡æ¯</h3>
              <button
                class="w-10 h-10 flex items-center justify-center rounded-full bg-zinc-800/50 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-all"
                @click="showManualModal = false"
              >
                <X class="w-5 h-5" />
              </button>
            </div>

            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-8 pt-4 custom-scrollbar">
              <div class="manual-form-fields space-y-6">
                <!-- æ­Œæ›²åç§° -->
                <div class="form-field space-y-2">
                  <label
                    class="field-label text-sm font-black text-zinc-500 uppercase tracking-widest ml-1"
                    >æ­Œæ›²åç§°</label
                  >
                  <div class="input-container relative group">
                    <input
                      :value="title"
                      class="w-full px-6 py-4 bg-zinc-800/30 border border-zinc-800 rounded-2xl text-zinc-400 font-bold focus:outline-none cursor-not-allowed transition-all"
                      readonly
                      type="text"
                    >
                    <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
                      <Lock class="w-4 h-4 text-zinc-600" />
                    </div>
                  </div>
                </div>

                <!-- æ­Œæ‰‹åç§° -->
                <div class="form-field space-y-2">
                  <label
                    for="modal-artist"
                    class="field-label text-sm font-black text-zinc-500 uppercase tracking-widest ml-1"
                    >æ­Œæ‰‹åç§°</label
                  >
                  <div class="input-container relative group">
                    <input
                      id="modal-artist"
                      v-model="manualArtist"
                      class="w-full px-6 py-4 bg-zinc-800/50 border border-zinc-700/50 rounded-2xl text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-zinc-700 focus:bg-zinc-800 transition-all"
                      placeholder="è¯·è¾“å…¥æ­Œæ‰‹åç§°"
                      required
                      type="text"
                    >
                  </div>
                </div>

                <!-- æ­Œæ›²å°é¢åœ°å€ -->
                <div class="form-field space-y-2">
                  <label
                    for="modal-cover"
                    class="field-label text-sm font-black text-zinc-500 uppercase tracking-widest ml-1"
                    >æ­Œæ›²å°é¢åœ°å€ï¼ˆé€‰å¡«ï¼‰</label
                  >
                  <div class="input-container relative group">
                    <input
                      id="modal-cover"
                      v-model="manualCover"
                      :class="[
                        'w-full px-6 py-4 bg-zinc-800/50 border rounded-2xl text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 transition-all',
                        manualCover && !coverValidation.valid
                          ? 'border-red-500/50 focus:ring-red-500/20'
                          : 'border-zinc-700/50 focus:ring-zinc-700 focus:bg-zinc-800'
                      ]"
                      placeholder="è¯·è¾“å…¥æ­Œæ›²å°é¢å›¾ç‰‡URL"
                      type="url"
                    >
                    <div
                      v-if="coverValidation.validating"
                      class="absolute inset-y-0 right-4 flex items-center"
                    >
                      <Loader2 class="w-4 h-4 text-zinc-400 animate-spin" />
                    </div>
                  </div>
                  <Transition
                    enter-active-class="transition duration-200 ease-out"
                    enter-from-class="opacity-0 -translate-y-1"
                    enter-to-class="opacity-100 translate-y-0"
                  >
                    <div v-if="manualCover && !coverValidation.validating" class="px-1">
                      <p v-if="!coverValidation.valid" class="text-xs font-bold text-red-400">
                        {{ coverValidation.error }}
                      </p>
                      <p v-else class="text-xs font-bold text-emerald-400 flex items-center">
                        <Check class="w-3 h-3 mr-1" /> URLæœ‰æ•ˆ
                      </p>
                    </div>
                  </Transition>
                </div>

                <!-- æ’­æ”¾åœ°å€ -->
                <div class="form-field space-y-2">
                  <label
                    for="modal-play-url"
                    class="field-label text-sm font-black text-zinc-500 uppercase tracking-widest ml-1"
                    >æ’­æ”¾åœ°å€ï¼ˆé€‰å¡«ï¼‰</label
                  >
                  <div class="input-container relative group">
                    <input
                      id="modal-play-url"
                      v-model="manualPlayUrl"
                      :class="[
                        'w-full px-6 py-4 bg-zinc-800/50 border rounded-2xl text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 transition-all',
                        manualPlayUrl && !playUrlValidation.valid
                          ? 'border-red-500/50 focus:ring-red-500/20'
                          : 'border-zinc-700/50 focus:ring-zinc-700 focus:bg-zinc-800'
                      ]"
                      placeholder="è¯·è¾“å…¥æ­Œæ›²æ’­æ”¾URL"
                      type="url"
                    >
                    <div
                      v-if="playUrlValidation.validating"
                      class="absolute inset-y-0 right-4 flex items-center"
                    >
                      <Loader2 class="w-4 h-4 text-zinc-400 animate-spin" />
                    </div>
                  </div>
                  <Transition
                    enter-active-class="transition duration-200 ease-out"
                    enter-from-class="opacity-0 -translate-y-1"
                    enter-to-class="opacity-100 translate-y-0"
                  >
                    <div v-if="manualPlayUrl && !playUrlValidation.validating" class="px-1">
                      <p v-if="!playUrlValidation.valid" class="text-xs font-bold text-red-400">
                        {{ playUrlValidation.error }}
                      </p>
                      <p v-else class="text-xs font-bold text-emerald-400 flex items-center">
                        <Check class="w-3 h-3 mr-1" /> URLæœ‰æ•ˆ
                      </p>
                    </div>
                  </Transition>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="p-8 pt-0">
              <div class="flex gap-3">
                <button
                  class="flex-1 px-6 py-4 rounded-2xl bg-zinc-800 text-zinc-300 font-bold hover:bg-zinc-700 hover:text-zinc-100 transition-all active:scale-95"
                  type="button"
                  @click="showManualModal = false"
                >
                  å–æ¶ˆ
                </button>
                <button
                  :disabled="!canSubmitManualForm || submitting"
                  class="flex-[2] px-6 py-4 rounded-2xl bg-zinc-100 text-zinc-900 font-black hover:bg-white disabled:opacity-50 disabled:hover:bg-zinc-100 disabled:active:scale-100 transition-all active:scale-95"
                  type="button"
                  @click="handleManualSubmit"
                >
                  {{ submitting ? 'æäº¤ä¸­...' : 'ç¡®è®¤æäº¤' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </Transition>
    </Teleport>
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
    <input
      ref="fileInput"
      accept=".json"
      style="display: none"
      type="file"
      @change="handleImportData"
    >
  </div>
</template>

<script setup>
import { computed, onMounted, ref, watch } from 'vue'
import searchIcon from '~/public/images/search.svg'
import { X, Lock, Loader2, Check } from 'lucide-vue-next'
import { useSongs } from '~/composables/useSongs'
import { useAudioPlayer } from '~/composables/useAudioPlayer'
import { useSiteConfig } from '~/composables/useSiteConfig'
import { useAuth } from '~/composables/useAuth'
import { useSemesters } from '~/composables/useSemesters'
import { useMusicSources } from '~/composables/useMusicSources'
import CustomSelect from '~/components/UI/Common/CustomSelect.vue'
import Icon from '../UI/Icon.vue'
import { convertToHttps, validateUrl } from '~/utils/url'
import { getLoginStatus } from '~/utils/neteaseApi'

import ImportSongsModal from './ImportSongsModal.vue'
import NeteaseLoginModal from './NeteaseLoginModal.vue'
import PodcastEpisodesModal from './PodcastEpisodesModal.vue'
import BilibiliEpisodesModal from './BilibiliEpisodesModal.vue'
import RecentSongsModal from './RecentSongsModal.vue'
import PlaylistSelectionModal from './PlaylistSelectionModal.vue'
import UserSearchModal from '../Common/UserSearchModal.vue'
import NeteaseUploadDialog from './NeteaseUploadDialog.vue'

const props = defineProps({
  loading: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['request', 'vote'])

// ç«™ç‚¹é…ç½®
const { guidelines: submissionGuidelines, initSiteConfig, enableReplayRequests } = useSiteConfig()

// ç”¨æˆ·è®¤è¯
const auth = useAuth()
const user = computed(() => auth.user.value)
const isSuperAdmin = computed(() => user.value?.role === 'SUPER_ADMIN')

// å­¦æœŸç®¡ç†
const { fetchCurrentSemester, currentSemester, fetchSemesterOptions, semesters } = useSemesters()

// æ˜¯å¦æ˜¾ç¤ºâ€œä»å¾€æœŸå¯¼å…¥â€æŒ‰é’®ï¼šåªæœ‰åœ¨æœ‰å¤šä¸ªå­¦æœŸçš„æƒ…å†µä¸‹æ‰æ˜¾ç¤º
const showImportSemesterBtn = computed(() => semesters.value && semesters.value.length > 1)

const title = ref('')
const artist = ref('')
const platform = ref('netease') // é»˜è®¤ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹
const preferredPlayTimeId = ref('')
const error = ref('')
const success = ref('')
const submitting = ref(false)
const voting = ref(false)
const requestingReplay = ref(false)
const similarSongs = ref([])

// æŒ‰ BV å·åˆ†ç»„ç›¸ä¼¼æ­Œæ›²ï¼ˆæ¯ä¸ªåˆé›†åªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
const groupedSimilarSongs = computed(() => {
  const groups = new Map()

  for (const song of similarSongs.value) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯å“”å“©å“”å“©è§†é¢‘
    if (song.musicPlatform === 'bilibili' && song.musicId) {
      const bvid = song.musicId.includes(':') ? song.musicId.split(':')[0] : song.musicId

      if (!groups.has(bvid)) {
        // åˆ›å»ºæ–°çš„åˆ†ç»„
        groups.set(bvid, {
          bvid,
          title: song.title.split(' - ')[0] || song.title, // æå–åˆé›†æ ‡é¢˜
          artist: song.artist,
          cover: song.cover,
          episodes: [],
          allPlayed: true,
          allScheduled: true,
          hasVoted: false
        })
      }

      const group = groups.get(bvid)
      group.episodes.push(song)

      // æ›´æ–°çŠ¶æ€
      if (!song.played) group.allPlayed = false
      if (!song.scheduled) group.allScheduled = false
      if (song.voted) group.hasVoted = true
    } else {
      // éå“”å“©å“”å“©è§†é¢‘ï¼Œç›´æ¥ä½œä¸ºå•ç‹¬é¡¹
      const key = `${song.id}`
      if (!groups.has(key)) {
        groups.set(key, {
          isSingle: true,
          song
        })
      }
    }
  }

  return Array.from(groups.values())
})
const showImportSongsModal = ref(false)
const showLoginModal = ref(false)
const isNeteaseLoggedIn = ref(false)
const neteaseUser = ref(null)
const neteaseCookie = ref('')
const searchType = ref(1) // 1: å•æ›², 1009: æ’­å®¢/ç”µå°

// æ’­å®¢å¼¹çª—ç›¸å…³
const showPodcastModal = ref(false)
const selectedPodcastId = ref('')
const selectedPodcastName = ref('')
const podcastCookie = ref('')

const showRecentSongsModal = ref(false)
const showPlaylistModal = ref(false)
const showUserSearchModal = ref(false)
const collaborators = ref([])

const songService = useSongs()
const playTimes = ref([])
const playTimeSelectionEnabled = ref(false)
const loadingPlayTimes = ref(false)

// æŠ•ç¨¿çŠ¶æ€
const submissionStatus = ref(null)
const loadingSubmissionStatus = ref(false)

// æœç´¢ç›¸å…³
const searching = ref(false)
const searchResults = ref([])
const selectedCover = ref('')
const selectedUrl = ref('')
const audioPlayer = useAudioPlayer() // ä½¿ç”¨å…¨å±€éŸ³é¢‘æ’­æ”¾å™¨

// æœç´¢è¯·æ±‚æ§åˆ¶å™¨
const searchAbortController = ref(null)

// éŸ³æºç®¡ç†å™¨
const musicSources = useMusicSources()
const { currentSource, sourceStatus, sourceStatusSummary, currentSourceInfo } = musicSources
const searchError = ref('')

// æ‰‹åŠ¨è¾“å…¥ç›¸å…³
const showManualModal = ref(false)

const showBilibiliEpisodesModal = ref(false)
const selectedBilibiliVideo = ref(null)
const bilibiliEpisodes = ref([])
const manualArtist = ref('')
const manualCover = ref('')
const manualPlayUrl = ref('')
const hasSearched = ref(false)

// ä¸Šä¼ åˆ°ç½‘æ˜“äº‘ç›¸å…³
const showUploadDialog = ref(false)
const selectedUploadSong = ref(null)

// URLéªŒè¯ç›¸å…³
const coverValidation = ref({ valid: true, error: '', validating: false })
const playUrlValidation = ref({ valid: true, error: '', validating: false })

// ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•æ£€æŸ¥çŠ¶æ€
const checkingNeteaseLogin = ref(false)

const handleImportSuccess = async () => {
  // ä¸è‡ªåŠ¨å…³é—­å¼¹çª—ï¼Œç­‰å¾…ç”¨æˆ·åœ¨ç»“æœé¡µç‚¹å‡»å®Œæˆ
  // showImportSongsModal.value = false
  // åˆ·æ–°æ­Œæ›²åˆ—è¡¨ä»¥ä¾¿æ£€æŸ¥ç›¸ä¼¼æ­Œæ›²
  try {
    await songService.fetchSongs(true, currentSemester.value?.name, false, true)
  } catch (error) {
    console.error('åˆ·æ–°æ­Œæ›²åˆ—è¡¨å¤±è´¥:', error)
  }
}

const handleUserSelect = (users) => {
  if (Array.isArray(users)) {
    // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„
    const newUsers = users.filter((u) => !collaborators.value.some((c) => c.id === u.id))
    collaborators.value.push(...newUsers)
  } else if (users) {
    if (!collaborators.value.some((c) => c.id === users.id)) {
      collaborators.value.push(users)
    }
  }
}

const removeCollaborator = (userId) => {
  collaborators.value = collaborators.value.filter((c) => c.id !== userId)
}

// è·å–æ’­å‡ºæ—¶æ®µ
const fetchPlayTimes = async () => {
  loadingPlayTimes.value = true
  try {
    const response = await fetch('/api/play-times')
    if (response.ok) {
      const data = await response.json()
      playTimes.value = data.playTimes || []
      playTimeSelectionEnabled.value = data.enabled || false
    }
  } catch (err) {
    console.error('è·å–æ’­å‡ºæ—¶æ®µå¤±è´¥:', err)
  } finally {
    loadingPlayTimes.value = false
  }
}

const fileInput = ref(null)

const checkNeteaseLoginStatus = async () => {
  if (import.meta.client) {
    const cookie = localStorage.getItem('netease_cookie')
    // const userStr = localStorage.getItem('netease_user')
    if (cookie) {
      checkingNeteaseLogin.value = true
      try {
        const res = await getLoginStatus(cookie)
        const dataObj = res.body?.data || res.body
        if (dataObj && dataObj.account) {
          neteaseCookie.value = cookie
          isNeteaseLoggedIn.value = true
          neteaseUser.value = dataObj.profile || dataObj.account
          localStorage.setItem('netease_user', JSON.stringify(neteaseUser.value))
        } else {
          // ç™»å½•å¤±æ•ˆ
          handleLogoutNetease()
        }
      } catch (e) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥', e)
        // å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œæš‚æ—¶ä¿ç•™æœ¬åœ°çŠ¶æ€ï¼Œæˆ–è€…æ ¹æ®éœ€æ±‚æ¸…é™¤
        // è¿™é‡Œé€‰æ‹©ä¿å®ˆç­–ç•¥ï¼Œåªæœ‰æ˜ç¡®å¤±æ•ˆæ‰æ¸…é™¤ï¼Œé™¤éæ˜¯401ç­‰é”™è¯¯
        // ä½†é‰´äºç”¨æˆ·è¦æ±‚â€œå¤±æ•ˆäº†å°±æ¸…é™¤â€ï¼Œå¦‚æœAPIé€šäº†ä½†è¿”å›æ— æ•ˆåˆ™æ¸…é™¤ã€‚
        // å¦‚æœAPIä¸é€šï¼Œå¯èƒ½ä¸æ¸…é™¤ã€‚è¿™é‡Œå‡è®¾getLoginStatusè¿”å›æ­£å¸¸ç»“æ„ã€‚
      } finally {
        checkingNeteaseLogin.value = false
      }
    }
  }
}

const handleExportData = () => {
  if (!neteaseCookie.value) return
  const data = {
    cookie: neteaseCookie.value,
    user: neteaseUser.value,
    timestamp: Date.now()
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `netease_cookie_${Date.now()}.json`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  if (window.$showNotification) {
    window.$showNotification('å¯¼å‡ºæˆåŠŸ', 'success')
  }
}

const handleImportClick = () => {
  fileInput.value.click()
}

const handleImportData = async (event) => {
  const file = event.target.files[0]
  if (!file) return

  try {
    const text = await file.text()
    const data = JSON.parse(text)
    if (data.cookie) {
      checkingNeteaseLogin.value = true
      if (window.$showNotification) {
        window.$showNotification('æ­£åœ¨éªŒè¯Cookieæœ‰æ•ˆæ€§...', 'info')
      }

      const res = await getLoginStatus(data.cookie)
      const dataObj = res.body?.data || res.body
      if (dataObj && dataObj.account) {
        handleLoginSuccess({
          cookie: data.cookie,
          user: dataObj.profile || dataObj.account
        })
        if (window.$showNotification) {
          window.$showNotification('å¯¼å…¥æˆåŠŸ', 'success')
        }
      } else {
        if (window.$showNotification) {
          window.$showNotification('å¯¼å…¥çš„Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error')
        }
      }
    } else {
      if (window.$showNotification) {
        window.$showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error')
      }
    }
  } catch (e) {
    console.error('å¯¼å…¥å¤±è´¥', e)
    if (window.$showNotification) {
      window.$showNotification('å¯¼å…¥å¤±è´¥: ' + e.message, 'error')
    }
  } finally {
    checkingNeteaseLogin.value = false
  }
  // é‡ç½®input
  event.target.value = ''
}

const handleLoginSuccess = (data) => {
  neteaseCookie.value = data.cookie
  neteaseUser.value = data.user
  isNeteaseLoggedIn.value = true

  if (import.meta.client) {
    localStorage.setItem('netease_cookie', data.cookie)
    localStorage.setItem('netease_user', JSON.stringify(data.user))
  }
}

const handleLogoutNetease = () => {
  neteaseCookie.value = ''
  neteaseUser.value = null
  isNeteaseLoggedIn.value = false
  searchType.value = 1

  if (import.meta.client) {
    localStorage.removeItem('netease_cookie')
    localStorage.removeItem('netease_user')
  }
}

watch(
  () => searchType.value,
  () => {
    if (platform.value !== 'netease') return

    // è®°å½•å½“å‰çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æœç´¢
    // å¦‚æœå·²ç»æœ‰æœç´¢ç»“æœ(hasSearched)æˆ–æ­£åœ¨æœç´¢ä¸­(searching)ï¼Œä¸”æœ‰å…³é”®è¯ï¼Œåˆ™åº”è¯¥é‡æ–°æœç´¢
    const shouldResearch = title.value.trim() && (hasSearched.value || searching.value)

    // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æœç´¢è¯·æ±‚ï¼Œç«‹å³å–æ¶ˆ
    if (searchAbortController.value) {
      searchAbortController.value.abort()
      searchAbortController.value = null
      searching.value = false
    }

    // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„ç±»å‹ç»“æœ
    searchResults.value = []

    // è‡ªåŠ¨é‡æ–°æœç´¢
    if (shouldResearch) {
      handleSearch()
    }
  }
)

onMounted(async () => {
  checkNeteaseLoginStatus()
  fetchPlayTimes()
  initSiteConfig()
  fetchSubmissionStatus()
  // è·å–å½“å‰å­¦æœŸå’Œæ‰€æœ‰å­¦æœŸé€‰é¡¹
  await Promise.all([fetchCurrentSemester(), fetchSemesterOptions()])
  // åªæœ‰åœ¨ç”¨æˆ·å·²ç™»å½•æ—¶æ‰åŠ è½½æ­Œæ›²åˆ—è¡¨ä»¥ä¾¿æ£€æŸ¥ç›¸ä¼¼æ­Œæ›²
  if (auth.isAuthenticated.value) {
    try {
      const currentSemesterName = currentSemester.value?.name
      await songService.fetchSongs(false, currentSemesterName)
    } catch (error) {
      console.error('åŠ è½½æ­Œæ›²åˆ—è¡¨å¤±è´¥:', error)
    }
  }
  // éŸ³æºå¥åº·æ£€æŸ¥åŠŸèƒ½å·²ç§»é™¤
})

// è¿‡æ»¤å‡ºå¯ç”¨çš„æ’­å‡ºæ—¶æ®µ
const enabledPlayTimes = computed(() => {
  return playTimes.value.filter((pt) => pt.enabled)
})

const formattedPlayTimes = computed(() => {
  return enabledPlayTimes.value.map((pt) => ({
    ...pt,
    displayName: pt.startTime || pt.endTime ? `${pt.name} (${formatPlayTimeRange(pt)})` : pt.name
  }))
})

// æ ¼å¼åŒ–æ’­å‡ºæ—¶æ®µæ—¶é—´èŒƒå›´
const formatPlayTimeRange = (playTime) => {
  if (!playTime) return ''

  if (playTime.startTime && playTime.endTime) {
    return `${playTime.startTime} - ${playTime.endTime}`
  } else if (playTime.startTime) {
    return `${playTime.startTime} å¼€å§‹`
  } else if (playTime.endTime) {
    return `${playTime.endTime} ç»“æŸ`
  }

  return 'ä¸é™æ—¶é—´'
}

// ç›‘å¬æ­Œæ›²æœåŠ¡ä¸­çš„ç›¸ä¼¼æ­Œæ›²
watch(
  () => songService.similarSongFound.value,
  (newVal) => {
    // ä¿æŒå…¼å®¹æ€§ï¼Œå¦‚æœæœ‰ç›¸ä¼¼æ­Œæ›²ï¼Œå°†å…¶æ”¾å…¥æ•°ç»„
    if (newVal) {
      similarSongs.value = [newVal]
    } else {
      similarSongs.value = []
    }
  }
)

// ç›‘å¬ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼Œå½“ç”¨æˆ·ç™»å½•åé‡æ–°è·å–æŠ•ç¨¿çŠ¶æ€
watch(
  () => user.value,
  (newUser) => {
    if (newUser) {
      fetchSubmissionStatus()
    } else {
      submissionStatus.value = null
    }
  }
)

// æ£€æŸ¥ç›¸ä¼¼æ­Œæ›²
const checkSimilarSongs = async () => {
  if (title.value.trim().length > 2) {
    console.log('æ£€æŸ¥ç›¸ä¼¼æ­Œæ›²:', title.value, artist.value)
    const similar = await songService.checkSimilarSongs(title.value.trim(), artist.value.trim())
    console.log('ç›¸ä¼¼æ­Œæ›²ç»“æœ:', similar, songService.similarSongFound.value)
    similarSongs.value = similar
  } else {
    similarSongs.value = []
  }
}

// æŠ•ç¥¨æ”¯æŒç›¸ä¼¼æ­Œæ›²
const voteForSimilar = async (song) => {
  if (!song || song.voted) return

  voting.value = true
  try {
    // ç›´æ¥è°ƒç”¨songServiceçš„æŠ•ç¥¨æ–¹æ³•ï¼Œé¿å…é‡å¤å¤„ç†
    await songService.voteSong(song.id)

    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    song.voted = true
    song.voteCount = (song.voteCount || 0) + 1

    // æŠ•ç¥¨æˆåŠŸååˆ·æ–°æ­Œæ›²åˆ—è¡¨
    await songService.refreshSongsSilent().catch((err) => {
      console.error('åˆ·æ–°æ­Œæ›²åˆ—è¡¨å¤±è´¥', err)
    })

    // æ¸…é™¤è¡¨å•å¹¶éšè—æç¤º
    title.value = ''
    artist.value = ''
    similarSongs.value = []
  } catch (err) {
    error.value = err.message || 'æŠ•ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    if (window.$showNotification) {
      window.$showNotification(error.value, 'error')
    }
  } finally {
    voting.value = false
  }
}

// å¿½ç•¥ç›¸ä¼¼æ­Œæ›²ï¼Œç»§ç»­æŠ•ç¨¿
const ignoreSimilar = () => {
  similarSongs.value = []
}

// æ‰“å¼€ç›¸ä¼¼å‰§é›†è¯¦æƒ…å¼¹çª—
const openSimilarEpisodesModal = (group) => {
  if (!group || !group.episodes || group.episodes.length === 0) {
    if (window.$showNotification) {
      window.$showNotification('æ— æ³•æ‰“å¼€å‰§é›†åˆ—è¡¨', 'error')
    }
    return
  }

  // æ„é€ ä¸€ä¸ªç±»ä¼¼æœç´¢ç»“æœçš„å¯¹è±¡
  const videoData = {
    id: group.bvid,
    title: group.title,
    artist: group.artist,
    cover: group.cover,
    pages: [...group.episodes]
      // å…ˆæŒ‰ç…§ musicId ä¸­çš„åˆ†På·æ’åºï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
      .sort((a, b) => {
        // æå–é¡µç çš„è¾…åŠ©å‡½æ•°ï¼Œå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
        const getPageNumber = (musicId) => {
          if (!musicId) return 1
          const parts = musicId.split(':')
          if (parts.length > 2) {
            const page = parseInt(parts[2], 10)
            if (!isNaN(page)) return page
          }
          return 1 // å¦‚æœæ²¡æœ‰åˆ†é¡µä¿¡æ¯ï¼Œé»˜è®¤ä¸ºP1
        }
        return getPageNumber(a.musicId) - getPageNumber(b.musicId)
      })
      .map((episode, index) => {
        // ä» musicId ä¸­æå– cid å’Œ page
        const parts = episode.musicId ? episode.musicId.split(':') : []
        const cid = parts[1] || ''
        const page = parts[2] ? parseInt(parts[2]) : index + 1

        // ä»æ ‡é¢˜ä¸­æå–å‰§é›†åç§°
        const episodeTitle =
          episode.title && episode.title.includes(' - ')
            ? episode.title.split(' - ').slice(1).join(' - ')
            : episode.title || `ç¬¬${index + 1}é›†`

        return {
          cid,
          page,
          part: episodeTitle,
          duration: episode.duration || 0,
          // ç›´æ¥ä½¿ç”¨ episode çš„å®Œæ•´ä¿¡æ¯
          songId: episode.id,
          played: episode.played || false,
          scheduled: episode.scheduled || false,
          voted: episode.voted || false,
          voteCount: episode.voteCount || 0,
          requesterId: episode.requesterId
        }
      })
  }

  selectedBilibiliVideo.value = videoData
  bilibiliEpisodes.value = videoData.pages
  showBilibiliEpisodesModal.value = true
}

// å¤„ç†å‰§é›†æŠ•ç¥¨
const handleEpisodeVote = async (episode) => {
  if (!episode.songId) {
    if (window.$showNotification) {
      window.$showNotification('æ— æ³•æŠ•ç¥¨ï¼šç¼ºå°‘æ­Œæ›²ID', 'error')
    }
    return
  }

  if (episode.voted) {
    return
  }

  voting.value = true

  try {
    await songService.voteSong(episode.songId)

    // åªæœ‰åœ¨åç«¯æˆåŠŸè¿”å›åæ‰æ›´æ–°å‰ç«¯çŠ¶æ€
    episode.voted = true
    episode.voteCount = (episode.voteCount || 0) + 1

    // åˆ·æ–°æ­Œæ›²åˆ—è¡¨
    await songService.refreshSongsSilent().catch((err) => {
      console.error('åˆ·æ–°æ­Œæ›²åˆ—è¡¨å¤±è´¥', err)
    })
  } catch (err) {
    if (window.$showNotification) {
      window.$showNotification(err.message || 'ç‚¹èµå¤±è´¥', 'error')
    }
  } finally {
    voting.value = false
  }
}

// æ£€æŸ¥æœç´¢ç»“æœæ˜¯å¦å·²å­˜åœ¨å®Œå…¨åŒ¹é…çš„æ­Œæ›²
// æ ‡å‡†åŒ–å­—ç¬¦ä¸²ï¼ˆä¸useSongsä¸­çš„é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
const normalizeString = (str) => {
  return str
    .toLowerCase()
    .replace(/[\s\-_\(\)\[\]ã€ã€‘ï¼ˆï¼‰ã€Œã€ã€ã€ã€Šã€‹ã€ˆã€‰""''""''ã€ï¼Œã€‚ï¼ï¼Ÿï¼šï¼›ï½Â·]/g, '')
    .replace(/[&ï¼†]/g, 'and')
    .replace(/[feat\.?|ft\.?]/gi, '')
    .trim()
}

const getSimilarSong = (result) => {
  // å¤šPè§†é¢‘ä¸åœ¨è¿™é‡Œæ£€æŸ¥ç›¸ä¼¼æ€§ï¼Œä½¿ç”¨ä¸“é—¨çš„ getBilibiliEpisodeStatus
  if (isBilibiliMultiP(result)) {
    return null
  }

  const title = result.song || result.title
  const artist = result.singer || result.artist

  if (!title || !artist) return null

  const normalizedTitle = normalizeString(title)
  const normalizedArtist = normalizeString(artist)

  // è·å–å½“å‰å­¦æœŸåç§°
  const currentSemesterName = currentSemester.value?.name

  // æ£€æŸ¥å®Œå…¨åŒ¹é…çš„æ­Œæ›²ï¼ˆæ ‡å‡†åŒ–åï¼‰ï¼Œåªæ£€æŸ¥å½“å‰å­¦æœŸçš„æ­Œæ›²
  return songService.songs.value.find((song) => {
    const songTitle = normalizeString(song.title)
    const songArtist = normalizeString(song.artist)
    const titleMatch = songTitle === normalizedTitle && songArtist === normalizedArtist

    // å¦‚æœæœ‰å½“å‰å­¦æœŸä¿¡æ¯ï¼Œåªæ£€æŸ¥å½“å‰å­¦æœŸçš„æ­Œæ›²
    if (currentSemesterName) {
      return titleMatch && song.semester === currentSemesterName
    }

    // å¦‚æœæ²¡æœ‰å­¦æœŸä¿¡æ¯ï¼Œæ£€æŸ¥æ‰€æœ‰æ­Œæ›²ï¼ˆå‘åå…¼å®¹ï¼‰
    return titleMatch
  })
}

// ä»æœç´¢ç»“æœä¸­ç‚¹èµå·²å­˜åœ¨çš„æ­Œæ›²
const handleLikeFromSearch = async (song, originalResult = null) => {
  if (!song || song.voted) {
    return
  }

  if (song.played || song.scheduled) {
    if (window.$showNotification) {
      const message = song.played ? 'å·²æ’­æ”¾çš„æ­Œæ›²ä¸èƒ½ç‚¹èµ' : 'å·²æ’æœŸçš„æ­Œæ›²ä¸èƒ½ç‚¹èµ'
      window.$showNotification(message, 'warning')
    }
    return
  }

  // å¦‚æœåŸå§‹ç»“æœæ˜¯å¤šPè§†é¢‘ï¼Œæ‰“å¼€å‰§é›†é€‰æ‹©å¼¹çª—
  if (originalResult && isBilibiliMultiP(originalResult)) {
    selectedBilibiliVideo.value = originalResult
    bilibiliEpisodes.value = originalResult.pages
    showBilibiliEpisodesModal.value = true
    return
  }

  try {
    await songService.voteSong(song.id)
  } catch (error) {
    console.error('ç‚¹èµå¤±è´¥:', error)
  }
}

// å¹³å°åˆ‡æ¢å‡½æ•°
const switchPlatform = (newPlatform) => {
  if (platform.value === newPlatform) return

  // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æœç´¢è¯·æ±‚ï¼Œç«‹å³å–æ¶ˆ
  if (searchAbortController.value) {
    searchAbortController.value.abort()
    searchAbortController.value = null
    searching.value = false
  }

  platform.value = newPlatform

  // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„å¹³å°æ¥æº
  searchResults.value = []

  // å¦‚æœå·²ç»æœ‰æœç´¢ç»“æœï¼Œè‡ªåŠ¨é‡æ–°æœç´¢
  if (title.value.trim() && hasSearched.value) {
    handleSearch()
  }
}

// æœç´¢æ­Œæ›²
const handleSearch = async () => {
  error.value = ''
  success.value = ''
  searchError.value = ''

  if (!title.value.trim()) {
    error.value = 'æ­Œæ›²åç§°ä¸èƒ½ä¸ºç©º'
    if (window.$showNotification) {
      window.$showNotification('æ­Œæ›²åç§°ä¸èƒ½ä¸ºç©º', 'error')
    }
    return
  }

  // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æœç´¢è¯·æ±‚ï¼Œå…ˆå–æ¶ˆ
  if (searchAbortController.value) {
    searchAbortController.value.abort()
    searchAbortController.value = null
  }

  // åˆ›å»ºæ–°çš„AbortController
  searchAbortController.value = new AbortController()
  const signal = searchAbortController.value.signal

  // è®°å½•è¯·æ±‚æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œç”¨äºç»“æœæ ¡éªŒ
  const requestPlatform = platform.value
  const requestSearchType = searchType.value

  searching.value = true
  try {
    // ä½¿ç”¨å¤šéŸ³æºæœç´¢
    const searchParams = {
      keywords: title.value.trim(),
      platform: requestPlatform,
      limit: 20,
      signal: signal, // ä¼ é€’AbortSignal
      type: requestPlatform === 'netease' ? requestSearchType : 1,
      cookie: requestPlatform === 'netease' ? neteaseCookie.value : undefined
    }

    console.log('å¼€å§‹å¤šéŸ³æºæœç´¢:', searchParams)
    const results = await musicSources.searchSongs(searchParams)

    // å†æ¬¡æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
    if (signal.aborted) return

    // é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·å·²ç»åˆ‡æ¢äº†å¹³å°æˆ–ç±»å‹ï¼Œä¸¢å¼ƒç»“æœ
    if (platform.value !== requestPlatform) {
      console.log('å¹³å°å·²åˆ‡æ¢ï¼Œä¸¢å¼ƒæ—§ç»“æœ', requestPlatform, '->', platform.value)
      return
    }
    if (requestPlatform === 'netease' && searchType.value !== requestSearchType) {
      console.log('æœç´¢ç±»å‹å·²åˆ‡æ¢ï¼Œä¸¢å¼ƒæ—§ç»“æœ', requestSearchType, '->', searchType.value)
      return
    }

    if (results && results.success && results.data && results.data.length > 0) {
      // è½¬æ¢æœç´¢ç»“æœæ ¼å¼ä»¥å…¼å®¹ç°æœ‰UI
      searchResults.value = results.data.map((item) => ({
        ...item,
        musicId: item.id,
        hasUrl: false,
        // ç»Ÿä¸€å­—æ®µåç§°
        song: item.title || item.song,
        singer: item.artist || item.singer,
        // ä¿å­˜å®é™…çš„å¹³å°æ¥æºä¿¡æ¯
        actualSource: results.source,
        actualMusicPlatform:
          item.musicPlatform || (results.source === 'netease-backup' ? 'netease' : results.source)
      }))

      console.log('æœç´¢æˆåŠŸï¼Œæ‰¾åˆ°', results.data.length, 'é¦–æ­Œæ›²')
    } else {
      searchResults.value = []
      const errorMsg = results && results.error ? results.error : 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ­Œæ›²'
      error.value = errorMsg
      if (window.$showNotification) {
        window.$showNotification(errorMsg, 'info')
      }
    }
  } catch (err) {
    // å¦‚æœè¯·æ±‚è¢«å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    if (err.name === 'AbortError' || signal.aborted) {
      console.log('æœç´¢è¯·æ±‚å·²è¢«å–æ¶ˆ')
      return
    }

    console.error('æœç´¢é”™è¯¯:', err)
    searchError.value = err.message || 'æœç´¢è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    error.value = searchError.value

    if (window.$showNotification) {
      window.$showNotification(error.value, 'error')
    }
  } finally {
    // åªæœ‰åœ¨è¯·æ±‚æ²¡æœ‰è¢«å–æ¶ˆçš„æƒ…å†µä¸‹æ‰æ›´æ–°çŠ¶æ€
    if (!signal.aborted) {
      searching.value = false
      hasSearched.value = true
      // æ¸…ç†AbortController
      searchAbortController.value = null
    }
  }
}

// è·å–éŸ³ä¹æ’­æ”¾URL
const getAudioUrl = async (result) => {
  if (result.hasUrl || result.url) return result

  try {
    // æ ¹æ®æœç´¢ç»“æœçš„sourceInfo.sourceå­—æ®µåˆ¤æ–­éŸ³æºç±»å‹
    const sourceType = result.sourceInfo?.source || result.actualSource || ''

    // å“”å“©å“”å“©
    if (sourceType === 'bilibili' || result.musicPlatform === 'bilibili') {
      try {
        const songId = result.musicId || result.id
        if (!songId) throw new Error('ç¼ºå°‘æ­Œæ›²IDå‚æ•°')

        const options = result.bilibiliCid ? { bilibiliCid: String(result.bilibiliCid) } : undefined
        const urlResult = await musicSources.getSongUrl(songId, 0, 'bilibili', undefined, options)

        if (urlResult && urlResult.success && urlResult.url) {
          result.url = urlResult.url
          result.hasUrl = true
          return result
        }
      } catch (error) {
        console.error('Bilibiliè·å–æ’­æ”¾é“¾æ¥å¤±è´¥:', error)
      }
    }

    // å¯¹äº vkeys v3ï¼ˆQQéŸ³ä¹ï¼‰ï¼Œè°ƒç”¨ç»Ÿä¸€çš„ getSongUrl è·å–æ’­æ”¾é“¾æ¥
    if (sourceType === 'vkeys-v3') {
      try {
        const songId = result.musicId || result.id
        if (!songId) throw new Error('ç¼ºå°‘æ­Œæ›²IDå‚æ•°')

        const { getQuality } = useAudioQuality()
        const quality = getQuality(platform.value) || 8
        const urlResult = await musicSources.getSongUrl(songId, quality, 'tencent')

        if (urlResult && urlResult.success && urlResult.url) {
          result.url = urlResult.url
          result.hasUrl = true

          // æ›´æ–°æœç´¢ç»“æœä¸­çš„å¯¹åº”é¡¹
          const index = searchResults.value.findIndex(
            (item) => (item.musicId || item.id) === (result.musicId || result.id)
          )
          if (index !== -1) {
            searchResults.value[index] = { ...result }
          }
          return result
        } else {
          // vkeys v3 æœªè·å–åˆ°æœ‰æ•ˆé“¾æ¥ï¼Œç»§ç»­å›é€€é€»è¾‘
        }
      } catch (qqV3Error) {
        // vkeys v3 è·å–å¤±è´¥ï¼Œç»§ç»­å›é€€å…¶å®ƒé€»è¾‘
      }
    }

    // å¯¹äºvkeyséŸ³æºçš„å¤„ç†
    if (sourceType === 'vkeys') {
      if (result.url) {
        result.hasUrl = true
        return result
      } else {
        // æ ¹æ®å¹³å°ç›´æ¥å°è¯•å¯¹åº”çš„å¤‡ç”¨æº
        if (platform.value === 'tencent') {
          try {
            const songId = result.musicId || result.id
            if (!songId) throw new Error('ç¼ºå°‘æ­Œæ›²IDå‚æ•°')

            const { getQuality } = useAudioQuality()
            const quality = getQuality(platform.value) || 8
            const urlResult = await musicSources.getSongUrl(songId, quality, platform.value)

            if (urlResult && urlResult.success && urlResult.url) {
              result.url = urlResult.url
              result.hasUrl = true
              return result
            } else {
              // QQéŸ³ä¹ vkeys ç³»æ— æ³•è·å–URLï¼Œç»§ç»­å›é€€
            }
          } catch (qqError) {
            // QQéŸ³ä¹æ’­æ”¾é“¾æ¥è·å–å¤±è´¥ï¼Œç»§ç»­å›é€€
          }
        } else if (platform.value === 'netease') {
          try {
            const { getQuality } = useAudioQuality()
            const quality = getQuality(platform.value)
            const songDetail = await musicSources.getSongDetail({
              ids: [result.musicId || result.id],
              quality: quality
            })

            if (songDetail && songDetail.url) {
              result.url = songDetail.url
              result.hasUrl = true
              if (songDetail.cover) result.cover = songDetail.cover
              if (songDetail.duration) result.duration = songDetail.duration
              return result
            }
          } catch (error) {
            // vkeys getSongDetail å¤±è´¥ï¼Œç»§ç»­å›é€€
          }

          // å¦‚æœgetSongDetailå¤±è´¥ï¼Œå°è¯•ç½‘æ˜“äº‘å¤‡ç”¨æº
          try {
            const { getQuality } = useAudioQuality()
            const quality = getQuality(platform.value)
            const songId = result.musicId || result.id

            const urlResult = await musicSources.getSongUrl(songId, quality, platform.value)

            if (urlResult && urlResult.success && urlResult.url) {
              result.url = urlResult.url
              result.hasUrl = true
              return result
            } else {
              // å¤‡ç”¨æºä¹Ÿæ— æ³•è·å–URL
            }
          } catch (backupError) {
            // å¤‡ç”¨æºè·å–å¤±è´¥
          }
        }
      }
    }

    // å¯¹äºç½‘æ˜“äº‘å¤‡ç”¨æºï¼Œç›´æ¥è°ƒç”¨getSongUrlè·å–æ’­æ”¾é“¾æ¥
    if (sourceType === 'netease-backup') {
      const targetPlatform = 'netease'
      const { getQuality } = useAudioQuality()
      const quality = getQuality(targetPlatform)
      const songId = result.musicId || result.id

      // æ£€æŸ¥æ˜¯å¦ä¸ºæ’­å®¢å†…å®¹
      const isPodcast = result.sourceInfo?.type === 'voice' || searchType.value === 1009

      try {
        const urlResult = await musicSources.getSongUrl(
          songId,
          quality,
          targetPlatform,
          neteaseCookie.value,
          { unblock: !isPodcast } // æ’­å®¢å†…å®¹ unblock=falseï¼Œæ™®é€šæ­Œæ›² unblock=true
        )

        if (urlResult && urlResult.success && urlResult.url) {
          // æ›´æ–°ç»“æœä¸­çš„URLå’Œå…¶ä»–ä¿¡æ¯
          result.url = urlResult.url
          result.hasUrl = true

          // æ›´æ–°æœç´¢ç»“æœä¸­çš„å¯¹åº”é¡¹
          const index = searchResults.value.findIndex(
            (item) => (item.musicId || item.id) === (result.musicId || result.id)
          )
          if (index !== -1) {
            searchResults.value[index] = { ...result }
          }
        } else {
          // æœªèƒ½è·å–åˆ°æœ‰æ•ˆçš„æ­Œæ›²URL
        }
      } catch (urlError) {
        // è°ƒç”¨ getSongUrl å¤±è´¥
      }
    }

    return result
  } catch (err) {
    error.value = 'è·å–éŸ³ä¹URLå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    if (window.$showNotification) {
      window.$showNotification('è·å–éŸ³ä¹URLå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error')
    }
    return result
  }
}

// æ’­æ”¾æ­Œæ›²
const playSong = async (result) => {
  // å¦‚æœè¿˜æ²¡æœ‰è·å–URLï¼Œå…ˆè·å–
  if (!result.hasUrl && !result.url) {
    result = await getAudioUrl(result)
  }

  // å¯¹äºéå“”å“©å“”å“©å¹³å°ï¼Œå¦‚æœæ²¡æœ‰URLåˆ™æç¤ºé”™è¯¯
  if (!result.url && result.musicPlatform !== 'bilibili') {
    error.value = 'è¯¥æ­Œæ›²æ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯ä»˜è´¹å†…å®¹'
    if (window.$showNotification) {
      window.$showNotification('è¯¥æ­Œæ›²æ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯ä»˜è´¹å†…å®¹', 'error')
    }
    return
  }

  let finalMusicId = result.musicId ? String(result.musicId) : null
  if (result.musicPlatform === 'bilibili' && result.bilibiliCid) {
    finalMusicId = `${result.musicId}:${result.bilibiliCid}`
    // å¦‚æœæœ‰åˆ†Pä¿¡æ¯ï¼Œä¹Ÿæ·»åŠ åˆ° musicId
    if (result.bilibiliPage || result.page) {
      const page = result.bilibiliPage || result.page
      if (Number(page) > 1) {
        finalMusicId += `:${page}`
      }
    }
  }

  // å‡†å¤‡æ’­æ”¾æ‰€éœ€çš„æ•°æ®
  const song = {
    id: finalMusicId || result.musicId || Date.now(),
    title: result.song || result.title,
    artist: result.singer || result.artist,
    cover: result.cover || null,
    musicUrl: result.url || null, // å“”å“©å“”å“©å¯èƒ½æ²¡æœ‰éŸ³é¢‘URL
    musicPlatform: result.musicPlatform || platform.value,
    musicId: finalMusicId,
    bilibiliCid: result.bilibiliCid // ç¡®ä¿ä¼ é€’ cid
  }

  console.log('[RequestForm] å‡†å¤‡æ’­æ”¾æ­Œæ›²:', song)

  // ä½¿ç”¨å…¨å±€æ’­æ”¾å™¨æ’­æ”¾æ­Œæ›²
  const playResult = audioPlayer.playSong(song)

  if (!playResult) {
    console.error('[RequestForm] æ’­æ”¾å™¨è¿”å› falseï¼Œæ’­æ”¾å¤±è´¥')
    if (window.$showNotification) {
      window.$showNotification('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error')
    }
    return
  }

  console.log('[RequestForm] æ’­æ”¾å™¨å·²å¯åŠ¨')

  // å¦‚æœæœ‰éŸ³ä¹å¹³å°ä¿¡æ¯ï¼Œè¯·æ±‚æ­Œè¯
  if (song.musicPlatform && song.musicId) {
    try {
      const { useLyrics } = await import('~/composables/useLyrics')
      const lyrics = useLyrics()
      // è¯·æ±‚æ­Œè¯ï¼ˆå¯¹äºbilibiliï¼Œä¼ é€’åŸå§‹çš„bvidï¼Œä¸åŒ…å«cidï¼‰
      const lyricMusicId = result.bilibiliCid ? result.musicId : song.musicId
      await lyrics.fetchLyrics(song.musicPlatform, lyricMusicId)
    } catch (error) {
      console.error('è·å–æ­Œè¯å¤±è´¥:', error)
      // æ­Œè¯è·å–å¤±è´¥ä¸å½±å“æ’­æ”¾
    }
  }
}

// é€‰æ‹©æœç´¢ç»“æœ
const selectResult = async (result) => {
  // é˜²æ­¢é‡å¤ç‚¹å‡»å’Œäº‹ä»¶å†’æ³¡
  event?.stopPropagation()

  // å…ˆè·å–å®Œæ•´ä¿¡æ¯
  if (!result.hasUrl) {
    result = await getAudioUrl(result)
  }

  // æ ‡å‡†åŒ–å±æ€§åç§°ï¼ˆå¤„ç†ä¸åŒAPIè¿”å›æ ¼å¼çš„å·®å¼‚ï¼‰
  const songTitle = result.song || result.title
  const singerName = result.singer || result.artist

  title.value = songTitle
  artist.value = singerName
  selectedCover.value = result.cover || ''
  selectedUrl.value = result.url || ''

  // å¦‚æœæ²¡æœ‰URLï¼Œç»™å‡ºæç¤º
  if (!result.url) {
    success.value = 'å·²é€‰æ‹©æ­Œæ›²ï¼Œä½†å¯èƒ½æ— æ³•æ’­æ”¾å®Œæ•´ç‰ˆæœ¬'
    if (window.$showNotification) {
      window.$showNotification('å·²é€‰æ‹©æ­Œæ›²ï¼Œä½†å¯èƒ½æ— æ³•æ’­æ”¾å®Œæ•´ç‰ˆæœ¬', 'info')
    }
  }

  console.log('å·²é€‰æ‹©æ­Œæ›²:', songTitle, '- å¡«å……è¡¨å•ä½†ä¸è‡ªåŠ¨æäº¤')
}

// æ‰“å¼€ä¸Šä¼ åˆ°ç½‘æ˜“äº‘å¯¹è¯æ¡†
const openUploadDialog = (result) => {
  console.log('QQéŸ³ä¹æœç´¢ç»“æœ - å®Œæ•´å¯¹è±¡:', result)
  console.log('QQéŸ³ä¹æœç´¢ç»“æœ - æ‰€æœ‰é”®:', Object.keys(result))

  // è½¬æ¢QQéŸ³ä¹æœç´¢ç»“æœä¸ºä¸Šä¼ å¯¹è¯æ¡†éœ€è¦çš„æ ¼å¼
  // ç›´æ¥ä¼ é€’æ•´ä¸ª result å¯¹è±¡ï¼Œè®©ä¸Šä¼ å¯¹è¯æ¡†è‡ªå·±æå–éœ€è¦çš„å­—æ®µ
  selectedUploadSong.value = result

  console.log('å‡†å¤‡ä¸Šä¼ çš„æ­Œæ›²æ•°æ®:', selectedUploadSong.value)
  showUploadDialog.value = true
}

// æ˜¾ç¤ºç™»å½•å¼¹çª—
const handleShowLogin = () => {
  showUploadDialog.value = false
  showLoginModal.value = true
}

// æäº¤é€‰ä¸­çš„æ­Œæ›²
const submitSong = async (result, options = {}) => {
  // é˜²æ­¢é‡å¤ç‚¹å‡»å’Œé‡å¤æäº¤
  if (submitting.value) return

  // å¦‚æœæ˜¯æ’­å®¢/ç”µå°æ¨¡å¼ï¼Œä¸”æ˜¯åœ¨ç½‘æ˜“äº‘å¹³å°ä¸‹ï¼Œä¸”ä¸æ˜¯å…·ä½“çš„å•é›†æäº¤
  if (
    platform.value === 'netease' &&
    searchType.value === 1009 &&
    !options.isPodcastEpisode &&
    !options.isDirectSubmit
  ) {
    console.log('æ‰“å¼€æ’­å®¢èŠ‚ç›®åˆ—è¡¨:', result)
    // æ‰“å¼€æ’­å®¢èŠ‚ç›®åˆ—è¡¨å¼¹çª—
    selectedPodcastId.value = result.id || result.musicId
    selectedPodcastName.value = result.title || result.song || result.name
    podcastCookie.value = neteaseCookie.value
    showPodcastModal.value = true
    return
  }

  // å¦‚æœæ˜¯ Bilibili å¹³å°ï¼Œä¸”æœ‰å¤šä¸ªå‰§é›†ï¼Œä¸”ä¸æ˜¯å…·ä½“çš„å‰§é›†æäº¤
  if (
    platform.value === 'bilibili' &&
    result.pages &&
    result.pages.length > 1 &&
    !options.isBilibiliEpisode
  ) {
    console.log('æ‰“å¼€ Bilibili å‰§é›†åˆ—è¡¨:', result)
    selectedBilibiliVideo.value = result
    bilibiliEpisodes.value = result.pages
    showBilibiliEpisodesModal.value = true
    return
  }

  console.log('æ‰§è¡ŒsubmitSongï¼Œæäº¤æ­Œæ›²:', result.title || result.song)

  // æ£€æŸ¥æŠ•ç¨¿é™é¢
  const limitCheck = checkSubmissionLimit()
  if (!limitCheck.canSubmit) {
    error.value = limitCheck.message
    if (window.$showNotification) {
      window.$showNotification(limitCheck.message, 'error')
    }
    return
  }

  // ä½¿ç”¨æœç´¢ç»“æœä¸­çš„æ•°æ®
  const songTitle = result.song || result.title
  const songArtist = result.singer || result.artist

  // åªæœ‰åœ¨ç”¨æˆ·å·²ç™»å½•ä¸”æ­Œæ›²åˆ—è¡¨å·²åŠ è½½æ—¶æ‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å®Œå…¨åŒ¹é…çš„æ­Œæ›²
  if (auth.isAuthenticated.value && songService.songs.value && songService.songs.value.length > 0) {
    // å¯¹äºå“”å“©å“”å“©å¤šPè§†é¢‘ï¼Œä½¿ç”¨ musicId è¿›è¡Œç²¾ç¡®åŒ¹é…
    if (platform.value === 'bilibili' && result.musicId) {
      // æ„å»ºå®Œæ•´çš„ musicId
      let fullMusicId = String(result.musicId)
      if (options.isBilibiliEpisode && options.episode) {
        const bvId = fullMusicId.split(':')[0]
        const musicIdParts = [bvId, options.episode.cid]
        if (options.episode.page && Number(options.episode.page) > 1) {
          musicIdParts.push(String(options.episode.page))
        }
        fullMusicId = musicIdParts.join(':')
      }

      // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒ musicId çš„æ­Œæ›²
      const existingSong = songService.songs.value.find(
        (song) => song.musicPlatform === 'bilibili' && song.musicId === fullMusicId
      )

      if (existingSong) {
        const allowOverride =
          options.forceResubmit === true || (isSuperAdmin.value && existingSong.played)
        if (!allowOverride) {
          if (window.$showNotification) {
            window.$showNotification(
              'è¿™é¦–æ­Œæ›²å·²ç»åœ¨åˆ—è¡¨ä¸­äº†ï¼Œä¸èƒ½é‡å¤æŠ•ç¨¿ã€‚æ‚¨å¯ä»¥ä¸ºå®ƒç‚¹èµæ”¯æŒï¼',
              'warning'
            )
          }
          return
        }
      }
    } else {
      // å¯¹äºå…¶ä»–å¹³å°ï¼Œä½¿ç”¨æ ‡é¢˜å’Œè‰ºæœ¯å®¶è¿›è¡ŒåŒ¹é…
      const existingSong = songService.songs.value.find(
        (song) =>
          song.title.toLowerCase() === songTitle.toLowerCase() &&
          song.artist.toLowerCase() === songArtist.toLowerCase()
      )

      if (existingSong) {
        const allowOverride =
          options.forceResubmit === true || (isSuperAdmin.value && existingSong.played)
        if (!allowOverride) {
          if (window.$showNotification) {
            window.$showNotification(
              'è¿™é¦–æ­Œæ›²å·²ç»åœ¨åˆ—è¡¨ä¸­äº†ï¼Œä¸èƒ½é‡å¤æŠ•ç¨¿ã€‚æ‚¨å¯ä»¥ä¸ºå®ƒç‚¹èµæ”¯æŒï¼',
              'warning'
            )
          }
          return
        }
      }
    }
  }

  submitting.value = true
  error.value = ''

  title.value = songTitle
  artist.value = songArtist
  selectedCover.value = result.cover || ''
  selectedUrl.value = result.url || result.file || ''

  try {
    // æ£€æŸ¥é»‘åå•
    const blacklistCheck = await $fetch('/api/blacklist/check', {
      method: 'POST',
      body: {
        title: title.value,
        artist: artist.value
      }
    })

    if (blacklistCheck.isBlocked) {
      const reasons = blacklistCheck.reasons.map((r) => r.reason).join('; ')
      error.value = `è¯¥æ­Œæ›²æ— æ³•ç‚¹æ­Œ: ${reasons}`
      if (window.$showNotification) {
        window.$showNotification(error.value, 'error')
      }
      submitting.value = false
      return
    }
  } catch (err) {
    console.error('é»‘åå•æ£€æŸ¥å¤±è´¥:', err)
    // é»‘åå•æ£€æŸ¥å¤±è´¥ä¸é˜»æ­¢æäº¤ï¼Œåªè®°å½•é”™è¯¯
  }

  // ç¡®ä¿è·å–å®Œæ•´çš„URL
  if (!selectedUrl.value && result.musicId) {
    const fullResult = await getAudioUrl(result)
    selectedUrl.value = fullResult.url || ''
  }

  // å¤„ç† Bilibili åˆ† P ä¿¡æ¯
  let bilibiliCid = result.bilibiliCid
  let bilibiliPage = result.bilibiliPage || null

  if (options.isBilibiliEpisode && options.episode) {
    bilibiliCid = options.episode.cid
    bilibiliPage = options.episode.page
    // è¿½åŠ åˆ†Pæ ‡é¢˜
    if (options.episode.part && !title.value.includes(options.episode.part)) {
      title.value += ` - ${options.episode.part}`
    }
  }

  try {
    // æ„å»ºæ­Œæ›²æ•°æ®å¯¹è±¡
    const songData = {
      title: title.value,
      artist: artist.value,
      preferredPlayTimeId: preferredPlayTimeId.value ? parseInt(preferredPlayTimeId.value) : null,
      cover: selectedCover.value,
      musicPlatform: result.actualMusicPlatform || result.musicPlatform || platform.value, // ä¼˜å…ˆä½¿ç”¨æœç´¢ç»“æœçš„å®é™…å¹³å°æ¥æº
      musicId: result.musicId ? String(result.musicId) : null,
      collaborators: collaborators.value.map((u) => u.id),
      bilibiliCid: bilibiliCid || null,
      bilibiliPage: bilibiliPage
    }

    // åªemitäº‹ä»¶ï¼Œè®©çˆ¶ç»„ä»¶å¤„ç†å®é™…çš„APIè°ƒç”¨
    emit('request', songData)

    // æˆåŠŸæç¤ºç”±çˆ¶ç»„ä»¶å¤„ç†ï¼Œè¿™é‡Œåªé‡ç½®è¡¨å•
    resetForm()
    return true
  } catch (err) {
    error.value = err.message || 'æŠ•ç¨¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    if (window.$showNotification) {
      window.$showNotification(error.value, 'error')
    }
    return false
  } finally {
    submitting.value = false
  }
}

// ç›´æ¥æäº¤è¡¨å•
const handleSubmit = async () => {
  if (submitting.value) return

  // æ£€æŸ¥æŠ•ç¨¿é™é¢
  const limitCheck = checkSubmissionLimit()
  if (!limitCheck.canSubmit) {
    error.value = limitCheck.message
    if (window.$showNotification) {
      window.$showNotification(limitCheck.message, 'error')
    }
    return
  }

  submitting.value = true
  error.value = ''

  try {
    // æ„å»ºæ­Œæ›²æ•°æ®å¯¹è±¡
    const songData = {
      title: title.value,
      artist: artist.value,
      preferredPlayTimeId: preferredPlayTimeId.value ? parseInt(preferredPlayTimeId.value) : null,
      cover: selectedCover.value,
      musicPlatform: platform.value,
      musicId: null, // æ‰‹åŠ¨è¾“å…¥æ—¶æ²¡æœ‰musicId
      collaborators: collaborators.value.map((u) => u.id)
    }

    // åªemitäº‹ä»¶ï¼Œè®©çˆ¶ç»„ä»¶å¤„ç†å®é™…çš„APIè°ƒç”¨
    emit('request', songData)

    // æˆåŠŸæç¤ºç”±çˆ¶ç»„ä»¶å¤„ç†ï¼Œè¿™é‡Œåªé‡ç½®è¡¨å•
    resetForm()
  } catch (err) {
    error.value = err.message || 'æŠ•ç¨¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    if (window.$showNotification) {
      window.$showNotification(error.value, 'error')
    }
  } finally {
    submitting.value = false
  }
}

const isBilibiliMultiP = (result) => {
  return result && platform.value === 'bilibili' && result.pages && result.pages.length > 1
}

const getBilibiliEpisodeStatus = (result) => {
  if (!result || !isBilibiliMultiP(result)) return null

  const currentSemesterName = currentSemester.value?.name
  const bvid = result.id

  const submittedEpisodes = songService.songs.value.filter((song) => {
    if (song.musicPlatform !== 'bilibili') return false
    if (!song.musicId) return false

    const songBvid = song.musicId.includes(':') ? song.musicId.split(':')[0] : song.musicId

    const isSameBvid = songBvid === bvid

    if (currentSemesterName) {
      return isSameBvid && song.semester === currentSemesterName
    }

    return isSameBvid
  })

  const totalEpisodes = result.pages.length
  const submittedCount = submittedEpisodes.length

  return {
    submittedEpisodes,
    submittedCount,
    totalEpisodes,
    allSubmitted: submittedCount === totalEpisodes,
    partialSubmitted: submittedCount > 0 && submittedCount < totalEpisodes,
    noneSubmitted: submittedCount === 0
  }
}

const formatDuration = (seconds) => {
  const minutes = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${minutes}:${secs.toString().padStart(2, '0')}`
}

const handleBilibiliEpisodeSelect = async (episode) => {
  if (!selectedBilibiliVideo.value) return

  const episodeResult = {
    ...selectedBilibiliVideo.value,
    title: `${selectedBilibiliVideo.value.title} - ${episode.part}`,
    bilibiliCid: episode.cid,
    duration: episode.duration
  }

  const success = await submitSong(episodeResult, {
    isBilibiliEpisode: true,
    episode: episode
  })

  if (success) {
    showBilibiliEpisodesModal.value = false
    if (bilibiliModalRef.value && bilibiliModalRef.value.resetSubmissionState) {
      bilibiliModalRef.value.resetSubmissionState()
    }
  } else {
    if (bilibiliModalRef.value && bilibiliModalRef.value.resetSubmissionState) {
      bilibiliModalRef.value.resetSubmissionState()
    }
  }
}

const handleBilibiliEpisodePlay = async (episodeData) => {
  const bvid = episodeData.bvid || episodeData.id
  const episodeResult = {
    id: bvid,
    title: `${episodeData.title} - ${episodeData.part}`,
    artist: episodeData.artist,
    cover: episodeData.cover || '',
    musicId: bvid,
    musicPlatform: 'bilibili',
    bilibiliCid: episodeData.cid,
    duration: episodeData.duration,
    sourceInfo: { source: 'bilibili' }
  }
  await playSong(episodeResult)
}

// å¼•ç”¨æ¨¡æ€æ¡†ç»„ä»¶
const bilibiliModalRef = ref(null)
const podcastModalRef = ref(null)
const recentSongsModalRef = ref(null)
const playlistModalRef = ref(null)

// å¤„ç†æ’­å®¢å•é›†æäº¤
const handlePodcastSubmit = async (song) => {
  const success = await submitSong(song, { isPodcastEpisode: true })
  if (success) {
    showPodcastModal.value = false
  } else {
    // å¦‚æœå¤±è´¥ï¼Œé‡ç½®æ¨¡æ€æ¡†å†…çš„æäº¤çŠ¶æ€
    if (podcastModalRef.value && podcastModalRef.value.resetSubmissionState) {
      podcastModalRef.value.resetSubmissionState()
    }
  }
}

// å¤„ç†æ’­å®¢å•é›†æ’­æ”¾
const handlePodcastPlay = async (song) => {
  console.log('æ’­æ”¾æ’­å®¢å•é›†:', song.title)
  await playSong(song)
}

// å¤„ç†æœ€è¿‘æ’­æ”¾æ­Œæ›²æäº¤
const handleRecentSongSubmit = async (song) => {
  const success = await submitSong(song, { isPodcastEpisode: false, isDirectSubmit: true })
  if (success) {
    showRecentSongsModal.value = false
  } else {
    // å¦‚æœå¤±è´¥ï¼Œé‡ç½®æ¨¡æ€æ¡†å†…çš„æäº¤çŠ¶æ€
    if (recentSongsModalRef.value && recentSongsModalRef.value.resetSubmissionState) {
      recentSongsModalRef.value.resetSubmissionState()
    }
  }
}

// å¤„ç†æœ€è¿‘æ’­æ”¾æ­Œæ›²æ’­æ”¾
const handleRecentSongPlay = async (song) => {
  await playSong(song)
}

// å¤„ç†æ­Œå•æ­Œæ›²æäº¤
const handlePlaylistSubmit = async (song) => {
  const success = await submitSong(song, { isPodcastEpisode: false, isDirectSubmit: true })
  if (success) {
    showPlaylistModal.value = false
  } else {
    // å¦‚æœå¤±è´¥ï¼Œé‡ç½®æ¨¡æ€æ¡†å†…çš„æäº¤çŠ¶æ€
    if (playlistModalRef.value && playlistModalRef.value.resetSubmissionState) {
      playlistModalRef.value.resetSubmissionState()
    }
  }
}

// å¤„ç†æ­Œå•æ­Œæ›²æ’­æ”¾
const handlePlaylistPlay = async (song) => {
  await playSong(song)
}

// æ‰‹åŠ¨è¾“å…¥ç›¸å…³æ–¹æ³•
const handleManualSubmit = async () => {
  if (!title.value.trim() || !manualArtist.value.trim()) {
    error.value = 'è¯·è¾“å…¥å®Œæ•´çš„æ­Œæ›²ä¿¡æ¯'
    if (window.$showNotification) {
      window.$showNotification('è¯·è¾“å…¥å®Œæ•´çš„æ­Œæ›²ä¿¡æ¯', 'error')
    }
    return
  }

  // éªŒè¯URL
  if (manualCover.value && !coverValidation.value.valid) {
    error.value = 'è¯·ä¿®æ­£å°é¢URLé”™è¯¯åå†æäº¤'
    if (window.$showNotification) {
      window.$showNotification('è¯·ä¿®æ­£å°é¢URLé”™è¯¯åå†æäº¤', 'error')
    }
    return
  }

  if (manualPlayUrl.value && !playUrlValidation.value.valid) {
    error.value = 'è¯·ä¿®æ­£æ’­æ”¾åœ°å€URLé”™è¯¯åå†æäº¤'
    if (window.$showNotification) {
      window.$showNotification('è¯·ä¿®æ­£æ’­æ”¾åœ°å€URLé”™è¯¯åå†æäº¤', 'error')
    }
    return
  }

  // æ£€æŸ¥æŠ•ç¨¿é™é¢
  const limitCheck = checkSubmissionLimit()
  if (!limitCheck.canSubmit) {
    error.value = limitCheck.message
    if (window.$showNotification) {
      window.$showNotification(limitCheck.message, 'error')
    }
    return
  }

  submitting.value = true
  error.value = ''

  try {
    // æ£€æŸ¥é»‘åå•
    const blacklistCheck = await $fetch('/api/blacklist/check', {
      method: 'POST',
      body: {
        title: title.value,
        artist: manualArtist.value
      }
    })

    if (blacklistCheck.isBlocked) {
      const reasons = blacklistCheck.reasons.map((r) => r.reason).join('; ')
      error.value = `è¯¥æ­Œæ›²æ— æ³•ç‚¹æ­Œ: ${reasons}`
      if (window.$showNotification) {
        window.$showNotification(error.value, 'error')
      }
      submitting.value = false
      return
    }
    // æ„å»ºæ­Œæ›²æ•°æ®å¯¹è±¡
    const songData = {
      title: title.value,
      artist: manualArtist.value,
      preferredPlayTimeId: preferredPlayTimeId.value ? parseInt(preferredPlayTimeId.value) : null,
      cover: manualCover.value || '',
      playUrl: manualPlayUrl.value || '',
      musicPlatform: platform.value,
      musicId: null // æ‰‹åŠ¨è¾“å…¥æ—¶æ²¡æœ‰musicId
    }

    // åªemitäº‹ä»¶ï¼Œè®©çˆ¶ç»„ä»¶å¤„ç†å®é™…çš„APIè°ƒç”¨
    emit('request', songData)

    // æˆåŠŸæç¤ºç”±çˆ¶ç»„ä»¶å¤„ç†ï¼Œè¿™é‡Œåªé‡ç½®è¡¨å•å’Œå…³é—­å¼¹çª—
    resetForm()
    showManualModal.value = false
  } catch (err) {
    error.value = err.message || 'æŠ•ç¨¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    if (window.$showNotification) {
      window.$showNotification(error.value, 'error')
    }
  } finally {
    submitting.value = false
  }
}

// ç”³è¯·é‡æ’­
const handleRequestReplay = async (song) => {
  if (requestingReplay.value || !song) return

  // å¦‚æœå·²ç»ç”³è¯·è¿‡ï¼Œä¸æ‰§è¡Œ
  if (song.replayRequested) {
    if (window.$showNotification) {
      window.$showNotification('è¯¥æ­Œæ›²å·²ç”³è¯·è¿‡é‡æ’­', 'info')
    }
    return
  }

  requestingReplay.value = true
  try {
    await songService.requestReplay(song.id)
    // åˆ·æ–°æ­Œæ›²çŠ¶æ€
    setTimeout(() => {
      songService.refreshSongsSilent().catch(console.error)
    }, 500)
    if (window.$showNotification) {
      window.$showNotification('ç”³è¯·é‡æ’­æˆåŠŸ', 'success')
    }
  } catch (err) {
    console.error('ç”³è¯·é‡æ’­å¤±è´¥:', err)
    if (window.$showNotification) {
      window.$showNotification('ç”³è¯·é‡æ’­å¤±è´¥: ' + err.message, 'error')
    }
  } finally {
    requestingReplay.value = false
  }
}

// è·å–é‡æ’­æŒ‰é’®æ–‡æœ¬
const getReplayButtonText = (song) => {
  if (requestingReplay.value) return 'ç”³è¯·ä¸­...'
  if (!song) return 'ç”³è¯·é‡æ’­'

  // æ£€æŸ¥å­¦æœŸ
  if (currentSemester.value && song.semester !== currentSemester.value.name) {
    return 'éæœ¬å­¦æœŸ'
  }

  // æ£€æŸ¥é‡æ’­ç”³è¯·çŠ¶æ€
  if (song.replayRequestStatus === 'REJECTED') {
    // å¦‚æœåœ¨å†·å´æœŸå†…
    if (song.replayRequestCooldownRemaining && song.replayRequestCooldownRemaining > 0) {
      return `å·²æ‹’ç»ï¼ˆ${song.replayRequestCooldownRemaining}å°æ—¶åå¯é‡æ–°ç”³è¯·ï¼‰`
    }
    // å†·å´æœŸå·²è¿‡
    return 'ç”³è¯·é‡æ’­'
  }

  if (song.replayRequestStatus === 'FULFILLED') {
    return 'å·²é‡æ’­'
  }

  if (song.replayRequested || song.replayRequestStatus === 'PENDING') {
    return 'å·²ç”³è¯·é‡æ’­'
  }

  return 'ç”³è¯·é‡æ’­'
}

// è·å–é‡æ’­æŒ‰é’®æ ‡é¢˜ï¼ˆtooltipï¼‰
const getReplayButtonTitle = (song) => {
  if (!song) return 'ç”³è¯·é‡æ’­'

  // æ£€æŸ¥å­¦æœŸ
  if (currentSemester.value && song.semester !== currentSemester.value.name) {
    return 'åªèƒ½ç”³è¯·é‡æ’­å½“å‰å­¦æœŸçš„æ­Œæ›²'
  }

  // æ£€æŸ¥é‡æ’­ç”³è¯·çŠ¶æ€
  if (song.replayRequestStatus === 'REJECTED') {
    if (song.replayRequestCooldownRemaining && song.replayRequestCooldownRemaining > 0) {
      return `ç”³è¯·è¢«æ‹’ç»ï¼Œéœ€è¦ç­‰å¾… ${song.replayRequestCooldownRemaining} å°æ—¶åæ‰èƒ½é‡æ–°ç”³è¯·`
    }
    return 'ç”³è¯·é‡æ’­'
  }

  if (song.replayRequestStatus === 'FULFILLED') {
    return 'è¯¥æ­Œæ›²å·²é‡æ’­'
  }

  if (song.replayRequested || song.replayRequestStatus === 'PENDING') {
    return 'è¯¥æ­Œæ›²å·²ç”³è¯·è¿‡é‡æ’­'
  }

  return 'ç”³è¯·é‡æ’­'
}

// æ£€æŸ¥é‡æ’­æŒ‰é’®æ˜¯å¦åº”è¯¥ç¦ç”¨
const isReplayButtonDisabled = (song) => {
  if (requestingReplay.value || !song) return true

  // æ£€æŸ¥å­¦æœŸ
  if (currentSemester.value && song.semester !== currentSemester.value.name) {
    return true
  }

  // æ£€æŸ¥é‡æ’­ç”³è¯·çŠ¶æ€
  if (song.replayRequestStatus === 'REJECTED') {
    // å¦‚æœåœ¨å†·å´æœŸå†…ï¼Œç¦ç”¨æŒ‰é’®
    if (song.replayRequestCooldownRemaining && song.replayRequestCooldownRemaining > 0) {
      return true
    }
    // å†·å´æœŸå·²è¿‡ï¼Œå…è®¸é‡æ–°ç”³è¯·
    return false
  }

  if (song.replayRequestStatus === 'FULFILLED') {
    return true
  }

  if (song.replayRequested || song.replayRequestStatus === 'PENDING') {
    return true
  }

  return false
}

// é‡ç½®è¡¨å•
const resetForm = () => {
  title.value = ''
  artist.value = ''
  preferredPlayTimeId.value = ''
  similarSongs.value = []
  searchResults.value = []
  selectedCover.value = ''
  selectedUrl.value = ''
  showManualModal.value = false
  manualArtist.value = ''
  manualCover.value = ''
  manualPlayUrl.value = ''
  hasSearched.value = false
  collaborators.value = []
  // é‡ç½®URLéªŒè¯çŠ¶æ€
  coverValidation.value = { valid: true, error: '', validating: false }
  playUrlValidation.value = { valid: true, error: '', validating: false }
}

// åœæ­¢æ’­æ”¾
const stopPlaying = () => {
  audioPlayer.stopSong()
}

// è·å–æŠ•ç¨¿çŠ¶æ€
const fetchSubmissionStatus = async () => {
  if (!user.value) return

  loadingSubmissionStatus.value = true

  try {
    const authConfig = auth.getAuthConfig()
    const response = await $fetch('/api/songs/submission-status', authConfig)
    submissionStatus.value = response
  } catch (err) {
    console.error('è·å–æŠ•ç¨¿çŠ¶æ€å¤±è´¥:', err)
  } finally {
    loadingSubmissionStatus.value = false
  }
}

// æ£€æŸ¥æŠ•ç¨¿é™é¢
const checkSubmissionLimit = () => {
  // è¶…çº§ç®¡ç†å‘˜ä¸å—æŠ•ç¨¿é™åˆ¶
  if (user.value && (user.value.role === 'SUPER_ADMIN' || user.value.role === 'ADMIN')) {
    return { canSubmit: true, message: '' }
  }

  if (!submissionStatus.value || !submissionStatus.value.limitEnabled) {
    return { canSubmit: true, message: '' }
  }

  // æ£€æŸ¥æŠ•ç¨¿æ˜¯å¦å·²å…³é—­
  if (submissionStatus.value.submissionClosed) {
    let message = 'æŠ•ç¨¿åŠŸèƒ½å·²å…³é—­'
    if (submissionStatus.value.timeLimitationEnabled && !submissionStatus.value.currentTimePeriod) {
      message = 'å½“å‰ä¸åœ¨æŠ•ç¨¿å¼€æ”¾æ—¶æ®µ'
    }
    return {
      canSubmit: false,
      message: message
    }
  }

  // æ£€æŸ¥æŠ•ç¨¿æ—¶æ®µåé¢é™åˆ¶
  if (submissionStatus.value.timeLimitationEnabled && submissionStatus.value.currentTimePeriod) {
    const { expected, accepted } = submissionStatus.value.currentTimePeriod
    if (expected > 0 && accepted >= expected) {
      return {
        canSubmit: false,
        message: `å½“å‰æ—¶æ®µæŠ•ç¨¿åé¢å·²æ»¡ (${accepted}/${expected})`
      }
    }
  }

  const { dailyLimit, weeklyLimit, dailyUsed, weeklyUsed } = submissionStatus.value

  // æ£€æŸ¥æ—¥é™é¢
  if (dailyLimit && dailyUsed >= dailyLimit) {
    return {
      canSubmit: false,
      message: `ä»Šæ—¥æŠ•ç¨¿å·²è¾¾ä¸Šé™ (${dailyUsed}/${dailyLimit})`
    }
  }

  // æ£€æŸ¥å‘¨é™é¢
  if (weeklyLimit && weeklyUsed >= weeklyLimit) {
    return {
      canSubmit: false,
      message: `æœ¬å‘¨æŠ•ç¨¿å·²è¾¾ä¸Šé™ (${weeklyUsed}/${weeklyLimit})`
    }
  }

  return { canSubmit: true, message: '' }
}

// URLéªŒè¯å‡½æ•°
const validateCoverUrl = async (url) => {
  if (!url) {
    coverValidation.value = { valid: true, error: '', validating: false }
    return
  }

  coverValidation.value.validating = true
  const result = validateUrl(url)
  coverValidation.value = {
    valid: result.valid,
    error: result.error || '',
    validating: false
  }
}

const validatePlayUrl = async (url) => {
  if (!url) {
    playUrlValidation.value = { valid: true, error: '', validating: false }
    return
  }

  playUrlValidation.value.validating = true
  const result = validateUrl(url)
  playUrlValidation.value = {
    valid: result.valid,
    error: result.error || '',
    validating: false
  }
}

// ç›‘å¬URLå˜åŒ–å¹¶éªŒè¯
watch(manualCover, (newUrl) => {
  if (newUrl) {
    // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹éªŒè¯
    clearTimeout(coverValidation.value.debounceTimer)
    coverValidation.value.debounceTimer = setTimeout(() => {
      validateCoverUrl(newUrl)
    }, 1000)
  } else {
    coverValidation.value = { valid: true, error: '', validating: false }
  }
})

watch(manualPlayUrl, (newUrl) => {
  if (newUrl) {
    // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹éªŒè¯
    clearTimeout(playUrlValidation.value.debounceTimer)
    playUrlValidation.value.debounceTimer = setTimeout(() => {
      validatePlayUrl(newUrl)
    }, 1000)
  } else {
    playUrlValidation.value = { valid: true, error: '', validating: false }
  }
})

// è®¡ç®—å±æ€§ï¼šæ£€æŸ¥æ‰‹åŠ¨è¡¨å•æ˜¯å¦å¯ä»¥æäº¤
const canSubmitManualForm = computed(() => {
  // å¿…å¡«å­—æ®µæ£€æŸ¥
  if (!manualArtist.value.trim()) {
    return false
  }

  // å¯é€‰å­—æ®µéªŒè¯æ£€æŸ¥
  // å¦‚æœè¾“å…¥äº†å°é¢URLï¼Œå¿…é¡»éªŒè¯é€šè¿‡ä¸”ä¸åœ¨éªŒè¯ä¸­
  if (manualCover.value && (!coverValidation.value.valid || coverValidation.value.validating)) {
    return false
  }

  // å¦‚æœè¾“å…¥äº†æ’­æ”¾URLï¼Œå¿…é¡»éªŒè¯é€šè¿‡ä¸”ä¸åœ¨éªŒè¯ä¸­
  if (
    manualPlayUrl.value &&
    (!playUrlValidation.value.valid || playUrlValidation.value.validating)
  ) {
    return false
  }

  return true
})

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  refreshSubmissionStatus: fetchSubmissionStatus
})
</script>

<style scoped>
.request-form {
  width: 100%;
  color: #ffffff;
  display: flex;
  gap: 2rem;
  height: calc(100vh - 160px);
  max-height: calc(100vh - 160px);
  overflow: hidden;
}

/* æ¡Œé¢ç«¯æ ·å¼ */
.desktop-only-rules {
  display: block;
}

.mobile-only-rules {
  display: none;
}

.rules-section {
  background: rgba(0, 0, 0, 0.4);
  border-radius: 13px;
  padding: 1.25rem;
  flex: 0 0 35%; /* ç¨å¾®ç¼©å°è§„åˆ™åŒºåŸŸå æ¯” */
  min-width: 300px;
  height: 100%;
  overflow-y: auto;
}

.section-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 400;
  font-size: 15px;
  letter-spacing: 0.04em;
  color: rgba(255, 255, 255, 0.6);
  margin-bottom: 0.75rem;
}

.rules-content-desktop {
  font-family: 'MiSans', sans-serif;
  font-weight: 400;
  font-size: 15px;
  line-height: 1.7;
  letter-spacing: 0.04em;
  color: #fff;
}

.rules-content-desktop p {
  margin-bottom: 0.6rem;
}

/* ç§»åŠ¨ç«¯æ ·å¼ */
.rules-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 15px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 1.25rem;
}

.rules-icon {
  color: #f59e0b;
}

.rules-content {
  font-family: 'MiSans', sans-serif;
  font-size: 13px;
  line-height: 1.8;
  color: rgba(255, 255, 255, 0.5);
}

.rule-item {
  display: flex;
  margin-bottom: 0.75rem;
}

.rule-item span {
  margin-right: 0.5rem;
  color: rgba(255, 255, 255, 0.3);
  font-weight: 600;
}

.form-container {
  flex: 1;
  min-width: 0;
  height: 100%;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.song-request-form {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  gap: 1rem;
  position: relative;
}

/* æœç´¢åŒºåŸŸæ ·å¼ */
.form-header-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 0.75rem;
  padding-top: 4px; /* ä¸ºæŒ‰é’®æ‚¬åœä¸Šæµ®ç•™å‡ºç©ºé—´ */
  flex-wrap: wrap; /* å…è®¸åœ¨çª„å±ä¸‹æ¢è¡Œ */
}

.search-section {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1.5;
  min-width: 400px; /* å¢åŠ æœ€å°å®½åº¦ï¼Œç¡®ä¿æœç´¢æ¡†ã€æ ‡ç­¾å’ŒæŒ‰é’®æœ‰è¶³å¤Ÿç©ºé—´ */
}

.search-label {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 15px;
  color: #ffffff;
  white-space: nowrap;
  flex-shrink: 0; /* é˜²æ­¢æ ‡ç­¾è¢«å‹ç¼© */
}

.search-input-group {
  display: flex;
  gap: 0.5rem;
  flex: 1;
  min-width: 0; /* å…è®¸å†…éƒ¨å…ƒç´ æ­£å¸¸å‹ç¼© */
}

.search-input {
  background: #040e15;
  border: 1px solid #242f38;
  border-radius: 8px;
  padding: 0.6rem 0.85rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 15px;
  color: rgba(255, 255, 255, 0.6);
  flex: 1;
  min-width: 100px; /* ç¡®ä¿è¾“å…¥æ¡†ä¸ä¼šç¼©åˆ°å¤ªå° */
}

.search-input:focus {
  outline: none;
  border-color: #0b5afe;
}

.search-button {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.3s ease;
  flex-shrink: 0; /* ç¡®ä¿æœç´¢æŒ‰é’®å§‹ç»ˆå®Œæ•´æ˜¾ç¤ºï¼Œä¸è¢«é‡å  */
}

.search-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 67, 248, 0.3);
}

.search-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* è”åˆæŠ•ç¨¿äººåŒºåŸŸ */
.collaborators-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
  min-width: 200px; /* å¢åŠ æœ€å°å®½åº¦ï¼Œé˜²æ­¢åœ¨çª„å±ä¸‹ä¸æœç´¢æ¡†é‡å  */
}

.section-label {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 16px;
  color: #ffffff;
  white-space: nowrap;
  flex-shrink: 0; /* é˜²æ­¢æ ‡ç­¾è¢«å‹ç¼© */
}

.collaborators-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}

.collaborator-tag {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: rgba(11, 90, 254, 0.1);
  border: 1px solid rgba(11, 90, 254, 0.2);
  border-radius: 6px;
  padding: 0.25rem 0.5rem;
  font-size: 14px;
  color: #fff;
}

.remove-collaborator {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.6);
  cursor: pointer;
  display: flex;
  align-items: center;
  padding: 0;
}

.remove-collaborator:hover {
  color: #fff;
}

.add-collaborator-btn {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  padding: 0.25rem 0.75rem;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: all 0.2s;
}

.add-collaborator-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
}

/* æ¨ªå‘æŠ•ç¨¿çŠ¶æ€æ ·å¼ */
.submission-status-horizontal {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.75rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.admin-notice-horizontal {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  justify-content: center;
}

.admin-notice-horizontal .admin-icon {
  font-size: 14px;
}

.admin-notice-horizontal .admin-text {
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 13px;
  color: #ffd700;
}

.submission-closed-notice {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  justify-content: center;
}

.submission-closed-notice .closed-icon {
  font-size: 14px;
}

.submission-closed-notice .closed-text {
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 13px;
  color: #ff6b6b;
}

.status-content-horizontal {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

.status-item-horizontal {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.status-item-horizontal .status-label {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 13px;
  color: #ffffff;
}

.status-item-horizontal .status-value {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 13px;
  color: #0b5afe;
}

.status-item-horizontal .status-remaining {
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  background: rgba(11, 90, 254, 0.1);
  border: 1px solid rgba(11, 90, 254, 0.3);
  border-radius: 4px;
  padding: 0.15rem 0.4rem;
}

.form-row {
  display: flex;
  gap: 1rem;
  width: 100%;
}

.form-row .form-group {
  flex: 1;
  min-width: 0;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
  position: relative;
  z-index: 10;
}

.form-group label {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 15px;
  letter-spacing: 0.02em;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 0.25rem;
}

.input-wrapper {
  width: 100%;
}

.form-input,
.form-select {
  background: #040e15;
  border: 1px solid #242f38;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 16px;
  color: rgba(255, 255, 255, 0.6);
  width: 100%;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: #0b5afe;
}

/* å¹³å°é€‰æ‹©æŒ‰é’®æ ·å¼ */
.platform-selection-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-shrink: 0;
}

.platform-selection {
  display: flex;
  gap: 1rem;
  align-items: flex-start;
}

/* ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•é€‰é¡¹ */
.netease-options {
  position: relative;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 12px;
  padding: 0.4rem 0.75rem; /* ç¨å¾®ç¼©å°å†…è¾¹è· */
  border: 1px solid rgba(255, 255, 255, 0.08);
  display: flex;
  flex-direction: column;
  gap: 0.4rem; /* ç¼©å°é—´è· */
  overflow: hidden;
  transition: all 0.3s ease;
}

.netease-options:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.12);
}

.netease-options::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #ef4444, #f87171, #ef4444);
  opacity: 0.6;
}

.netease-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.netease-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}

.netease-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #c20c0c;
  box-shadow: 0 0 8px rgba(194, 12, 12, 0.6);
}

.netease-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 13px;
  color: #ffffff;
}

.login-entry {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  background: rgba(255, 255, 255, 0.02);
  padding: 0.6rem 0.85rem;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.06);
  transition: all 0.3s ease;
}

.login-entry:hover {
  background: rgba(255, 255, 255, 0.04);
  border-color: rgba(255, 255, 255, 0.1);
}

.login-desc {
  flex: 1;
  min-width: 0;
}

.login-title {
  font-size: 13px;
  font-weight: 600;
  color: #ffffff;
  margin: 0;
  letter-spacing: 0.02em;
}

.login-hint {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.45);
  margin: 2px 0 0 0;
  line-height: 1.3;
}

.login-btn {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
  border: none;
  padding: 0.45rem 0.85rem;
  border-radius: 7px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  white-space: nowrap;
  box-shadow: 0 4px 10px rgba(59, 130, 246, 0.15);
}

.login-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 14px rgba(59, 130, 246, 0.25);
  filter: brightness(1.1);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.header-btn {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.5);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.header-btn:hover {
  color: #ffffff;
  background: rgba(255, 255, 255, 0.08);
}

.login-actions {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.import-btn {
  background: rgba(255, 255, 255, 0.04);
  color: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 0.45rem 0.75rem;
  border-radius: 7px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.import-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.15);
  color: #ffffff;
}

.user-status {
  display: flex;
  flex-direction: column;
}

.user-compact-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  min-width: 0;
}

.user-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1.5px solid rgba(255, 255, 255, 0.1);
}

.user-name {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-actions-row {
  display: flex;
  gap: 0.4rem;
}

.action-btn-compact {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.06);
  color: rgba(255, 255, 255, 0.7);
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
  white-space: nowrap;
}

.action-btn-compact:hover {
  background: rgba(255, 255, 255, 0.08);
  color: #ffffff;
  border-color: rgba(255, 255, 255, 0.12);
}

.search-type-switch {
  display: flex;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  padding: 2px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.radio-label {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.4);
  cursor: pointer;
  padding: 0.15rem 0.5rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.radio-label.active {
  color: #ffffff;
  font-weight: 600;
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.radio-label input {
  display: none;
}

.logout-btn {
  display: flex;
  align-items: center;
  gap: 0.2rem;
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.4);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.logout-btn:hover {
  color: rgba(255, 255, 255, 0.7);
  background: rgba(255, 255, 255, 0.05);
}

.platform-btn {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  padding: 0.45rem 0.85rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.platform-btn.active {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border-color: rgba(255, 255, 255, 0.16);
  color: #ffffff;
}

.platform-btn:hover:not(.active) {
  background: rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.8);
}

/* éŸ³æºçŠ¶æ€æ˜¾ç¤º */
.source-status-display {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  backdrop-filter: blur(10px);
}

.status-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.status-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  font-family: 'MiSans', sans-serif;
}

.status-summary {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
  padding: 0.25rem 0.5rem;
  border-radius: 6px;
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
}

.status-sources {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.source-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  font-size: 12px;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
}

.source-item.healthy {
  background: rgba(34, 197, 94, 0.15);
  border-color: rgba(34, 197, 94, 0.3);
  color: #4ade80;
}

.source-item.unhealthy {
  background: rgba(239, 68, 68, 0.15);
  border-color: rgba(239, 68, 68, 0.3);
  color: #f87171;
}

.source-item.checking {
  background: rgba(251, 191, 36, 0.15);
  border-color: rgba(251, 191, 36, 0.3);
  color: #fbbf24;
}

.source-item.current {
  box-shadow: 0 0 0 2px rgba(11, 90, 254, 0.4);
  transform: scale(1.02);
}

.source-name {
  font-weight: 600;
}

.source-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.source-item.healthy .source-indicator {
  background: #22c55e;
  box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
}

.source-item.unhealthy .source-indicator {
  background: #ef4444;
  box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
}

.source-item.checking .source-indicator {
  background: #fbbf24;
  box-shadow: 0 0 6px rgba(251, 191, 36, 0.6);
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.error-message {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-top: 0.75rem;
  padding: 0.5rem 0.75rem;
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 6px;
  color: #f87171;
  font-size: 12px;
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
}

/* æœç´¢ç»“æœå®¹å™¨æ ·å¼ */
.search-results-container {
  flex: 1;
  background: rgba(0, 0, 0, 0.4);
  border-radius: 13px;
  display: flex;
  flex-direction: column;
  min-height: 0;
  padding: 0.75rem 1.25rem 1.25rem 1.25rem; /* ç¨å¾®ç¼©å°å†…è¾¹è· */
  position: relative;
  z-index: 1;
}

.results-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* åŠ è½½çŠ¶æ€ */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 1rem;
  min-height: 200px; /* æ·»åŠ æœ€å°é«˜åº¦ */
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(11, 90, 254, 0.2);
  border-top-color: #0b5afe;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-text {
  color: rgba(255, 255, 255, 0.6);
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  margin: 0;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* æœç´¢ç»“æœåˆ—è¡¨ */
.results-list {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.results-grid {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding-right: 0.5rem;
  min-height: 0;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
.results-grid::-webkit-scrollbar {
  width: 6px;
}

.results-grid::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}

.results-grid::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 3px;
}

.results-grid::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

/* ç©ºçŠ¶æ€å’Œåˆå§‹çŠ¶æ€ */
.empty-state,
.initial-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  text-align: center;
  gap: 0.75rem;
  padding: 1.5rem;
  min-height: 200px; /* å¢åŠ æœ€å°é«˜åº¦ */
}

.empty-icon,
.initial-icon {
  font-size: 2.5rem;
  margin-bottom: 0.25rem;
}

.empty-text,
.initial-text {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 15px;
  color: #ffffff;
  margin: 0;
}

.empty-hint,
.initial-hint {
  color: rgba(255, 255, 255, 0.6);
  font-size: 13px;
  margin: 0;
}

/* æœç´¢æ’å›¾æ ·å¼ */
.search-illustration {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  min-height: 120px;
}

.search-svg {
  width: 25%;
  max-width: 300px;
  min-width: 150px;
  height: auto;
  object-fit: contain;
  opacity: 0.8;
}

/* æ‰‹åŠ¨è¾“å…¥è§¦å‘æŒ‰é’® */
.manual-input-trigger {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  text-align: center;
}

.manual-submit-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1.5rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.manual-submit-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

.form-notice {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  letter-spacing: 0.04em;
  color: rgba(255, 255, 255, 0.4);
  margin-top: 0.5rem;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 1rem;
}

.submit-button {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1.5rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.submit-button:hover {
  transform: translateY(-2px);
}

.submit-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
.similar-song-alert {
  background: #21242d;
  border-radius: 10px;
  padding: 0.75rem 1rem;
  box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
  margin-top: 0.75rem;
  flex-shrink: 0;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.alert-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.alert-header-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.alert-icon {
  color: #f59e0b;
  flex-shrink: 0;
}

.alert-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 16px;
  color: #ffffff;
}

.alert-content {
  margin-bottom: 1rem;
}

.similar-songs-list {
  margin-bottom: 0.5rem;
  max-height: 120px;
  overflow-y: auto;
}

.similar-song-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.4rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.similar-song-item:last-child {
  border-bottom: none;
}

.song-info {
  flex: 1;
  min-width: 0;
}

.song-title {
  margin: 0 0 0.25rem 0;
  font-size: 14px;
  color: #ffffff;
  font-weight: 500;
}

.song-actions {
  margin-left: 1rem;
  flex-shrink: 0;
}

.vote-btn.small,
.replay-btn.small {
  padding: 0.3rem 0.6rem;
  font-size: 12px;
}

/* æ­Œæ›²çŠ¶æ€æ ·å¼ */
.song-status {
  display: inline-block;
  font-size: 12px;
  font-weight: 600;
  margin-left: 0.5rem;
}

.status-played {
  color: #ef4444;
}

.status-scheduled {
  color: #f59e0b;
}

.alert-hint {
  color: rgba(255, 255, 255, 0.6);
  font-size: 14px;
  margin-top: 0.5rem;
}

.voted-status {
  color: #10b981;
  font-size: 14px;
  font-weight: 600;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.alert-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

.vote-btn {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.vote-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 67, 248, 0.3);
}

.vote-btn:disabled {
  background: rgba(255, 255, 255, 0.2);
  cursor: not-allowed;
  transform: none;
}

.ignore-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
}

/* æ¡Œé¢ç«¯ç»§ç»­æŠ•ç¨¿æŒ‰é’® */
.desktop-continue-btn {
  display: none;
}

/* ç§»åŠ¨ç«¯ç»§ç»­æŠ•ç¨¿æŒ‰é’® */
.mobile-continue-actions {
  display: block;
}

.mobile-continue-btn {
  display: block;
}

/* å®½å±æ—¶çš„æ ·å¼ */
@media (min-width: 768px) {
  .desktop-continue-btn {
    display: inline-flex;
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 6px;
  }

  .mobile-continue-actions {
    display: none;
  }

  .similar-songs-list {
    max-height: 80px;
  }
}

/* ç§»åŠ¨ç«¯æ—¶å¢åŠ ç›¸ä¼¼æ­Œæ›²åˆ—è¡¨é«˜åº¦ */
@media (max-width: 767px) {
  .similar-songs-list {
    max-height: 150px;
  }
}

/* åŠ¨ç”»æ ·å¼ */
.results-fade-enter-active,
.results-fade-leave-active {
  transition: all 0.3s ease;
}

.results-fade-enter-from,
.results-fade-leave-to {
  opacity: 0;
  transform: translateY(20px);
}

.result-item-enter-active {
  transition: all 0.4s ease;
}

.result-item-leave-active {
  transition: all 0.3s ease;
}

.result-item-enter-from {
  opacity: 0;
  transform: translateX(-20px);
}

.result-item-leave-to {
  opacity: 0;
  transform: translateX(20px);
}

.result-item-move {
  transition: transform 0.3s ease;
}

/* å¼¹çª—æ ·å¼ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  transition: all 0.3s ease;
}

.modal-content {
  background: rgba(20, 20, 25, 0.95);
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.1);
  transform-origin: center;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  background: rgba(255, 255, 255, 0.02);
}

.modal-header h3 {
  margin: 0;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 18px;
  letter-spacing: 0.02em;
}

.close-btn {
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.4);
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  transform: rotate(90deg);
}

.modal-body {
  padding: 1.5rem;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
}

.btn {
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid transparent;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn:active {
  transform: scale(0.96);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.8);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  border-color: rgba(255, 255, 255, 0.2);
}

.btn-primary {
  background: linear-gradient(135deg, #0043f8 0%, #0075f8 100%);
  border-color: rgba(255, 255, 255, 0.1);
  color: #ffffff;
  box-shadow: 0 4px 12px rgba(0, 67, 248, 0.3);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 67, 248, 0.4);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  box-shadow: none;
}

.readonly {
  background: rgba(0, 0, 0, 0.2) !important;
  color: rgba(255, 255, 255, 0.5) !important;
  cursor: not-allowed;
  border-color: transparent !important;
}

/* å¼¹çª—åŠ¨ç”» */
.modal-animation-enter-active,
.modal-animation-leave-active {
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal-animation-enter-from,
.modal-animation-leave-to {
  opacity: 0;
}

.modal-animation-enter-from .modal-content,
.modal-animation-leave-to .modal-content {
  transform: scale(0.95) translateY(10px);
  opacity: 0;
}

.result-item {
  display: flex;
  padding: 0.6rem 1rem; /* ç¼©å°å†…è¾¹è·ä»¥æé«˜ä¿¡æ¯å¯†åº¦ */
  gap: 1rem;
  transition: all 0.2s ease;
  cursor: pointer;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.result-item:last-child {
  border-bottom: none;
}

.result-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.result-cover {
  width: 70px;
  height: 70px;
  position: relative;
  flex-shrink: 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  background: #18181b;
}

.cover-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.result-item:hover .cover-img {
  transform: scale(1.1);
}

.play-overlay-container {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 2;
}

.result-item:hover .play-overlay-container {
  opacity: 1;
}

.play-button-wrapper {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
}

.play-icon {
  fill: currentColor;
  margin-left: 2px;
}

.result-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.result-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 15px;
  color: #ffffff;
  margin: 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
}

.result-artist {
  color: rgba(255, 255, 255, 0.6);
  font-size: 13px;
  margin: 0.25rem 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.result-album,
.result-quality,
.result-pay {
  color: rgba(255, 255, 255, 0.4);
  font-size: 11px;
  margin: 0.15rem 0;
}

.result-actions {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: row;
  gap: 0.8rem;
  margin-right: 0.25rem;
  flex-shrink: 0;
}

.cloud-disk-btn {
  background: linear-gradient(180deg, #ec4141 0%, #d83030 100%);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  padding: 0;
  margin: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  -webkit-appearance: none;
  appearance: none;
}

.cloud-disk-btn:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 12px rgba(236, 65, 65, 0.5);
  background: linear-gradient(180deg, #d83030 0%, #c52020 100%);
  border-color: rgba(255, 255, 255, 0.4);
}

.cloud-disk-btn:active {
  transform: translateY(0) scale(0.95);
  box-shadow: 0 2px 4px rgba(236, 65, 65, 0.3);
}

.similar-song-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  text-align: center;
}

.similar-text {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
}

.similar-text.status-played {
  color: #ef4444;
  font-weight: 600;
}

.similar-text.status-scheduled {
  color: #f59e0b;
  font-weight: 600;
}

.like-btn {
  background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 6px;
  padding: 0.4rem 0.8rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.3rem;
  transition: all 0.2s ease;
}

.like-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}

.like-btn:disabled {
  background: rgba(255, 255, 255, 0.2);
  cursor: not-allowed;
  transform: none;
}

.like-btn.disabled {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  cursor: not-allowed;
  opacity: 0.5;
}

.like-btn svg {
  width: 14px;
  height: 14px;
  fill: currentColor;
}

.select-btn {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
}

.replay-btn {
  background: rgba(0, 117, 248, 0.1);
  border: 1px solid rgba(0, 117, 248, 0.3);
  border-radius: 6px;
  padding: 0.4rem 0.8rem;
  color: #3b82f6;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.replay-btn:hover:not(:disabled) {
  background: rgba(0, 117, 248, 0.2);
  border-color: rgba(0, 117, 248, 0.5);
  color: #60a5fa;
  transform: translateY(-1px);
}

.replay-btn:disabled {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.3);
  cursor: not-allowed;
  transform: none;
}

/* éŸ³é¢‘æ’­æ”¾å™¨ç°åœ¨ä½¿ç”¨å…¨å±€ç»„ä»¶ */

/* æ‰‹åŠ¨æäº¤æŒ‰é’®æ ·å¼ */
.no-results-action {
  margin-top: 1rem;
  text-align: center;
  padding: 1rem 0;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.manual-submit-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1.5rem;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.manual-submit-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

/* æ‰‹åŠ¨è¾“å…¥åŒºåŸŸæ ·å¼ */
.manual-input-section {
  margin-top: 2rem;
  background: rgba(0, 0, 0, 0.4);
  border-radius: 13px;
  padding: 1.5rem;
}

.manual-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 18px;
  margin-bottom: 1rem;
  color: #ffffff;
}

.manual-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.manual-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.manual-cancel-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.manual-cancel-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.manual-confirm-btn {
  background: linear-gradient(180deg, #0043f8 0%, #0075f8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  color: #ffffff;
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.manual-confirm-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 67, 248, 0.3);
}

.manual-confirm-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
  /* Netease Options Mobile Optimization */
  .netease-options {
    padding: 0.75rem;
  }

  .user-compact-row {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
  }

  .user-profile {
    width: 100%;
    justify-content: flex-start;
  }

  .search-type-switch {
    width: 100%;
    display: flex;
  }

  .radio-label {
    flex: 1;
    text-align: center;
  }

  .user-actions-row {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    width: 100%;
  }

  /* ç§»åŠ¨ç«¯ä¸‹è®©æŒ‰é’®å¹³åˆ†å®½åº¦ */
  .user-actions-row .action-btn-compact {
    flex: 1;
    width: auto;
    justify-content: center;
    padding: 0.6rem 0.4rem;
  }

  /* ç§»åŠ¨ç«¯æ˜¾ç¤º/éšè—æ§åˆ¶ */
  .desktop-only-rules {
    display: none;
  }

  .mobile-only-rules {
    display: block;
  }

  .request-form {
    flex-direction: column;
    height: auto;
    max-height: none;
    overflow: visible;
    padding: 0; /* ç§»é™¤å¯èƒ½çš„å†…è¾¹è· */
  }

  .rules-section {
    width: 100%;
    height: auto;
    margin-bottom: 1.5rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.04);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px;
  }

  .rules-title {
    font-size: 15px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 1.25rem;
    letter-spacing: normal;
  }

  .rules-icon {
    display: block;
    color: #f59e0b;
  }

  .form-container {
    width: 100%;
    flex: none; /* æ”¹ä¸ºä¸å ç”¨flexç©ºé—´ï¼Œè®©å†…å®¹è‡ªç„¶æ’‘å¼€ */
    display: flex;
    flex-direction: column;
    height: auto;
    overflow-x: hidden; /* é˜²æ­¢æ¨ªå‘æº¢å‡º */
    max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡çˆ¶å®¹å™¨å®½åº¦ */
  }

  .song-request-form {
    flex: none; /* æ”¹ä¸ºä¸å ç”¨flexç©ºé—´ï¼Œè®©å†…å®¹è‡ªç„¶æ’‘å¼€ */
    display: flex;
    flex-direction: column;
    height: auto;
    gap: 1.25rem;
    max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡çˆ¶å®¹å™¨å®½åº¦ */
  }

  .form-header-row {
    flex-direction: column;
    gap: 1rem;
    width: 100%; /* ç¡®ä¿å æ»¡å®½åº¦ */
    max-width: 100%; /* é˜²æ­¢è¶…å‡º */
  }

  .search-results-container {
    flex: none; /* æ”¹ä¸ºä¸å ç”¨flexç©ºé—´ï¼Œè®©å†…å®¹è‡ªç„¶æ’‘å¼€ */
    height: auto;
    max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
    padding: 0.75rem;
    overflow: visible;
    display: flex;
    flex-direction: column;
    margin-bottom: 2rem;
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    /* å…è®¸å®¹å™¨å†…å®¹è§¦å‘é¡µé¢æ»šåŠ¨ */
    touch-action: pan-y;
  }

  .results-content {
    height: auto;
    min-height: 200px; /* å‡å°æœ€å°é«˜åº¦ */
    max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
    overflow: visible;
    flex: none; /* æ”¹ä¸ºä¸å ç”¨flexç©ºé—´ */
  }

  /* ç§»åŠ¨ç«¯æœç´¢åŒºåŸŸ */
  .form-header-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 0;
    margin-bottom: 0;
  }

  .login-entry {
    flex-direction: column;
    align-items: stretch;
    padding: 0.85rem;
    gap: 0.6rem;
  }

  .login-desc {
    width: 100%;
  }

  .login-title {
    /* ä¸ç¼©å°å­—å· */
  }

  .login-hint {
    white-space: normal;
    word-break: break-word;
    line-height: 1.3;
  }

  .login-actions {
    width: 100%;
    justify-content: flex-start;
    gap: 0.5rem;
  }

  .login-btn,
  .import-btn {
    flex: 1;
    justify-content: center;
    padding: 0.5rem 0.4rem;
  }

  .search-section {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    flex: none;
    width: 100%;
    min-width: unset; /* ç§»é™¤æ¡Œé¢ç«¯çš„æœ€å°å®½åº¦é™åˆ¶ */
  }

  .collaborators-section {
    flex-direction: row;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex: none;
    width: 100%;
    flex-wrap: wrap;
  }

  .section-label {
    font-size: 14px;
  }

  .search-label {
    font-size: 14px;
  }

  .search-input-group {
    flex-direction: row;
    gap: 0.5rem;
    width: 100%; /* ç¡®ä¿å æ»¡çˆ¶å®¹å™¨å®½åº¦ */
    max-width: 100%; /* é˜²æ­¢è¶…å‡º */
  }

  .search-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 15px;
    flex: 1;
    min-width: 0; /* å…è®¸è¾“å…¥æ¡†åœ¨å¿…è¦æ—¶ç¼©å° */
    max-width: 100%; /* é˜²æ­¢è¶…å‡º */
  }

  .search-button {
    padding: 0.75rem 1rem; /* å‡å°æŒ‰é’®çš„å·¦å³å†…è¾¹è· */
    border-radius: 12px;
    flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
    white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
    font-size: 14px; /* ç¨å¾®å‡å°å­—ä½“ */
  }

  /* ç§»åŠ¨ç«¯å¹³å°é€‰æ‹©æŒ‰é’® */
  .platform-selection {
    background: rgba(0, 0, 0, 0.2);
    padding: 4px;
    border-radius: 12px;
    margin-bottom: 1rem;
    display: flex;
    overflow: visible;
  }

  .platform-btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 13px;
    border-radius: 10px;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    min-width: auto;
  }

  .platform-btn.active {
    background: #0b5afe;
    color: #ffffff;
    box-shadow: 0 2px 8px rgba(11, 90, 254, 0.3);
  }

  /* ç§»åŠ¨ç«¯éŸ³æºçŠ¶æ€æ˜¾ç¤º */
  .source-status-display {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .status-header {
    margin-bottom: 0.5rem;
  }

  .status-title {
    font-size: 13px;
  }

  .status-summary {
    font-size: 11px;
    padding: 0.2rem 0.4rem;
  }

  .status-sources {
    gap: 0.4rem;
  }

  .source-item {
    padding: 0.4rem 0.6rem;
    font-size: 11px;
  }

  .source-indicator {
    width: 6px;
    height: 6px;
  }

  .error-message {
    margin-top: 0.5rem;
    padding: 0.4rem 0.6rem;
    font-size: 11px;
  }

  .form-row {
    flex-direction: column;
    gap: 1rem;
  }

  .form-group label {
    font-size: 18px;
  }

  .form-actions {
    justify-content: center;
  }

  .submit-button {
    width: 100%;
    padding: 0.75rem;
  }

  .alert-actions {
    flex-direction: column;
    gap: 0.5rem;
  }

  .vote-btn,
  .ignore-btn {
    width: 100%;
  }

  .audio-player {
    flex-direction: column;
    padding: 0.75rem;
  }

  .player-info {
    width: 100%;
  }

  .audio-player audio {
    width: 100%;
  }

  .close-player {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
  }

  /* ç§»åŠ¨ç«¯å¹³å°é€‰æ‹©Tab */
  .tab-header {
    gap: 2px;
  }

  .tab-btn {
    padding: 0.6rem 0.8rem;
    font-size: 13px;
  }

  /* ç§»åŠ¨ç«¯æœç´¢ç»“æœä¼˜åŒ– */
  .result-item {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.06);
    margin-bottom: 0.5rem;
    padding: 10px;
    flex-direction: row;
    gap: 10px;
    align-items: center;
  }

  .result-cover {
    width: 64px;
    height: 64px;
    align-self: flex-start;
  }

  .result-info {
    text-align: left;
    flex: 1;
  }

  .result-title {
    font-size: 15px;
    font-weight: 600;
  }

  .result-artist {
    font-size: 12px;
    opacity: 0.6;
    margin: 4px 0;
  }

  .result-actions {
    flex-direction: row;
    width: auto;
  }

  .select-btn {
    padding: 0.5rem 0.75rem;
    font-size: 12px;
    border-radius: 10px;
    width: auto;
  }

  /* ç§»åŠ¨ç«¯å¼¹çª—ä¼˜åŒ– */
  .modal-content {
    width: 95%;
    max-width: none;
  }

  .modal-actions {
    flex-direction: column;
    gap: 0.75rem;
  }

  .btn {
    width: 100%;
    padding: 0.75rem;
  }

  /* ç§»åŠ¨ç«¯æœç´¢æ’å›¾ */
  .search-svg {
    width: 50%;
    max-width: 250px;
    min-width: 120px;
  }

  .search-illustration {
    padding: 0.5rem;
    min-height: 120px;
  }

  /* ç§»åŠ¨ç«¯æœç´¢ç»“æœåˆ—è¡¨ */
  .results-list {
    flex: none; /* æ”¹ä¸ºä¸å ç”¨flexç©ºé—´ */
    height: auto;
    max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
    overflow: visible;
  }

  .results-grid {
    max-height: 60vh; /* ä¿æŒåˆç†çš„æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢ç»“æœè¿‡é•¿ */
    overflow-y: auto; /* å½“ç»“æœè¶…è¿‡æœ€å¤§é«˜åº¦æ—¶å…è®¸æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2rem; /* å‡å°åº•éƒ¨å†…è¾¹è· */
    padding-right: 0;
    /* ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨ä½“éªŒ */
    overscroll-behavior: contain; /* é˜²æ­¢æ»šåŠ¨ç©¿é€ */
  }

  /* å½“æ²¡æœ‰æœç´¢ç»“æœæ—¶ï¼Œç§»é™¤æ»šåŠ¨å®¹å™¨çš„é«˜åº¦é™åˆ¶ */
  .initial-state,
  .empty-state,
  .loading-state {
    min-height: 300px;
    max-height: none;
    overflow: visible;
  }

  /* ç§»åŠ¨ç«¯æœŸæœ›æ’æœŸé€‰æ‹© */
  .form-group {
    margin-bottom: 1rem;
    z-index: 10;
    position: relative;
  }

  .form-select {
    position: relative;
    z-index: 10;
  }

  /* ç¡®ä¿ç›¸ä¼¼æ­Œæ›²æç¤ºåœ¨ç§»åŠ¨ç«¯å¯è§ */
  .similar-song-alert {
    margin-top: 1rem;
    margin-bottom: 1rem;
    z-index: 20;
    position: relative;
  }
}

/* ç½‘æ˜“äº‘éŸ³ä¹è´¦å·åŠ è½½çŠ¶æ€æ ·å¼ */
.netease-loading-state {
  padding: 20px;
  background-color: transparent;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 10px 0;
  border: none;
}

.loading-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.netease-loading-state .loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid rgba(239, 68, 68, 0.2);
  border-top-color: #ef4444;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.netease-loading-state .loading-text {
  color: #ef4444;
  font-size: 14px;
  font-weight: 500;
  margin: 0;
}

/* URLéªŒè¯çŠ¶æ€æ ·å¼ */
.validation-loading {
  color: #fbbf24;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.validation-error {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.validation-success {
  color: #10b981;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.form-input.error {
  border-color: #ef4444;
  box-shadow: 0 0 0 1px #ef4444;
}

.import-semester-btn {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  padding: 0.6rem 0.8rem;
  color: rgba(255, 255, 255, 0.8);
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  height: 42px; /* ä½¿åŒ¹é…æœç´¢è¾“å…¥æ¡†çš„å¤§è‡´é«˜åº¦ */
  flex-shrink: 0;
}

.import-semester-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  border-color: rgba(255, 255, 255, 0.2);
}

@media (max-width: 768px) {
  .import-semester-btn {
    width: 100%;
    justify-content: center;
  }
}

.bilibili-episodes-container {
  max-height: 60vh;
  overflow-y: auto;
}

.video-info {
  padding: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  margin-bottom: 1rem;
}

.video-info h3 {
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 16px;
  color: #fff;
  margin-bottom: 0.5rem;
}

.video-author {
  font-family: 'MiSans', sans-serif;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
}

.episodes-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 0 1rem 1rem;
}

.episode-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.episode-item:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  transform: translateX(4px);
}

.episode-number {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.1);
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  min-width: 40px;
  text-align: center;
}

.episode-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.episode-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 500;
  font-size: 14px;
  color: #fff;
}

.episode-duration {
  font-family: 'MiSans', sans-serif;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
}
</style>
