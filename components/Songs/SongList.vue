<template>
  <div class="song-list">
    <!-- ÁßªÈô§È°∂ÈÉ®ÂæÑÂêëÊ∏êÂèò -->

    <div class="song-list-header">
      <div class="tab-controls">
        <button
            v-ripple
            :class="{ 'active': activeTab === 'all' }"
            class="tab-button"
            @click="setActiveTab('all')"
        >
          ÂÖ®ÈÉ®ÊäïÁ®ø
        </button>
        <button
            v-if="isAuthenticated"
            v-ripple
            :class="{ 'active': activeTab === 'mine' }"
            class="tab-button"
            @click="setActiveTab('mine')"
        >
          ÊàëÁöÑÊäïÁ®ø
        </button>
      </div>

      <div class="search-actions">
        <div class="search-box">
          <input
              v-model="searchQuery"
              class="search-input"
              placeholder="ËæìÂÖ•ÊÉ≥Ë¶ÅÊêúÁ¥¢ÁöÑÊ≠åÊõ≤"
              type="text"
          />
          <span class="search-icon">üîç</span>
        </div>

        <!-- Â≠¶ÊúüÈÄâÊã©Âô® -->
        <div v-if="availableSemesters.length > 1" class="semester-selector-compact">
          <button
              :title="'ÂΩìÂâçÂ≠¶Êúü: ' + selectedSemester"
              class="semester-toggle-btn"
              @click="showSemesterDropdown = !showSemesterDropdown"
          >
            <svg fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                 stroke-width="2" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7z"/>
            </svg>
          </button>

          <div v-if="showSemesterDropdown" class="semester-dropdown">
            <div
                v-for="semester in availableSemesters"
                :key="semester"
                :class="{ 'active': selectedSemester === semester }"
                class="semester-option"
                @click="onSemesterChange(semester)"
            >
              {{ semester }}
            </div>
          </div>
        </div>

        <!-- Ê∑ªÂä†Âà∑Êñ∞ÊåâÈíÆ - ‰ΩøÁî®SVGÂõæÊ†á -->
        <button
            :disabled="loading"
            :title="loading ? 'Ê≠£Âú®Âà∑Êñ∞...' : 'Âà∑Êñ∞Ê≠åÊõ≤ÂàóË°®'"
            class="refresh-button"
            @click="handleRefresh"
        >
          <svg :class="{ 'rotating': loading }" class="refresh-icon" fill="none" height="16"
               stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="16"
               xmlns="http://www.w3.org/2000/svg">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- ‰ΩøÁî®TransitionÁªÑ‰ª∂ÂåÖË£πÊâÄÊúâÂÜÖÂÆπ -->
    <Transition mode="out-in" name="tab-switch">
      <div v-if="loading" :key="'loading'" class="loading">
        Âä†ËΩΩ‰∏≠...
      </div>

      <div v-else-if="error" :key="'error'" class="error">
        {{ error }}
      </div>

      <div v-else-if="displayedSongs.length === 0" :key="'empty-' + activeTab" class="empty">
        {{ activeTab === 'mine' ? 'ÊÇ®ËøòÊ≤°ÊúâÊäïÁ®øÊ≠åÊõ≤ÔºåÈ©¨‰∏äÂéªÁÇπÊ≠åÂêßÔºÅ' : 'ÊöÇÊó†Ê≠åÊõ≤ÔºåÈ©¨‰∏äÂéªÁÇπÊ≠åÂêßÔºÅ' }}
      </div>

      <div v-else :key="'songs-' + activeTab" class="songs-container">
        <TransitionGroup
            class="song-cards"
            name="page"
            tag="div"
        >
          <div
              v-for="song in paginatedSongs"
              :key="song.id"
              :class="{ 'played': song.played, 'scheduled': song.scheduled, 'focused': isSongFocused(song.id) }"
              class="song-card"
              @click="handleSongCardClick(song)"
          >
            <!-- Ê≠åÊõ≤Âç°Áâá‰∏ª‰Ωì -->
            <div class="song-card-main">
              <!-- Ê∑ªÂä†Ê≠åÊõ≤Â∞ÅÈù¢ -->
              <div class="song-cover">
                <template v-if="song.cover">
                  <img
                      :alt="song.title"
                      :src="convertToHttps(song.cover)"
                      class="cover-image"
                      @error="handleImageError($event, song)"
                  />
                </template>
                <div v-else class="text-cover">
                  {{ getFirstChar(song.title) }}
                </div>
                <!-- Ê∑ªÂä†Êí≠ÊîæÊåâÈíÆ - Âú®ÊúâÊí≠Êîæ‰ø°ÊÅØÊó∂ÊòæÁ§∫ -->
                <div v-if="(song.musicPlatform && song.musicId) || song.playUrl" class="play-button-overlay"
                     @click.stop="togglePlaySong(song)">
                  <button :title="isCurrentPlaying(song.id) ? 'ÊöÇÂÅú' : 'Êí≠Êîæ'" class="play-button">
                    <Icon v-if="isCurrentPlaying(song.id)" :size="16" color="white" name="pause"/>
                    <Icon v-else :size="16" color="white" name="play"/>
                  </button>
                </div>
              </div>

              <div class="song-info">
                <h3 :title="song.title + ' - ' + song.artist" class="song-title">
                  <marquee-text :activated="isSongFocused(song.id)" :text="`${song.title} - ${song.artist}`"/>
                  <span v-if="song.played" class="played-tag">Â∑≤Êí≠Êîæ</span>
                  <span v-else-if="song.scheduled" class="scheduled-tag">Â∑≤ÊéíÊúü</span>
                </h3>
                <div class="song-meta">
                  <span class="requester">ÊäïÁ®ø‰∫∫Ôºö{{ song.requester }}</span>
                </div>
              </div>

              <!-- ÁÉ≠Â∫¶ÂíåÁÇπËµûÊåâÈíÆÂå∫Âüü -->
              <div class="action-area">
                <!-- ÁÉ≠Â∫¶Â±ïÁ§∫ -->
                <div class="vote-count">
                  <span class="count">{{ song.voteCount }}</span>
                  <span class="label">ÁÉ≠Â∫¶</span>
                </div>

                <!-- ÁÇπËµûÊåâÈíÆ -->
                <div class="like-button-wrapper">
                  <button
                      :class="{ 'liked': song.voted, 'disabled': song.played || song.scheduled || isMySong(song) || voteInProgress }"
                      :disabled="song.played || song.scheduled || voteInProgress"
                      :title="song.played ? 'Â∑≤Êí≠ÊîæÁöÑÊ≠åÊõ≤‰∏çËÉΩÁÇπËµû' : song.scheduled ? 'Â∑≤ÊéíÊúüÁöÑÊ≠åÊõ≤‰∏çËÉΩÁÇπËµû' : isMySong(song) ? '‰∏çÂÖÅËÆ∏Ëá™Â∑±ÁªôËá™Â∑±ÁÇπËµû' : (song.voted ? 'ÁÇπÂáªÂèñÊ∂àÁÇπËµû' : 'ÁÇπËµû')"
                      class="like-button"
                      @click.stop="handleVote(song)"
                  >
                    <img alt="ÁÇπËµû" class="like-icon" src="/images/thumbs-up.svg"/>
                  </button>
                </div>
              </div>

              <!-- ÁßªÈô§ÂéüÊù•‰ΩçÁΩÆÁöÑÂ∑≤ÊéíÊúüÊ†áÁ≠æ -->
            </div>

            <!-- ÊäïÁ®øÊó∂Èó¥ÂíåÊí§ÈîÄÊåâÈíÆ -->
            <div class="submission-footer">
              <div class="submission-time">
                ÊäïÁ®øÊó∂Èó¥Ôºö{{ song.requestedAt }}
              </div>

              <!-- Â¶ÇÊûúÊòØËá™Â∑±ÁöÑÊäïÁ®øÔºåÊòæÁ§∫Êí§ÂõûÊåâÈíÆ -->
              <button
                  v-if="isMySong(song) && !song.played && !song.scheduled"
                  :disabled="actionInProgress"
                  class="withdraw-button"
                  title="Êí§ÂõûÊäïÁ®ø"
                  @click.stop="handleWithdraw(song)"
              >
                Êí§ÈîÄ
              </button>
            </div>
          </div>
        </TransitionGroup>

        <!-- ÂàÜÈ°µÊéß‰ª∂ -->
        <div v-if="totalPages > 1" class="pagination">
          <button
              :disabled="currentPage === 1"
              class="page-button"
              @click="goToPage(currentPage - 1)"
          >
            ‰∏ä‰∏ÄÈ°µ
          </button>

          <div class="page-numbers">
            <button
                v-for="page in displayedPageNumbers"
                :key="page"
                :class="['page-number', { active: currentPage === page }]"
                @click="goToPage(page)"
            >
              {{ page }}
            </button>
          </div>

          <button
              :disabled="currentPage === totalPages"
              class="page-button"
              @click="goToPage(currentPage + 1)"
          >
            ‰∏ã‰∏ÄÈ°µ
          </button>

          <div class="page-info">
            {{ currentPage }} / {{ totalPages }} È°µ
          </div>

          <!-- Ëá™ÂÆö‰πâË∑≥ËΩ¨Êéß‰ª∂ -->
          <div class="page-jump">
            <span class="jump-label">Ë∑≥ËΩ¨Ëá≥</span>
            <input
                v-model.number="jumpPageInput"
                :max="totalPages"
                :min="1"
                :placeholder="'1-' + totalPages"
                class="jump-input"
                type="number"
                @input="validateJumpInput"
                @keyup.enter="handleJumpToPage"
            />
            <button
                :disabled="!isValidJumpPage"
                class="jump-button"
                title="Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢"
                @click="handleJumpToPage"
            >
              Ë∑≥ËΩ¨
            </button>
          </div>
        </div>

        <!-- Á°ÆËÆ§ÂØπËØùÊ°Ü -->
        <div v-if="confirmDialog.show" class="confirm-dialog-backdrop" @click.self="cancelConfirm">
          <div class="confirm-dialog">
            <div class="confirm-dialog-header">
              <h3>{{ confirmDialog.title }}</h3>
            </div>
            <div class="confirm-dialog-content">
              {{ confirmDialog.message }}
            </div>
            <div class="confirm-dialog-actions">
              <button
                  class="confirm-dialog-btn confirm-dialog-cancel"
                  @click="cancelConfirm"
              >
                ÂèñÊ∂à
              </button>
              <button
                  class="confirm-dialog-btn confirm-dialog-confirm"
                  @click="confirmAction"
              >
                Á°ÆËÆ§
              </button>
            </div>
          </div>
        </div>
      </div>
    </Transition>

    <!-- ‰ΩøÁî®ÂÖ®Â±ÄÈü≥È¢ëÊí≠ÊîæÂô®ÔºåÊ≠§Â§Ñ‰∏çÈúÄË¶ÅaudioÂÖÉÁ¥† -->
  </div>
</template>

<script setup>
import {computed, nextTick, onMounted, onUnmounted, ref, watch} from 'vue'
import {useAuth} from '~/composables/useAuth'
import {useAudioPlayer} from '~/composables/useAudioPlayer'
import {useSemesters} from '~/composables/useSemesters'
import {useMusicSources} from '~/composables/useMusicSources'
import {useAudioQuality} from '~/composables/useAudioQuality'
import {useSongs} from '~/composables/useSongs'
import Icon from '~/components/UI/Icon.vue'
import MarqueeText from '~/components/UI/MarqueeText.vue'
import {convertToHttps} from '~/utils/url'

const props = defineProps({
  songs: {
    type: Array,
    default: () => []
  },
  loading: {
    type: Boolean,
    default: false
  },
  error: {
    type: String,
    default: ''
  },
  isAdmin: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['vote', 'withdraw', 'refresh', 'semester-change'])
const voteInProgress = ref(false)
const actionInProgress = ref(false)
const sortBy = ref('popularity')
const sortOrder = ref('desc') // 'desc' for newest first, 'asc' for oldest first
const searchQuery = ref('') // ÊêúÁ¥¢Êü•ËØ¢
const activeTab = ref('all') // ÈªòËÆ§ÊòæÁ§∫ÂÖ®ÈÉ®ÊäïÁ®ø
const auth = useAuth()
const isAuthenticated = computed(() => auth && auth.isAuthenticated && auth.isAuthenticated.value)

// ÁÑ¶ÁÇπÁä∂ÊÄÅÁÆ°ÁêÜ
const focusedSongId = ref(null)

// Â§ÑÁêÜÊ≠åÊõ≤Âç°ÁâáÁÑ¶ÁÇπÂàáÊç¢
const handleSongCardClick = (song) => {
  // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂΩìÂâçÂ∑≤Ëé∑ÂæóÁÑ¶ÁÇπÁöÑÊ≠åÊõ≤ÔºåÂàôÂèñÊ∂àÁÑ¶ÁÇπ
  if (focusedSongId.value === song.id) {
    focusedSongId.value = null
  } else {
    // Âê¶ÂàôËÆæÁΩÆÊñ∞ÁöÑÁÑ¶ÁÇπÊ≠åÊõ≤
    focusedSongId.value = song.id
  }
}

// Âà§Êñ≠Ê≠åÊõ≤ÊòØÂê¶Ëé∑ÂæóÁÑ¶ÁÇπ
const isSongFocused = (songId) => {
  return focusedSongId.value === songId
}

// Â≠¶ÊúüÁõ∏ÂÖ≥
const {fetchCurrentSemester, currentSemester, semesterUpdateEvent} = useSemesters()
const availableSemesters = ref([])
const selectedSemester = ref('')
const showSemesterDropdown = ref(false)

// Ëé∑ÂèñÂÆåÊï¥Ê≠åÊõ≤Êï∞ÊçÆÊ∫ê
const songsComposable = useSongs()
const allSongsData = computed(() => songsComposable?.visibleSongs?.value || [])

// Èü≥È¢ëÊí≠ÊîæÁõ∏ÂÖ≥
const audioPlayer = useAudioPlayer()

// ÂàÜÈ°µÁõ∏ÂÖ≥
const currentPage = ref(1)
const pageSize = ref(12) // ÊØèÈ°µÊòæÁ§∫12È¶ñÊ≠åÊõ≤ÔºåÈÄÇÂêàÊ®™ÂêëÂ∏ÉÂ±Ä
const isMobile = ref(false)

// Ëá™ÂÆö‰πâË∑≥ËΩ¨Áõ∏ÂÖ≥
const jumpPageInput = ref('')
const isValidJumpPage = ref(false)

// ÁªÑ‰ª∂ÂàùÂßãÂåñÁä∂ÊÄÅ
const isComponentInitialized = ref(false)
const isDataLoading = ref(false)
// Èò≤ÈáçÂ§çË∞ÉÁî®Ê†áÂøó
const isFetchingSemesters = ref(false)
// Áî®Êà∑ÊâãÂä®ÈÄâÊã©Â≠¶ÊúüÊ†áÂøó
const isUserManuallySelected = ref(false)

// ÂàáÊç¢Ê¥ªÂä®Ê†áÁ≠æ
const setActiveTab = (tab) => {
  if (activeTab.value === tab) return; // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂΩìÂâçÊ†áÁ≠æÔºå‰∏çÊâßË°åÂàáÊç¢
  activeTab.value = tab
  currentPage.value = 1 // ÈáçÁΩÆ‰∏∫Á¨¨‰∏ÄÈ°µ
}

// Ê£ÄÊµãËÆæÂ§áÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§á
const checkMobile = () => {
  isMobile.value = window.innerWidth < 768
}

// Â§ÑÁêÜÂ≠¶ÊúüËøáÊª§ÂèòÂåñ‰∫ã‰ª∂
const handleSemesterFilterChange = (event) => {
  const newSemester = event.detail.semester


  // Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÂ≠¶Êúü
  selectedSemester.value = newSemester

  // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  currentPage.value = 1

  // ‰øùÂ≠òÂà∞sessionStorage
  if (newSemester) {
    sessionStorage.setItem('voicehub_selected_semester', newSemester)
  } else {
    sessionStorage.removeItem('voicehub_selected_semester')
  }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÂíåÂç∏ËΩΩÊó∂Ê∑ªÂä†/ÁßªÈô§Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
onMounted(async () => {
  checkMobile()
  window.addEventListener('resize', checkMobile)

  // Ê∑ªÂä†Â≠¶ÊúüËøáÊª§ÂèòÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
  window.addEventListener('semester-filter-change', handleSemesterFilterChange)

  // È¶ñÂÖà‰ªésessionStorageÊÅ¢Â§çÂ≠¶ÊúüÈÄâÊã©Áä∂ÊÄÅ
  try {
    const savedSemester = sessionStorage.getItem('voicehub_selected_semester')
    if (savedSemester && !containsCorruptedText(savedSemester)) {
      const cleanSavedSemester = cleanCorruptedText(savedSemester)
      if (cleanSavedSemester) {
        selectedSemester.value = cleanSavedSemester
      }
    }
  } catch (error) {
    console.warn('ÊÅ¢Â§çÂ≠¶ÊúüÈÄâÊã©Áä∂ÊÄÅÂ§±Ë¥•:', error)
  }

  isDataLoading.value = true
  try {
    // È¶ñÂÖàËé∑ÂèñÂΩìÂâçÂ≠¶Êúü
    await fetchCurrentSemester()

    // ÁÑ∂ÂêéËé∑ÂèñÂèØÁî®Â≠¶ÊúüÔºàÂàùÂßãÂåñÊúüÈó¥Âè™ËÆæÁΩÆÂàóË°®Ôºå‰∏çÊâßË°åÈÄâÊã©ÈÄªËæëÔºâ
    await fetchAvailableSemesters()

    // Ê†áËÆ∞ÁªÑ‰ª∂ÂàùÂßãÂåñÂÆåÊàê
    isComponentInitialized.value = true

  } catch (error) {
    console.error('ÁªÑ‰ª∂ÂàùÂßãÂåñÂ§±Ë¥•:', error)
  } finally {
    isDataLoading.value = false
  }
})

onUnmounted(() => {
  window.removeEventListener('resize', checkMobile)
  // ÁßªÈô§Â≠¶ÊúüËøáÊª§ÂèòÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
  window.removeEventListener('semester-filter-change', handleSemesterFilterChange)
})

// ÁõëÂê¨Ê≠åÊõ≤Êï∞ÊçÆÂèòÂåñÔºåÊõ¥Êñ∞Â≠¶Êúü‰ø°ÊÅØ
watch(() => props.songs, () => {
  // Âè™ÊúâÂú®ÁªÑ‰ª∂ÂÆåÂÖ®ÂàùÂßãÂåñÂêé‰∏î‰∏çÂú®Ëé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØÊó∂ÊâçÂ§ÑÁêÜÊï∞ÊçÆÊõ¥Êñ∞
  if (isComponentInitialized.value && !isDataLoading.value && !isFetchingSemesters.value) {
    fetchAvailableSemesters()
  }
}, {deep: true})

// ÁõëÂê¨Â≠¶ÊúüÊõ¥Êñ∞‰∫ã‰ª∂
watch(semesterUpdateEvent, async () => {
  // Âè™ÊúâÂú®ÁªÑ‰ª∂ÂÆåÂÖ®ÂàùÂßãÂåñÂêé‰∏î‰∏çÂú®Ëé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØÊó∂ÊâçÂ§ÑÁêÜÂ≠¶ÊúüÊõ¥Êñ∞
  if (isComponentInitialized.value && !isDataLoading.value && !isFetchingSemesters.value) {
    fetchAvailableSemesters()
  }
})

// ÁõëÂê¨ÊêúÁ¥¢Êü•ËØ¢ÂèòÂåñÔºåÈáçÁΩÆÂàÜÈ°µ
watch(searchQuery, () => {
  currentPage.value = 1
})

// ÁõëÂê¨allSongsDataÂèòÂåñÔºåÂΩìÊï∞ÊçÆÁúüÊ≠£Âä†ËΩΩÂÆåÊàêÊó∂ÈáçÊñ∞Ëé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØ
watch(allSongsData, (newData) => {
  // Âè™ÊúâÂú®ÁªÑ‰ª∂ÂÆåÂÖ®ÂàùÂßãÂåñÂêé‰∏îÊï∞ÊçÆÁúüÊ≠£ÊúâÂÜÖÂÆπÊó∂ÊâçÂ§ÑÁêÜ
  if (isComponentInitialized.value && newData && newData.length > 0 && !isFetchingSemesters.value) {
    fetchAvailableSemesters()
  }
}, {deep: true})

// Á°ÆËÆ§ÂØπËØùÊ°Ü
const confirmDialog = ref({
  show: false,
  title: '',
  message: '',
  action: '',
  data: null
})

// Ê†ºÂºèÂåñÊó•Êúü‰∏∫ XÂπ¥XÊúàXÊó•
const formatDate = (dateString) => {
  if (!dateString) return 'Êú™Áü•Êó∂Èó¥'
  const date = new Date(dateString)
  return `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó•`
}

// Ê†ºÂºèÂåñÊó•Êúü‰∏∫ XÂπ¥XÊúàXÊó• HH:MM
const formatDateTime = (dateString) => {
  if (!dateString) return 'Êú™Áü•Êó∂Èó¥'
  const date = new Date(dateString)
  const hours = date.getHours().toString().padStart(2, '0')
  const minutes = date.getMinutes().toString().padStart(2, '0')
  return `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${hours}:${minutes}`
}

// Âà§Êñ≠ÊòØÂê¶ÊòØËá™Â∑±ÊäïÁ®øÁöÑÊ≠åÊõ≤
const isMySong = (song) => {
  return auth && auth.user && auth.user.value && song.requesterId === auth.user.value.id
}

// Â∫îÁî®ËøáÊª§Âô®ÂíåÊêúÁ¥¢
const displayedSongs = computed(() => {
  if (!props.songs) return []

  let result = [...props.songs]

  // Â∫îÁî®Â≠¶ÊúüËøáÊª§Âô®
  if (selectedSemester.value) {
    result = result.filter(song => song.semester === selectedSemester.value)
  }

  // Â∫îÁî®Ê†áÁ≠æËøáÊª§Âô®
  if (activeTab.value === 'mine') {
    result = result.filter(song => isMySong(song))
  }

  // Â∫îÁî®ÊêúÁ¥¢ËøáÊª§Âô®
  if (searchQuery.value.trim()) {
    const query = searchQuery.value.toLowerCase().trim()
    result = result.filter(song =>
        song.title.toLowerCase().includes(query) ||
        song.artist.toLowerCase().includes(query) ||
        (song.requester && song.requester.toLowerCase().includes(query))
    )
  }

  // ÊåâÁä∂ÊÄÅÂàÜÁªÑÔºöÊú™ÊéíÊúü„ÄÅÂ∑≤ÊéíÊúü„ÄÅÂ∑≤Êí≠Êîæ
  const unscheduledSongs = result.filter(song => !song.played && !song.scheduled)
  const scheduledSongs = result.filter(song => !song.played && song.scheduled)
  const playedSongs = result.filter(song => song.played)

  // ÂØπÊØè‰∏™ÂàÜÁªÑÂÜÖÈÉ®ËøõË°åÊéíÂ∫è
  const sortSongs = (songs) => {
    if (sortBy.value === 'popularity') {
      return songs.sort((a, b) => {
        // È¶ñÂÖàÊåâÊäïÁ•®Êï∞ÈôçÂ∫èÊéíÂàó
        if (b.voteCount !== a.voteCount) {
          return b.voteCount - a.voteCount
        }
        // ÊäïÁ•®Êï∞Áõ∏ÂêåÊó∂ÔºåÊåâÂàõÂª∫Êó∂Èó¥ÂçáÂ∫èÊéíÂàóÔºàÊäïÁ®øÊó©ÁöÑÂú®ÂâçÈù¢Ôºâ
        return new Date(a.createdAt) - new Date(b.createdAt)
      })
    } else if (sortBy.value === 'date') {
      return songs.sort((a, b) => {
        const dateA = new Date(a.createdAt)
        const dateB = new Date(b.createdAt)
        return sortOrder.value === 'desc' ? dateB - dateA : dateA - dateB
      })
    }
    return songs
  }

  // ËøîÂõûÊåâÈ°∫Â∫èÊéíÂàóÁöÑÊ≠åÊõ≤ÔºöÊú™ÊéíÊúü ‚Üí Â∑≤ÊéíÊúü ‚Üí Â∑≤Êí≠Êîæ
  return [
    ...sortSongs(unscheduledSongs),
    ...sortSongs(scheduledSongs),
    ...sortSongs(playedSongs)
  ]
})

// ËÆ°ÁÆóÊÄªÈ°µÊï∞
const totalPages = computed(() => {
  return Math.max(1, Math.ceil(displayedSongs.value.length / pageSize.value))
})

// Ëé∑ÂèñÂΩìÂâçÈ°µÁöÑÊ≠åÊõ≤
const paginatedSongs = computed(() => {
  const startIndex = (currentPage.value - 1) * pageSize.value
  const endIndex = startIndex + pageSize.value
  return displayedSongs.value.slice(startIndex, endIndex)
})

// ËÆ°ÁÆóÂàÜÈ°µÊòæÁ§∫ÁöÑÈ°µÁ†Å
const displayedPageNumbers = computed(() => {
  const result = []
  const totalPagesToShow = 5

  if (totalPages.value <= totalPagesToShow) {
    // Â¶ÇÊûúÊÄªÈ°µÊï∞Â∞è‰∫éÁ≠â‰∫éË¶ÅÊòæÁ§∫ÁöÑÈ°µÊï∞ÔºåÂàôÊòæÁ§∫ÊâÄÊúâÈ°µÁ†Å
    for (let i = 1; i <= totalPages.value; i++) {
      result.push(i)
    }
  } else {
    // Âê¶ÂàôÔºåÊòæÁ§∫ÂΩìÂâçÈ°µÈôÑËøëÁöÑÈ°µÁ†Å
    const leftOffset = Math.floor(totalPagesToShow / 2)
    const rightOffset = totalPagesToShow - leftOffset - 1

    let start = currentPage.value - leftOffset
    let end = currentPage.value + rightOffset

    // Ë∞ÉÊï¥Ëµ∑ÂßãÂíåÁªìÊùüÈ°µÁ†ÅÔºåÁ°Æ‰øùÂÆÉ‰ª¨Âú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
    if (start < 1) {
      end = end + (1 - start)
      start = 1
    }

    if (end > totalPages.value) {
      start = Math.max(1, start - (end - totalPages.value))
      end = totalPages.value
    }

    for (let i = start; i <= end; i++) {
      result.push(i)
    }
  }

  return result
})

// ÂâçÂæÄÊåáÂÆöÈ°µ
const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page
  }
}

// È™åËØÅË∑≥ËΩ¨ËæìÂÖ•
const validateJumpInput = () => {
  const page = parseInt(jumpPageInput.value)
  isValidJumpPage.value = !isNaN(page) && page >= 1 && page <= totalPages.value
}

// Â§ÑÁêÜË∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µÈù¢
const handleJumpToPage = () => {
  const page = parseInt(jumpPageInput.value)
  if (!isNaN(page) && page >= 1 && page <= totalPages.value) {
    goToPage(page)
    jumpPageInput.value = '' // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    isValidJumpPage.value = false
  } else {
    // ËæìÂÖ•Êó†ÊïàÊó∂ÁªôÂá∫ÊèêÁ§∫
    if (window.$showNotification) {
      window.$showNotification(`ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ°µÁ†Å (1-${totalPages.value})`, 'error')
    }
  }
}

// Â§ÑÁêÜÊäïÁ•®
const handleVote = async (song) => {
  // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÁôªÂΩï
  if (!isAuthenticated.value) {
    if (window.$showNotification) {
      window.$showNotification('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçÁÇπËµû', 'error')
    }
    return
  }

  // Ê£ÄÊü•Ê≠åÊõ≤Áä∂ÊÄÅ
  if (song.played || song.scheduled) {
    return // Â∑≤Êí≠ÊîæÊàñÂ∑≤ÊéíÊúüÁöÑÊ≠åÊõ≤‰∏çËÉΩÁÇπËµû
  }

  // Ê£ÄÊü•ÊòØÂê¶ÊòØËá™Â∑±ÁöÑÊ≠åÊõ≤
  if (isMySong(song)) {
    if (window.$showNotification) {
      window.$showNotification('‰∏çÂÖÅËÆ∏Ëá™Â∑±ÁªôËá™Â∑±ÁÇπËµû', 'error')
    }
    return
  }

  voteInProgress.value = true
  try {
    if (song.voted) {
      // Â¶ÇÊûúÂ∑≤ÊäïÁ•®ÔºåÂàôË∞ÉÁî®Êí§ÈîÄÊäïÁ•®
      emit('vote', {...song, unvote: true})
    } else {
      // Ê≠£Â∏∏ÊäïÁ•®
      emit('vote', song)
    }
  } catch (err) {
    // ÊäïÁ•®Â§ÑÁêÜÂ§±Ë¥•
  } finally {
    voteInProgress.value = false
  }
}

// Â§ÑÁêÜÊí§Âõû
const handleWithdraw = (song) => {
  if (song.scheduled) {
    return // Â∑≤ÊéíÊúüÁöÑÊ≠åÊõ≤‰∏çËÉΩÊí§Âõû
  }

  confirmDialog.value = {
    show: true,
    title: 'Êí§ÂõûÊäïÁ®ø',
    message: `Á°ÆËÆ§Êí§ÂõûÊ≠åÊõ≤„Ää${song.title}„ÄãÁöÑÊäïÁ®øÂêóÔºü`,
    action: 'withdraw',
    data: song
  }
}

// Â§ÑÁêÜÂà∑Êñ∞ÊåâÈíÆÁÇπÂáª
const handleRefresh = () => {
  emit('refresh')
}

// Á°ÆËÆ§ÊâßË°åÊìç‰Ωú
const confirmAction = async () => {
  const {action, data} = confirmDialog.value

  actionInProgress.value = true
  try {
    emit(action, data)
  } catch (err) {
    // Êìç‰ΩúÊâßË°åÂ§±Ë¥•
  } finally {
    actionInProgress.value = false
    confirmDialog.value.show = false
  }
}

// ÂèñÊ∂àÁ°ÆËÆ§
const cancelConfirm = () => {
  confirmDialog.value.show = false
}

// Â§ÑÁêÜÂõæÁâáÂä†ËΩΩÈîôËØØ
const handleImageError = (event, song) => {
  if (event?.target) {
    event.target.style.display = 'none'
    if (event.target.parentNode) {
      event.target.parentNode.classList.add('text-cover')
      event.target.parentNode.textContent = getFirstChar(song.title)
    }
  }
}

// Ëé∑ÂèñÊ≠åÊõ≤Ê†áÈ¢òÁöÑÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰Ωú‰∏∫Â∞ÅÈù¢
const getFirstChar = (title) => {
  if (!title) return 'Èü≥'
  return title.trim().charAt(0)
}


// ÂàáÊç¢Ê≠åÊõ≤Êí≠Êîæ/ÊöÇÂÅú
const togglePlaySong = async (song) => {
  // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂΩìÂâçÊ≠åÊõ≤‰∏îÊ≠£Âú®Êí≠Êîæ
  if (audioPlayer.isCurrentSong(song.id) && audioPlayer.getPlayingStatus().value) {
    // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂàôÊöÇÂÅú
    audioPlayer.pauseSong()
    return
  }

  // Â¶ÇÊûúÊòØÂΩìÂâçÊ≠åÊõ≤‰ΩÜÂ∑≤ÊöÇÂÅúÔºåÂàôÊÅ¢Â§çÊí≠Êîæ
  if (audioPlayer.isCurrentSong(song.id) && !audioPlayer.getPlayingStatus().value) {
    // Ê£ÄÊü•ÂΩìÂâçÂÖ®Â±ÄÊ≠åÊõ≤ÊòØÂê¶ÊúâURL
    const currentGlobalSong = audioPlayer.getCurrentSong().value
    if (currentGlobalSong && currentGlobalSong.musicUrl) {
      // Â¶ÇÊûúÊúâURLÔºåÁõ¥Êé•ÊÅ¢Â§çÊí≠Êîæ
      audioPlayer.playSong(currentGlobalSong)
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâURLÔºåÈáçÊñ∞Ëé∑Âèñ
      if ((song.musicPlatform && song.musicId) || song.playUrl) {
        try {
          const url = await getMusicUrl(song.musicPlatform, song.musicId, song.playUrl)
          if (url) {
            const playableSong = {
              ...song,
              musicUrl: url
            }
            // ÊûÑÂª∫Êí≠ÊîæÂàóË°®Âπ∂ËÆæÁΩÆÂΩìÂâçÊ≠åÊõ≤Á¥¢Âºï
            const playlist = await buildPlayablePlaylist(song)
            const currentIndex = playlist.findIndex(item => item.id === song.id)
            audioPlayer.playSong(playableSong, playlist, currentIndex)
            // ÂêéÂè∞È¢ÑÂèñÂêéÁª≠Ê≠åÊõ≤ÁöÑÊí≠ÊîæÈìæÊé•Ôºà‰∏çÈòªÂ°ûÂΩìÂâçÊí≠ÊîæÔºâ
            ;(async () => {
              for (let i = currentIndex + 1; i < playlist.length; i++) {
                const s = playlist[i]
                if (!s.musicUrl && ((s.musicPlatform && s.musicId) || s.playUrl)) {
                  try {
                    s.musicUrl = await getMusicUrl(s.musicPlatform, s.musicId, s.playUrl)
                  } catch (error) {
                    console.warn(`ÂêéÂè∞È¢ÑÂèñÂ§±Ë¥•: ${s.title}`, error)
                    s.musicUrl = null
                  }
                }
              }
            })()
          } else {
            if (window.$showNotification) {
              window.$showNotification('Êó†Ê≥ïËé∑ÂèñÈü≥‰πêÊí≠ÊîæÈìæÊé•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error')
            }
          }
        } catch (error) {
          if (window.$showNotification) {
            window.$showNotification('Ëé∑ÂèñÈü≥‰πêÊí≠ÊîæÈìæÊé•Â§±Ë¥•', 'error')
          }
        }
      }
    }
    return
  }

  // Â¶ÇÊûúÊúâÂπ≥Âè∞ÂíåID‰ø°ÊÅØÊàñplayUrlÔºåÂä®ÊÄÅËé∑ÂèñURL
  if ((song.musicPlatform && song.musicId) || song.playUrl) {
    try {
      const url = await getMusicUrl(song.musicPlatform, song.musicId, song.playUrl)
      if (url) {
        const playableSong = {
          ...song,
          musicUrl: url
        }
        // ÊûÑÂª∫Êí≠ÊîæÂàóË°®Âπ∂ËÆæÁΩÆÂΩìÂâçÊ≠åÊõ≤Á¥¢Âºï
        const playlist = await buildPlayablePlaylist(song)
        const currentIndex = playlist.findIndex(item => item.id === song.id)
        audioPlayer.playSong(playableSong, playlist, currentIndex)

        // ÂêéÂè∞È¢ÑÂèñÂêéÁª≠Ê≠åÊõ≤ÁöÑÊí≠ÊîæÈìæÊé•Ôºà‰∏çÈòªÂ°ûÂΩìÂâçÊí≠ÊîæÔºâ
        ;(async () => {
          for (let i = currentIndex + 1; i < playlist.length; i++) {
            const s = playlist[i]
            if (!s.musicUrl && ((s.musicPlatform && s.musicId) || s.playUrl)) {
              try {
                s.musicUrl = await getMusicUrl(s.musicPlatform, s.musicId, s.playUrl)
              } catch (error) {
                console.warn(`ÂêéÂè∞È¢ÑÂèñÂ§±Ë¥•: ${s.title}`, error)
                s.musicUrl = null
              }
            }
          }
        })()
      } else {
        if (window.$showNotification) {
          window.$showNotification('Êó†Ê≥ïËé∑ÂèñÈü≥‰πêÊí≠ÊîæÈìæÊé•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error')
        }
      }
    } catch (error) {
      if (window.$showNotification) {
        window.$showNotification('Ëé∑ÂèñÈü≥‰πêÊí≠ÊîæÈìæÊé•Â§±Ë¥•', 'error')
      }
    }
  }
}

// ÊûÑÂª∫ÂèØÊí≠ÊîæÁöÑÊí≠ÊîæÂàóË°®
const buildPlayablePlaylist = async (currentSong) => {
  // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÊ≠åÊõ≤ÂàóË°®ÔºàÂ∑≤ÁªèËøáÊª§ÂíåÊéíÂ∫èÔºâ
  const songsToProcess = paginatedSongs.value.filter(song =>
      ((song.musicPlatform && song.musicId) || song.playUrl) && song.id !== currentSong.id
  )

  // Â∞ÜÂΩìÂâçÊ≠åÊõ≤Ê∑ªÂä†Âà∞ÂàóË°®‰∏≠Ê≠£Á°ÆÁöÑ‰ΩçÁΩÆ
  const allSongs = [...paginatedSongs.value]

  // Âè™ËøîÂõûÊúâÊí≠Êîæ‰ø°ÊÅØÁöÑÊ≠åÊõ≤Ôºå‰øùÊåÅÂéüÊúâÈ°∫Â∫è
  return allSongs.filter(song => (song.musicPlatform && song.musicId) || song.playUrl)
}

// Âä®ÊÄÅËé∑ÂèñÈü≥‰πêURL
const getMusicUrl = async (platform, musicId, playUrl) => {
  // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÊí≠ÊîæÈìæÊé•Ôºå‰ºòÂÖà‰ΩøÁî®
  if (playUrl && playUrl.trim()) {
    console.log(`[SongList] ‰ΩøÁî®Ëá™ÂÆö‰πâÊí≠ÊîæÈìæÊé•: ${playUrl}`)
    return playUrl.trim()
  }

  // Â¶ÇÊûúÊ≤°ÊúâplayUrlÔºåÊ£ÄÊü•platformÂíåmusicIdÊòØÂê¶ÊúâÊïà
  if (!platform || !musicId) {
    throw new Error('Ê≠åÊõ≤Áº∫Â∞ëÈü≥‰πêÂπ≥Âè∞ÊàñÈü≥‰πêID‰ø°ÊÅØÔºåÊó†Ê≥ïËé∑ÂèñÊí≠ÊîæÈìæÊé•')
  }

  const {getQuality} = useAudioQuality()
  const {getSongUrl} = useMusicSources()

  try {
    const quality = getQuality(platform)

    // ÂÖà‰ΩøÁî®Áªü‰∏ÄÁªÑ‰ª∂ÁöÑ NeteaseCloudMusicApiÔºà‰ªÖÁΩëÊòì‰∫ëÔºâ
    if (platform === 'netease') {
      const result = await getSongUrl(musicId, quality)
      if (result.success && result.url) {
        return result.url
      }
      console.warn('[SongList] Â§áÁî®Ê∫êÊú™ËøîÂõûÊúâÊïàÈìæÊé•ÔºåÂõûÈÄÄÂà∞ vkeys')
    }

    // ÂõûÈÄÄÂà∞ vkeys
    let apiUrl
    if (platform === 'netease') {
      apiUrl = `https://api.vkeys.cn/v2/music/netease?id=${musicId}&quality=${quality}`
    } else if (platform === 'tencent') {
      apiUrl = `https://api.vkeys.cn/v2/music/tencent?id=${musicId}&quality=${quality}`
    } else {
      throw new Error('‰∏çÊîØÊåÅÁöÑÈü≥‰πêÂπ≥Âè∞')
    }

    const response = await fetch(apiUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
      }
    })
    if (!response.ok) {
      throw new Error('Ëé∑ÂèñÈü≥‰πêURLÂ§±Ë¥•')
    }

    const data = await response.json()
    if (data.code === 200 && data.data && data.data.url) {
      // Â∞ÜHTTP URLÊîπ‰∏∫HTTPS
      let url = data.data.url
      if (url.startsWith('http://')) {
        url = url.replace('http://', 'https://')
      }
      return url
    }

    throw new Error('vkeysËøîÂõûÊàêÂäü‰ΩÜÊú™Ëé∑ÂèñÂà∞Èü≥‰πêURL')
  } catch (error) {
    throw error
  }
}

// Âà§Êñ≠ÂΩìÂâçÊòØÂê¶Ê≠£Âú®Êí≠ÊîæÊåáÂÆöIDÁöÑÊ≠åÊõ≤
const isCurrentPlaying = (songId) => {
  return audioPlayer.isCurrentPlaying(songId)
}

// Â≠¶ÊúüÁõ∏ÂÖ≥Áä∂ÊÄÅ
const semesterLoading = ref(false)
const semesterError = ref('')

// Èò≤ÊäñÂ§ÑÁêÜÂ≠¶ÊúüÂàáÊç¢
const debouncedSemesterChange = debounce((semester) => {
  // Â¢ûÂº∫ÁöÑÁä∂ÊÄÅÊ£ÄÊü•
  if (semesterLoading.value || isDataLoading.value || !isComponentInitialized.value) {
    return
  }

  // ÂÜçÊ¨°Ê£ÄÊü•Âπ∂Ê∏ÖÁêÜÂ≠¶ÊúüÊï∞ÊçÆ
  if (containsCorruptedText(semester)) {
    console.warn('Èò≤ÊäñÂáΩÊï∞Ê£ÄÊµãÂà∞‰π±Á†ÅÂ≠¶ÊúüÊï∞ÊçÆÔºåË∑≥ËøáÂàáÊç¢')
    return
  }

  const cleanSemester = cleanCorruptedText(semester)
  if (!cleanSemester) {
    console.warn('Èò≤ÊäñÂáΩÊï∞Ê£ÄÊµãÂà∞Á©∫Â≠¶ÊúüÊï∞ÊçÆÔºåË∑≥ËøáÂàáÊç¢')
    return
  }

  // Ê£ÄÊü•Â≠¶ÊúüÊòØÂê¶‰ªçÂú®ÂèØÁî®ÂàóË°®‰∏≠
  if (!availableSemesters.value.includes(cleanSemester)) {
    console.warn('Èò≤ÊäñÂáΩÊï∞Ê£ÄÊµãÂà∞Â≠¶Êúü‰∏çÂú®ÂèØÁî®ÂàóË°®‰∏≠ÔºåË∑≥ËøáÂàáÊç¢:', cleanSemester)
    return
  }

  // ÊâßË°åÂ≠¶ÊúüÂàáÊç¢

  selectedSemester.value = cleanSemester
  showSemesterDropdown.value = false
  currentPage.value = 1 // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ

  // ‰øùÂ≠òÂà∞sessionStorage
  try {
    sessionStorage.setItem('voicehub_selected_semester', cleanSemester)
  } catch (error) {
    console.warn('Èò≤ÊäñÂáΩÊï∞Êó†Ê≥ï‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©Âà∞sessionStorage:', error)
  }

  emit('semester-change', cleanSemester)
}, 300)

// ‰π±Á†ÅÊ£ÄÊµãÂáΩÊï∞
const containsCorruptedText = (text) => {
  if (!text || typeof text !== 'string') return true

  // Ê£ÄÊü•UnicodeÊõøÊç¢Â≠óÁ¨¶
  if (text.includes('\uFFFD') || text.includes('ÔøΩ')) {
    return true
  }

  // Ê£ÄÊü•ÊéßÂà∂Â≠óÁ¨¶ÔºàÈô§‰∫ÜÂ∏∏ËßÅÁöÑÁ©∫ÁôΩÂ≠óÁ¨¶Ôºâ
  const controlCharRegex = /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/
  if (controlCharRegex.test(text)) {
    return true
  }

  // Ê£ÄÊü•Â≠§Á´ã‰ª£ÁêÜÂØπÂ≠óÁ¨¶
  const surrogatePairRegex = /[\uD800-\uDFFF]/
  if (surrogatePairRegex.test(text)) {
    return true
  }

  return false
}

// Ê∏ÖÁêÜ‰π±Á†ÅÂ≠óÁ¨¶‰∏≤
const cleanCorruptedText = (text) => {
  if (!text || typeof text !== 'string') return ''

  return text
      // ÁßªÈô§UnicodeÊõøÊç¢Â≠óÁ¨¶
      .replace(/\uFFFD/g, '')
      .replace(/ÔøΩ/g, '')
      // ÁßªÈô§ÊéßÂà∂Â≠óÁ¨¶Ôºà‰øùÁïôÂ∏∏ËßÅÁ©∫ÁôΩÂ≠óÁ¨¶Ôºâ
      .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '')
      // ÁßªÈô§Â≠§Á´ã‰ª£ÁêÜÂØπÂ≠óÁ¨¶
      .replace(/[\uD800-\uDFFF]/g, '')
      // ËßÑËåÉÂåñUnicodeÂ≠óÁ¨¶
      .normalize('NFC')
      .trim()
}

// Â≠¶ÊúüÁõ∏ÂÖ≥ÂáΩÊï∞
const fetchAvailableSemesters = async () => {
  // Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±ÇÂíåÂπ∂ÂèëË∞ÉÁî®
  if (semesterLoading.value || isFetchingSemesters.value) {
    return
  }

  // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ≠åÊõ≤Êï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÁ≠âÂæÖ
  if (!props.songs || props.songs.length === 0) {
    return
  }

  isFetchingSemesters.value = true
  semesterLoading.value = true
  semesterError.value = ''

  // Â¶ÇÊûúÁªÑ‰ª∂Ê≠£Âú®ÂàùÂßãÂåñÔºåËÆæÁΩÆÊï∞ÊçÆÂä†ËΩΩÁä∂ÊÄÅ
  if (!isComponentInitialized.value) {
    isDataLoading.value = true
  }

  try {
    // ‰ΩøÁî®ÂÆåÊï¥ÁöÑÊ≠åÊõ≤Êï∞ÊçÆÊ∫êËÄå‰∏çÊòØËøáÊª§ÂêéÁöÑprops.songs
    let completeSongs = allSongsData.value || []

    // Ê£ÄÊü•Êï∞ÊçÆÊ∫êÁä∂ÊÄÅ

    // Â¶ÇÊûúallSongsData‰∏∫Á©∫Ôºå‰ΩÜprops.songsÊúâÊï∞ÊçÆÔºåÁõ¥Êé•‰ΩøÁî®props.songs‰Ωú‰∏∫Êï∞ÊçÆÊ∫ê
    if (completeSongs.length === 0 && props.songs && props.songs.length > 0) {
      completeSongs = props.songs
    }

    // Â¶ÇÊûúÂÆåÂÖ®Ê≤°ÊúâÊï∞ÊçÆÔºåÁõ¥Êé•ËøîÂõû
    if (completeSongs.length === 0) {
      availableSemesters.value = []
      return
    }

    // ‰ªéÂÆåÊï¥Ê≠åÊõ≤Êï∞ÊçÆ‰∏≠ÊèêÂèñÂ≠¶Êúü‰ø°ÊÅØÔºåÂπ∂ËøáÊª§‰π±Á†Å
    const rawSemesters = [...new Set(completeSongs.map(song => song.semester).filter(Boolean))]
    const cleanSemesters = rawSemesters
        .filter(semester => !containsCorruptedText(semester))
        .map(semester => cleanCorruptedText(semester))
        .filter(semester => semester.length > 0)

    // ÁªüËÆ°ÊØè‰∏™Â≠¶ÊúüÁöÑÊ≠åÊõ≤Êï∞ÈáèÔºåÂè™‰øùÁïôÊúâÊï∞ÊçÆÁöÑÂ≠¶Êúü
    const semesterStats = {}
    completeSongs.forEach(song => {
      if (song.semester && !containsCorruptedText(song.semester)) {
        const cleanSemester = cleanCorruptedText(song.semester)
        if (cleanSemester) {
          semesterStats[cleanSemester] = (semesterStats[cleanSemester] || 0) + 1
        }
      }
    })

    // Âè™‰øùÁïôÊúâÊï∞ÊçÆÁöÑÂ≠¶ÊúüÔºåÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó
    const semestersWithData = Object.keys(semesterStats)
        .filter(semester => semesterStats[semester] > 0)
        .sort().reverse()

    // ÁªüËÆ°ÊúâÊï∞ÊçÆÁöÑÂ≠¶Êúü

    // Â¶ÇÊûúÁî®Êà∑ÊâãÂä®ÈÄâÊã©‰∫ÜÂ≠¶ÊúüÔºåÁ°Æ‰øùËØ•Â≠¶Êúü‰øùÁïôÂú®ÂèØÁî®Â≠¶ÊúüÂàóË°®‰∏≠
    let finalSemesters = [...semestersWithData]
    if (isUserManuallySelected.value && selectedSemester.value &&
        !finalSemesters.includes(selectedSemester.value)) {
      // Â∞ÜÁî®Êà∑ÈÄâÊã©ÁöÑÂ≠¶ÊúüÊ∑ªÂä†Âà∞ÂàóË°®‰∏≠Ôºå‰øùÊåÅÊó∂Èó¥ÂÄíÂ∫è
      finalSemesters.push(selectedSemester.value)
      finalSemesters.sort().reverse()
    }

    // Êõ¥Êñ∞ÂèØÁî®Â≠¶ÊúüÂàóË°®
    availableSemesters.value = [...finalSemesters]

    // ÁºìÂ≠òÂ≠¶Êúü‰ø°ÊÅØÂà∞sessionStorage
    try {
      sessionStorage.setItem('voicehub_available_semesters', JSON.stringify(availableSemesters.value))
    } catch (error) {
      console.warn('Êó†Ê≥ïÁºìÂ≠òÂ≠¶Êúü‰ø°ÊÅØ:', error)
    }

    // Â¶ÇÊûúÁªÑ‰ª∂Êú™ÂÆåÂÖ®ÂàùÂßãÂåñÔºåÂè™ËÆæÁΩÆavailableSemestersÔºå‰∏çÊâßË°åÂ≠¶ÊúüÈÄâÊã©ÈÄªËæë
    if (!isComponentInitialized.value) {
      return
    }

    // ÊâßË°åÂ≠¶ÊúüÈÄâÊã©ÈÄªËæë
    await selectDefaultSemester()

  } catch (error) {
    console.error('Ëé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØÂ§±Ë¥•:', error)
    semesterError.value = 'Ëé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï'

    // ÈîôËØØÊÅ¢Â§çÔºö‰ΩøÁî®ÁºìÂ≠òÁöÑÂ≠¶Êúü‰ø°ÊÅØ
    try {
      const cachedSemesters = sessionStorage.getItem('voicehub_available_semesters')
      if (cachedSemesters) {
        availableSemesters.value = JSON.parse(cachedSemesters)
      }
    } catch (cacheError) {
      console.warn('Êó†Ê≥ïÊÅ¢Â§çÁºìÂ≠òÁöÑÂ≠¶Êúü‰ø°ÊÅØ:', cacheError)
    }
  } finally {
    semesterLoading.value = false
    isFetchingSemesters.value = false
    // Â¶ÇÊûúÁªÑ‰ª∂Ê≠£Âú®ÂàùÂßãÂåñÔºåÈáçÁΩÆÊï∞ÊçÆÂä†ËΩΩÁä∂ÊÄÅ
    if (!isComponentInitialized.value) {
      isDataLoading.value = false
    }
  }
}

// ÈÄâÊã©ÈªòËÆ§Â≠¶ÊúüÁöÑÈÄªËæë
const selectDefaultSemester = async () => {
  // Â¶ÇÊûúÊ≤°ÊúâÂèØÁî®Â≠¶ÊúüÔºåÊ∏ÖÁ©∫ÈÄâÊã©
  if (availableSemesters.value.length === 0) {
    selectedSemester.value = ''
    return
  }

  // Â¶ÇÊûúÂ∑≤ÁªèÊúâÈÄâ‰∏≠ÁöÑÂ≠¶Êúü‰∏îËØ•Â≠¶ÊúüÂú®ÂèØÁî®ÂàóË°®‰∏≠Ôºå‰øùÊåÅÈÄâÊã©ÔºàÂåÖÊã¨‰ªésessionStorageÊÅ¢Â§çÁöÑÈÄâÊã©Ôºâ
  if (selectedSemester.value && availableSemesters.value.includes(selectedSemester.value)) {
    // ‰øùÂ≠òÈÄâÊã©Âà∞sessionStorage‰ª•Á°Æ‰øùÁä∂ÊÄÅÂêåÊ≠•
    try {
      sessionStorage.setItem('voicehub_selected_semester', selectedSemester.value)
    } catch (error) {
      console.warn('Êó†Ê≥ï‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©:', error)
    }
    return
  }

  // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÂ≠¶Êúü‰∏çÂú®ÂèØÁî®ÂàóË°®‰∏≠ÔºåÊ∏ÖÁ©∫ÈÄâÊã©
  if (selectedSemester.value && !availableSemesters.value.includes(selectedSemester.value)) {
    selectedSemester.value = ''
  }

  // Â¶ÇÊûúÁî®Êà∑Â∑≤ÊâãÂä®ÈÄâÊã©Â≠¶Êúü‰∏îËØ•Â≠¶Êúü‰ªçÊúâÊï∞ÊçÆÔºå‰øùÊåÅÈÄâÊã©
  if (isUserManuallySelected.value && selectedSemester.value &&
      availableSemesters.value.includes(selectedSemester.value)) {
    return
  }

  // ‰ºòÂÖàÁ∫ß1: ‰ΩøÁî®ÂΩìÂâçÊ¥ªË∑ÉÂ≠¶ÊúüÔºàÂ¶ÇÊûúÊúâÊï∞ÊçÆ‰∏îAPIÂ∑≤ËøîÂõûÔºâ
  // Ê≥®ÊÑèÔºöÂè™ÊúâÂú®currentSemester APIÂ∑≤ÁªèËøîÂõûÊï∞ÊçÆÊó∂Êâç‰ΩøÁî®ÔºåÈÅøÂÖçÂú®APIÊú™ÂìçÂ∫îÊó∂ËøõË°åÂàáÊç¢
  if (currentSemester.value && currentSemester.value.name) {
    const currentSemesterName = currentSemester.value.name

    if (!containsCorruptedText(currentSemesterName)) {
      const cleanCurrentSemester = cleanCorruptedText(currentSemesterName)

      // Ê£ÄÊü•ÂΩìÂâçÂ≠¶ÊúüÊòØÂê¶Âú®ÊúâÊï∞ÊçÆÁöÑÂàóË°®‰∏≠
      if (cleanCurrentSemester && availableSemesters.value.includes(cleanCurrentSemester)) {
        selectedSemester.value = cleanCurrentSemester

        // ‰øùÂ≠òÈÄâÊã©Âà∞sessionStorage
        try {
          sessionStorage.setItem('voicehub_selected_semester', cleanCurrentSemester)
        } catch (error) {
          console.warn('Êó†Ê≥ï‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©:', error)
        }
        return
      }
    }
  }

  // ‰ºòÂÖàÁ∫ß2: Â∞ùËØï‰ªésessionStorageÊÅ¢Â§çÁºìÂ≠òÁöÑÈÄâÊã©ÔºàÂ¶ÇÊûúÊúâÊï∞ÊçÆÔºâ
  if (!selectedSemester.value) {
    try {
      const savedSemester = sessionStorage.getItem('voicehub_selected_semester')
      if (savedSemester && !containsCorruptedText(savedSemester)) {
        const cleanSavedSemester = cleanCorruptedText(savedSemester)

        // Âè™ÊúâÁºìÂ≠òÁöÑÂ≠¶ÊúüÂú®ÊúâÊï∞ÊçÆÁöÑÂàóË°®‰∏≠Êâç‰ΩøÁî®
        if (cleanSavedSemester && availableSemesters.value.includes(cleanSavedSemester)) {
          selectedSemester.value = cleanSavedSemester
          return
        } else {
          sessionStorage.removeItem('voicehub_selected_semester')
        }
      }
    } catch (error) {
      console.warn('ÊÅ¢Â§çÁºìÂ≠òÂ≠¶ÊúüÈÄâÊã©Â§±Ë¥•:', error)
      sessionStorage.removeItem('voicehub_selected_semester')
    }
  }

  // ‰ºòÂÖàÁ∫ß3: ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊï∞ÊçÆÁöÑÂ≠¶Êúü‰Ωú‰∏∫ÈªòËÆ§
  if (!selectedSemester.value && availableSemesters.value.length > 0) {
    selectedSemester.value = availableSemesters.value[0]

    // ‰øùÂ≠òÈÄâÊã©Âà∞sessionStorage
    try {
      sessionStorage.setItem('voicehub_selected_semester', availableSemesters.value[0])
    } catch (error) {
      console.warn('Êó†Ê≥ï‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©:', error)
    }
  }
}

const onSemesterChange = (semester) => {
  // Â¢ûÂº∫ÁöÑÂä†ËΩΩÁä∂ÊÄÅÊ£ÄÊü•
  if (semesterLoading.value || isDataLoading.value || !isComponentInitialized.value) {
    return // Èò≤Ê≠¢Âú®Âä†ËΩΩÊó∂ÊàñÁªÑ‰ª∂Êú™ÂàùÂßãÂåñÊó∂ÂàáÊç¢
  }

  // Ê£ÄÊü•Âπ∂Ê∏ÖÁêÜÂ≠¶ÊúüÊï∞ÊçÆ
  if (containsCorruptedText(semester)) {
    console.warn('Â≠¶ÊúüÊï∞ÊçÆÂåÖÂê´‰π±Á†ÅÔºåÂøΩÁï•ÂàáÊç¢ËØ∑Ê±Ç')
    return
  }

  const cleanSemester = cleanCorruptedText(semester)
  if (!cleanSemester) {
    console.warn('Ê∏ÖÁêÜÂêéÁöÑÂ≠¶ÊúüÊï∞ÊçÆ‰∏∫Á©∫ÔºåÂøΩÁï•ÂàáÊç¢ËØ∑Ê±Ç')
    return
  }

  // Ê£ÄÊü•Â≠¶ÊúüÊòØÂê¶Âú®ÂèØÁî®ÂàóË°®‰∏≠
  if (!availableSemesters.value.includes(cleanSemester)) {
    console.warn('ÈÄâÊã©ÁöÑÂ≠¶Êúü‰∏çÂú®ÂèØÁî®ÂàóË°®‰∏≠:', cleanSemester)
    return
  }


  // Ê†áËÆ∞‰∏∫Áî®Êà∑ÊâãÂä®ÈÄâÊã©
  isUserManuallySelected.value = true

  // Á´ãÂç≥Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÂ≠¶ÊúüÔºåÁ°Æ‰øùUIÂìçÂ∫î
  selectedSemester.value = cleanSemester

  // ‰ΩøÁî®nextTickÁ°Æ‰øùDOMÊõ¥Êñ∞ÂêéÊ†∑ÂºèËÉΩÊ≠£Á°ÆÂ∫îÁî®
  nextTick(() => {
    // DOMÂ∑≤Êõ¥Êñ∞ÔºåÂ≠¶ÊúüÈÄâÊã©Ê†∑ÂºèÂ∫îËØ•Â∑≤Â∫îÁî®
  })

  // ‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©Âà∞sessionStorage
  try {
    sessionStorage.setItem('voicehub_selected_semester', cleanSemester)
    sessionStorage.setItem('voicehub_user_manually_selected', 'true')
  } catch (error) {
    console.warn('Êó†Ê≥ï‰øùÂ≠òÂ≠¶ÊúüÈÄâÊã©:', error)
  }

  // ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
  showSemesterDropdown.value = false

  // ‰ΩøÁî®Èò≤ÊäñÂ§ÑÁêÜÂÖ∂‰ªñÈÄªËæë
  debouncedSemesterChange(cleanSemester)
}

// ÈáçËØïËé∑ÂèñÂ≠¶Êúü‰ø°ÊÅØ
const retrySemesterFetch = () => {
  // Ê£ÄÊü•ÁªÑ‰ª∂Áä∂ÊÄÅÔºåÁ°Æ‰øùÂèØ‰ª•ÂÆâÂÖ®ÈáçËØï
  if (semesterLoading.value || isDataLoading.value) {
    return
  }

  semesterError.value = ''
  fetchAvailableSemesters()
}

// Èò≤ÊäñÂáΩÊï∞ÂÆûÁé∞
function debounce(func, wait) {
  let timeout
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout)
      func(...args)
    }
    clearTimeout(timeout)
    timeout = setTimeout(later, wait)
  }
}

// ÂΩìÁªÑ‰ª∂ÈîÄÊØÅÊó∂‰∏çÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÔºåÈü≥È¢ëÊí≠ÊîæÁî±ÂÖ®Â±ÄÁÆ°ÁêÜ

// Ê≥¢Á∫πÊïàÊûúÊåá‰ª§
const vRipple = {
  mounted(el) {
    el.addEventListener('click', e => {
      const rect = el.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const ripple = document.createElement('span');
      ripple.className = 'ripple-effect';
      ripple.style.left = `${x}px`;
      ripple.style.top = `${y}px`;

      el.appendChild(ripple);

      setTimeout(() => {
        ripple.remove();
      }, 600); // ‰∏éCSSÂä®ÁîªÊó∂Èó¥‰∏ÄËá¥
    });
  }
};
</script>

<style scoped>
.song-list {
  width: 100%;
  position: relative;
  z-index: 2;
}

.song-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.tab-controls {
  display: flex;
  gap: 1rem;
}

/* Ê†áÁ≠æÂàáÊç¢Âä®Áîª */
.tab-switch-enter-active,
.tab-switch-leave-active {
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.tab-switch-enter-from {
  opacity: 0;
  transform: translateY(30px);
}

.tab-switch-leave-to {
  opacity: 0;
  transform: translateY(-30px);
}

/* Ê†áÁ≠æÊåâÈíÆÊ†∑Âºè */
.tab-button {
  position: relative;
  overflow: hidden;
  background: transparent;
  border: none;
  padding: 0.75rem 1.5rem;
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 16px;
  color: rgba(255, 255, 255, 0.6);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  border-bottom: 3px solid transparent;
  margin: 0 0.5rem;
}

.tab-button:hover {
  color: rgba(255, 255, 255, 0.9);
  transform: translateY(-3px);
}

.tab-button.active {
  color: #FFFFFF;
  border-bottom-color: #0B5AFE;
  transform: none;
  box-shadow: none;
  background-color: transparent;
}

.tab-button:focus {
  outline: none;
}

/* Ê≥¢Á∫πÊïàÊûú */
.ripple-effect {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(11, 90, 254, 0.3) 0%, rgba(255, 255, 255, 0.1) 70%);
  transform: scale(0);
  animation: ripple 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
  pointer-events: none;
  width: 150px;
  height: 150px;
  margin-left: -75px;
  margin-top: -75px;
}

@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

.search-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

/* Á¥ßÂáëÂûãÂ≠¶ÊúüÈÄâÊã©Âô®Ê†∑Âºè */
.semester-selector-compact {
  position: relative;
}

.semester-toggle-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: #21242D;
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  padding: 0;
}

.semester-toggle-btn:hover {
  background: #2A2E38;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  color: #0B5AFE;
}

.semester-dropdown {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: #1A1D24;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 100;
  min-width: 180px;
  overflow: hidden;
}

.semester-option {
  padding: 0.75rem 1rem;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.semester-option:last-child {
  border-bottom: none;
}

.semester-option:hover {
  background: rgba(11, 90, 254, 0.1);
  color: #FFFFFF;
}

.semester-option.active {
  background: rgba(11, 90, 254, 0.2);
  color: #0B5AFE;
  font-weight: 600;
}

.search-box {
  position: relative;
  width: 250px;
}

.search-input {
  background: #040E15;
  border: 1px solid #242F38;
  border-radius: 8px;
  padding: 0.5rem 1rem;
  padding-right: 2.5rem;
  font-family: 'MiSans-Demibold', sans-serif;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  width: 100%;
  transition: all 0.2s ease;
}

.search-input:focus {
  outline: none;
  border-color: #0B5AFE;
}

.search-icon {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: rgba(255, 255, 255, 0.6);
}

.refresh-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: #21242D;
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: rgba(255, 255, 255, 0.8);
}

.refresh-button:hover {
  background: #2A2E38;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.refresh-button:active {
  transform: translateY(0);
}

.refresh-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.refresh-icon {
  width: 18px;
  height: 18px;
  transition: transform 0.3s ease;
}

.refresh-icon.rotating {
  animation: rotate 1.2s cubic-bezier(0.5, 0.1, 0.5, 1) infinite;
}

/* Âä†ËΩΩÂä®Áîª */
@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.loading {
  text-align: center;
  padding: 3rem;
  color: rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.loading::before {
  content: "";
  display: block;
  width: 40px;
  height: 40px;
  margin-bottom: 1rem;
  border-radius: 50%;
  border: 3px solid rgba(11, 90, 254, 0.2);
  border-top-color: #0B5AFE;
  animation: spin 1s linear infinite;
}

.error,
.empty {
  text-align: center;
  padding: 2rem;
  color: rgba(255, 255, 255, 0.6);
}

.error {
  color: #ef4444;
}

.songs-container {
  width: 100%;
}

.song-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}

.song-card {
  width: calc(33.333% - 0.75rem);
  background: transparent;
  border-radius: 10px;
  overflow: visible;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.song-card-main {
  padding: 1rem 0 1rem 1rem; /* ÁßªÈô§Âè≥‰æßÂÜÖËæπË∑ùÔºå‰øùÁïôÂ∑¶‰æß„ÄÅ‰∏ä‰∏ãÂÜÖËæπË∑ù */
  background: #21242D;
  box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
  position: relative;
  height: 100px; /* ÂáèÂ∞èÂç°ÁâáÈ´òÂ∫¶ */
  border-radius: 10px;
  width: 100%;
  z-index: 2;
  margin-bottom: -5px;
  overflow: hidden;
  display: flex; /* ‰ΩøÁî®flexÂ∏ÉÂ±Ä */
  align-items: center; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
  gap: 15px; /* ÂÖÉÁ¥†‰πãÈó¥ÁöÑÈó¥Èöî */
  box-sizing: border-box; /* Á°Æ‰øùÂÜÖËæπË∑ù‰∏ç‰ºöÂ¢ûÂä†ÂÖÉÁ¥†ÁöÑÊÄªÂÆΩÂ∫¶ */
}

/* ÁßªÈô§Â∑¶‰æßÁä∂ÊÄÅÊù° */

.song-card.played {
  opacity: 0.6;
}

/* Ê≠åÊõ≤Â∞ÅÈù¢Ê†∑Âºè */
.song-cover {
  width: 55px;
  height: 55px;
  flex-shrink: 0;
  position: relative;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.cover-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* ÊñáÂ≠óÂ∞ÅÈù¢Ê†∑Âºè */
.text-cover {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #0043F8 0%, #0075F8 100%);
  color: #FFFFFF;
  font-size: 28px;
  font-weight: bold;
  font-family: 'MiSans-Demibold', sans-serif;
}

/* Êí≠ÊîæÊåâÈíÆÂè†Âä†Â±Ç */
.play-button-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0, 0, 0, 0.4);
  opacity: 0;
  transition: opacity 0.2s ease;
  cursor: pointer;
}

.song-cover:hover .play-button-overlay {
  opacity: 1;
}

/* Êí≠ÊîæÊåâÈíÆÊ†∑Âºè */
.play-button {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: rgba(11, 90, 254, 0.8);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.play-button:hover {
  transform: scale(1.1);
}

/* Êí≠ÊîæÂõæÊ†áÊ†∑ÂºèÂ∑≤ÁßªËá≥IconÁªÑ‰ª∂ */

/* ‰øÆÊîπÊ≠åÊõ≤‰ø°ÊÅØÂå∫ÂüüÁöÑCSSÊ†∑Âºè */
.song-info {
  flex: 1;
  width: 100%; /* ‰ΩøÁî®100%ÂÆΩÂ∫¶ */
  min-width: 0; /* ÂÖÅËÆ∏ÂÜÖÂÆπÊî∂Áº© */
  padding-right: 10px; /* Ê∑ªÂä†Âè≥‰æßÂÜÖËæπË∑ùÔºåËÄå‰∏çÊòØÂ§ñËæπË∑ù */
  overflow: hidden; /* Á°Æ‰øùÂÜÖÂÆπ‰∏ç‰ºöÊ∫¢Âá∫ */
}

.song-title {
  font-family: 'MiSans', sans-serif;
  font-weight: 600;
  font-size: 16px;
  letter-spacing: 0.04em;
  color: #FFFFFF;
  margin-bottom: 0.5rem;
  width: 100%; /* Á°Æ‰øùÊ†áÈ¢òÂç†Êª°Êï¥‰∏™ÂÆπÂô®ÂÆΩÂ∫¶ */
  display: flex;
  align-items: center;
}

/* Ê∑ªÂä†‰∏Ä‰∏™ÂåÖË£ÖÂô®Êù•Â§ÑÁêÜÊ≠åÊõ≤Ê†áÈ¢òÂíåÊ≠åÊâãÁöÑÊñáÊú¨Ê∫¢Âá∫ */
.song-title-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  min-width: 0; /* ÂÖÅËÆ∏ÊñáÊú¨Êî∂Áº© */
}

.song-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  width: 100%;
}

.requester {
  font-family: 'MiSans', sans-serif;
  font-weight: normal;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* ‰øÆÊîπÁÉ≠Â∫¶ÂíåÁÇπËµûÊåâÈíÆÂå∫ÂüüÁöÑCSSÊ†∑Âºè */
.action-area {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 0; /* ÂÆåÂÖ®ÁßªÈô§Èó¥Ë∑ù */
  margin-left: auto;
  margin-right: 10px; /* Ê∑ªÂä†Âè≥‰æßÂ§ñËæπË∑ùÔºå‰ΩøÊï¥‰ΩìÂêëÂ∑¶ÁßªÂä® */
  flex-shrink: 0;
  width: auto; /* ‰ΩøÁî®Ëá™Âä®ÂÆΩÂ∫¶ */
  min-width: 100px; /* Â¢ûÂä†ÊúÄÂ∞èÂÆΩÂ∫¶ÔºåÁ°Æ‰øùÁÉ≠Â∫¶ÂíåÁÇπËµûÊåâÈíÆÊúâÊõ¥Â§öÁ©∫Èó¥ */
  padding-right: 0; /* ÁßªÈô§Âè≥‰æßÂÜÖËæπË∑ù */
}

/* ÁÉ≠Â∫¶Ê†∑Âºè */
.vote-count {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 45px; /* Â¢ûÂä†ÁÉ≠Â∫¶ÊòæÁ§∫ÁöÑÊúÄÂ∞èÂÆΩÂ∫¶ */
}

.vote-count .count {
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 20px;
  color: #0B5AFE;
  text-shadow: 0px 20px 30px rgba(0, 114, 248, 0.5),
  0px 8px 15px rgba(0, 114, 248, 0.5),
  0px 4px 10px rgba(0, 179, 248, 0.3),
  0px 2px 10px rgba(0, 179, 248, 0.2),
  inset 3px 3px 10px rgba(255, 255, 255, 0.4),
  inset -1px -1px 15px rgba(255, 255, 255, 0.4);
}

.vote-count .label {
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 12px;
  color: #FFFFFF;
  opacity: 0.4;
}

/* ÁÇπËµûÊåâÈíÆÊ†∑Âºè */
.like-button-wrapper {
  /* ÂêëÂè≥ÁßªÂä®ÁÇπËµûÊåâÈíÆÔºå‰ΩÜËÄÉËôëÂà∞Êï¥‰ΩìÂ∑≤ÂêëÂ∑¶ÁßªÂä®ÔºåÂáèÂ∞èË¥üËæπË∑ù */
  margin-right: -10px;
}

.like-button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 45px;
  background: linear-gradient(180deg, #0043F8 0%, #0075F8 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.like-button.liked {
  background: #1A1D24;
  border-color: #242F38;
  background-image: none;
}

.like-button.disabled {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  cursor: not-allowed;
  opacity: 0.5;
}

.like-button.disabled .like-icon {
  opacity: 0.5;
}

.like-icon {
  width: 20px;
  height: 20px;
  transition: transform 0.2s ease;
}

.like-button:hover .like-icon {
  transform: scale(1.2);
}

.scheduled-tag {
  display: inline-flex;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: 4px;
  padding: 0.15rem 0.4rem;
  font-size: 0.7rem;
  color: #10b981;
  margin-left: 0.5rem;
  flex-shrink: 0; /* Èò≤Ê≠¢Ê†áÁ≠æË¢´ÂéãÁº© */
  align-self: center; /* Á°Æ‰øùÂûÇÁõ¥Â±Ö‰∏≠ */
}

.played-tag {
  display: inline-flex;
  background: rgba(16, 185, 129, 0.2);
  border: 1px solid rgba(16, 185, 129, 0.4);
  border-radius: 4px;
  padding: 0.15rem 0.4rem;
  font-size: 0.7rem;
  color: #10b981;
  margin-left: 0.5rem;
  flex-shrink: 0; /* Èò≤Ê≠¢Ê†áÁ≠æË¢´ÂéãÁº© */
  align-self: center; /* Á°Æ‰øùÂûÇÁõ¥Â±Ö‰∏≠ */
}

/* ÊäïÁ®øÊó∂Èó¥ÂíåÊí§ÈîÄÊåâÈíÆ */
.submission-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #21242D;
  border-radius: 0 0 10px 10px;
  padding: 0.5rem 1rem;
  width: 95%;
  position: relative;
  z-index: 1;
  height: 45px;
}

.submission-time {
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  text-align: left;
  max-width: 70%;
}

.withdraw-button {
  background: linear-gradient(180deg, #FF2F2F 0%, #FF654D 100%);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 8px;
  padding: 0.25rem 0.75rem;
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 12px;
  color: #FFFFFF;
  cursor: pointer;
  transition: all 0.3s ease;
  height: 27px;
  min-width: 51px;
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
}

.withdraw-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.withdraw-button:active {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* ÂàÜÈ°µÊéß‰ª∂ */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 1.5rem;
  gap: 0.5rem;
}

.page-button, .page-number {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  color: #FFFFFF;
  cursor: pointer;
  transition: all 0.2s ease;
}

.page-number.active {
  background: #0B5AFE;
  border-color: #0B5AFE;
}

.page-info {
  margin-left: 0.5rem;
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.875rem;
}

/* Ëá™ÂÆö‰πâË∑≥ËΩ¨Êéß‰ª∂ */
.page-jump {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-left: 1rem;
}

.jump-label {
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.875rem;
  white-space: nowrap;
}

.jump-input {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  color: #FFFFFF;
  width: 60px;
  text-align: center;
  transition: all 0.2s ease;
}

.jump-input:focus {
  outline: none;
  border-color: #0B5AFE;
  background: rgba(255, 255, 255, 0.15);
}

.jump-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
  font-size: 0.75rem;
}

.jump-button {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  color: #FFFFFF;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.jump-button:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
}

.jump-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Á°ÆËÆ§ÂØπËØùÊ°Ü */
.confirm-dialog-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.confirm-dialog {
  background: #21242D;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.confirm-dialog-header {
  padding: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.confirm-dialog-content {
  padding: 1.5rem 1rem;
}

.confirm-dialog-actions {
  display: flex;
  justify-content: flex-end;
  padding: 1rem;
  gap: 0.75rem;
}

.confirm-dialog-btn {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-family: 'MiSans-Demibold', sans-serif;
  font-weight: 600;
  font-size: 14px;
  border: 1px solid rgba(255, 255, 255, 0.16);
  cursor: pointer;
}

.confirm-dialog-cancel {
  background: rgba(255, 255, 255, 0.1);
  color: #FFFFFF;
}

.confirm-dialog-confirm {
  background: linear-gradient(180deg, #0043F8 0%, #0075F8 100%);
  color: #FFFFFF;
}

/* ÂìçÂ∫îÂºèÈÄÇÈÖç */
@media (max-width: 1200px) {
  .song-card {
    width: calc(50% - 0.5rem);
  }
}

@media (max-width: 768px) {
  .song-list-header {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .tab-controls {
    justify-content: center;
  }

  .tab-button {
    flex: 1;
    padding: 0.5rem;
  }

  .search-actions {
    width: 100%;
    justify-content: space-between;
  }

  .search-box {
    width: calc(100% - 50px);
  }

  .song-card {
    width: 100%;
  }

  .song-info {
    width: 60%;
  }

  .action-area {
    gap: 0.5rem;
  }

  .pagination {
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.25rem;
  }

  .page-numbers {
    order: 3;
    width: 100%;
    display: flex;
    justify-content: center;
    margin-top: 0.5rem;
  }

  .page-info {
    order: 4;
    margin: 0.5rem 0 0 0;
    text-align: center;
  }

  .page-jump {
    order: 5;
    margin: 0.5rem 0 0 0;
    justify-content: center;
  }

  .jump-label {
    font-size: 0.75rem;
  }

  .jump-input {
    width: 50px;
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
  }

  .jump-button {
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
  }
}

/* ÁøªÈ°µÂä®Áîª */
.page-enter-active,
.page-leave-active {
  transition: all 0.4s ease;
}

.page-enter-from {
  opacity: 0;
  transform: translateY(30px);
}

.page-leave-to {
  opacity: 0;
  transform: translateY(-30px);
}

.page-move {
  transition: transform 0.4s ease;
}
</style>