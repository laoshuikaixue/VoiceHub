name: è‡ªåŠ¨æ›´æ–°ä¾èµ–

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ˆUTCæ—¶é—´å‡Œæ™¨1ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°ä¾èµ–'

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
      checks: write
      repository-projects: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ PAT token ä»¥è·å¾—åˆ›å»º PR çš„æƒé™
          # å¦‚æœæ²¡æœ‰è®¾ç½® PAT_TOKENï¼Œåˆ™å›é€€åˆ° GITHUB_TOKEN
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ›´æ–°ä¾èµ–
        run: |
          # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
          npm update
          
          # å°è¯•ä¿®å¤å®‰å…¨æ¼æ´ï¼ˆéç ´åæ€§ä¿®å¤ï¼‰
          npm audit fix || true

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        id: check-changes
        run: |
          if git diff --quiet package-lock.json; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰ä¾èµ–æ›´æ–°"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä¾èµ–æ›´æ–°"
          fi

      - name: è·å–æ›´æ–°ä¿¡æ¯
        if: steps.check-changes.outputs.has-changes == 'true'
        id: update-info
        run: |
          # è·å–å½“å‰æ—¥æœŸ
          CURRENT_DATE=$(date +'%Y-%m-%d')
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # è·å–æ›´æ–°çš„åŒ…ä¿¡æ¯
          echo "updated-packages<<EOF" >> $GITHUB_OUTPUT
          if git diff --name-only | grep -q package-lock.json; then
            echo "- package-lock.json å·²æ›´æ–°" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only | grep -q package.json; then
            echo "- package.json å·²æ›´æ–°" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è·å–è¯¦ç»†çš„å®‰å…¨å®¡è®¡ç»“æœ
          echo "audit-result<<EOF" >> $GITHUB_OUTPUT
          echo "æ­£åœ¨è¿è¡Œå®‰å…¨å®¡è®¡..."
          AUDIT_OUTPUT=$(npm audit --audit-level=moderate 2>&1 || true)
          if [ -n "$AUDIT_OUTPUT" ]; then
            echo "$AUDIT_OUTPUT"
          else
            echo "npm audit å‘½ä»¤æœªè¿”å›ä»»ä½•è¾“å‡º"
          fi
          
          # é¢å¤–çš„å®‰å…¨ä¿¡æ¯
          echo ""
          echo "--- å®¡è®¡æ‘˜è¦ ---"
          AUDIT_SUMMARY=$(npm audit --audit-level=moderate --json 2>/dev/null | jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' 2>/dev/null || echo "æ— æ³•è·å–JSONæ ¼å¼çš„å®¡è®¡æ‘˜è¦")
          if [ "$AUDIT_SUMMARY" != "æ— æ³•è·å–JSONæ ¼å¼çš„å®¡è®¡æ‘˜è¦" ]; then
            echo "$AUDIT_SUMMARY"
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç®€å•çš„æ–‡æœ¬è§£æ
            VULN_COUNT=$(echo "$AUDIT_OUTPUT" | grep -o '[0-9]\+ vulnerabilities' | head -1 || echo "0 vulnerabilities")
            echo "å‘ç°çš„æ¼æ´: $VULN_COUNT"
          fi
          echo "EOF" >> $GITHUB_OUTPUT
          
          # è·å–ä¾èµ–å˜æ›´è¯¦æƒ…
          echo "dependency-changes<<EOF" >> $GITHUB_OUTPUT
          if git diff --name-only | grep -q package-lock.json; then
            echo "### ä¾èµ–å˜æ›´è¯¦æƒ…"
            echo ""
            # è·å– package.json ä¸­çš„å˜æ›´
            if git diff --name-only | grep -q package.json; then
              echo "#### package.json å˜æ›´ï¼š"
              git diff package.json | grep -E '^[+-]' | grep -v '^[+-]{3}' | head -20 || echo "æ— æ³•è·å–è¯¦ç»†å˜æ›´"
              echo ""
            fi
            # æ˜¾ç¤ºæ›´æ–°çš„åŒ…æ•°é‡ç»Ÿè®¡
            ADDED=$(git diff package-lock.json | grep -c '^+.*"version":' || echo "0")
            REMOVED=$(git diff package-lock.json | grep -c '^-.*"version":' || echo "0")
            echo "#### æ›´æ–°ç»Ÿè®¡ï¼š"
            echo "- æ–°å¢/æ›´æ–°çš„åŒ…ç‰ˆæœ¬: $ADDED"
            echo "- ç§»é™¤çš„åŒ…ç‰ˆæœ¬: $REMOVED"
          else
            echo "æ— ä¾èµ–æ–‡ä»¶å˜æ›´"
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          # ä½¿ç”¨ PAT token ä»¥è·å¾—åˆ›å»º PR çš„æƒé™
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: è‡ªåŠ¨æ›´æ–°ä¾èµ– (${{ steps.update-info.outputs.date }})
            
            ${{ steps.update-info.outputs.updated-packages }}
          title: 'è‡ªåŠ¨ä¾èµ–æ›´æ–° - ${{ steps.update-info.outputs.date }}'
          body: |
            ## è‡ªåŠ¨ä¾èµ–æ›´æ–°
            
            - è§¦å‘æ—¶é—´: ${{ steps.update-info.outputs.date }}
            - å·¥ä½œæµ: dependency-update.yml
            - Node.js ç‰ˆæœ¬: 18
            
            ### æ›´æ–°å†…å®¹
            æ­¤ PR åŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            - æ‰€æœ‰ä¾èµ–åŒ…å·²æ›´æ–°åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬
            - å·²ä¿®å¤å·²çŸ¥çš„å®‰å…¨æ¼æ´
            - package-lock.json æ–‡ä»¶å·²åŒæ­¥æ›´æ–°
            
            <details>
            <summary>ğŸ“‹ è¯¦ç»†æ›´æ–°ä¿¡æ¯ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
            
            #### æ›´æ–°çš„æ–‡ä»¶
            ${{ steps.update-info.outputs.updated-packages }}
            
            ${{ steps.update-info.outputs.dependency-changes }}
            
            #### å®‰å…¨å®¡è®¡ç»“æœ
            
            ${{ steps.update-info.outputs.audit-result }}
            
            > å¦‚æœå®‰å…¨å®¡è®¡ç»“æœä¸ºç©ºï¼Œå¯èƒ½æ˜¯å› ä¸ºï¼š
            > - æ‰€æœ‰ä¾èµ–éƒ½æ˜¯å®‰å…¨çš„ï¼Œæ²¡æœ‰å‘ç°æ¼æ´
            > - npm audit å‘½ä»¤æ‰§è¡Œæ—¶é‡åˆ°äº†é—®é¢˜
            > - ä¾èµ–åŒ…çš„å®‰å…¨æ•°æ®åº“æš‚æ—¶ä¸å¯ç”¨
            
            </details>
          branch: auto-dependency-update-${{ steps.update-info.outputs.date }}
          delete-branch: true
          labels: |
            dependencies
            automated
            chore
          assignees: laoshuikaixue

      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]; then
            echo "ä¾èµ–æ›´æ–°å®Œæˆï¼Œå·²åˆ›å»º Pull Request"
          else
            echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi