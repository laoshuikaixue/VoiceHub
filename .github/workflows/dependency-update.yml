name: è‡ªåŠ¨æ›´æ–°ä¾èµ–

on:
  schedule:
    # æ¯å‘¨ä¸€çš„åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ˆUTCæ—¶é—´å‡Œæ™¨1ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 1 * * 1'
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°ä¾èµ–'

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ›´æ–°ä¾èµ–
        run: |
          # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
          npm update
          
          # å°è¯•ä¿®å¤å®‰å…¨æ¼æ´ï¼ˆéç ´åæ€§ä¿®å¤ï¼‰
          npm audit fix || true

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        id: check-changes
        run: |
          if git diff --quiet package-lock.json; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰ä¾èµ–æ›´æ–°"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä¾èµ–æ›´æ–°"
          fi

      - name: è·å–æ›´æ–°ä¿¡æ¯
        if: steps.check-changes.outputs.has-changes == 'true'
        id: update-info
        run: |
          # è·å–å½“å‰æ—¥æœŸ
          CURRENT_DATE=$(date +'%Y-%m-%d')
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ›´æ–°æ‘˜è¦
          echo "## ä¾èµ–æ›´æ–°æ‘˜è¦ - $CURRENT_DATE" > update-summary.md
          echo "" >> update-summary.md
          echo "### æ›´æ–°çš„åŒ…:" >> update-summary.md
          
          # æ£€æŸ¥å“ªäº›åŒ…è¢«æ›´æ–°äº†
          git diff --name-only package-lock.json > /dev/null && echo "- package-lock.json å·²æ›´æ–°" >> update-summary.md
          
          # è¿è¡Œå®‰å…¨å®¡è®¡
          echo "" >> update-summary.md
          echo "### å®‰å…¨å®¡è®¡ç»“æœ:" >> update-summary.md
          npm audit --audit-level=moderate >> update-summary.md || echo "å‘ç°ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯" >> update-summary.md

      - name: åˆ›å»º Pull Request
        if: steps.check-changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: è‡ªåŠ¨æ›´æ–°ä¾èµ– (${{ steps.update-info.outputs.date }})
            
            - æ›´æ–°æ‰€æœ‰ä¾èµ–åŒ…åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬
            - ä¿®å¤å·²çŸ¥çš„å®‰å…¨æ¼æ´
            - æ›´æ–° package-lock.json æ–‡ä»¶
          title: 'ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–° - ${{ steps.update-info.outputs.date }}'
          body: |
            ## ğŸ“¦ è‡ªåŠ¨ä¾èµ–æ›´æ–°
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            
            - âœ… æ‰€æœ‰ä¾èµ–åŒ…å·²æ›´æ–°åˆ°æœ€æ–°ç¨³å®šç‰ˆæœ¬
            - ğŸ”’ å·²ä¿®å¤å·²çŸ¥çš„å®‰å…¨æ¼æ´
            - ğŸ“„ package-lock.json æ–‡ä»¶å·²åŒæ­¥æ›´æ–°
            
            ### ğŸ” æ›´æ–°è¯¦æƒ…
            
            è¯·æŸ¥çœ‹æ–‡ä»¶å˜æ›´ä»¥äº†è§£å…·ä½“çš„ä¾èµ–æ›´æ–°æƒ…å†µã€‚
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            
            - è¯·åœ¨åˆå¹¶å‰è¿›è¡Œå……åˆ†æµ‹è¯•
            - æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
            - ç¡®è®¤åº”ç”¨ç¨‹åºæ­£å¸¸è¿è¡Œ
            
            ### ğŸ¤– è‡ªåŠ¨åŒ–ä¿¡æ¯
            
            - è§¦å‘æ—¶é—´: ${{ steps.update-info.outputs.date }}
            - å·¥ä½œæµ: dependency-update.yml
            - Node.js ç‰ˆæœ¬: 18
          branch: auto-dependency-update-${{ steps.update-info.outputs.date }}
          delete-branch: true
          labels: |
            dependencies
            automated
            chore

      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.check-changes.outputs.has-changes }}" == "true" ]; then
            echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆï¼Œå·²åˆ›å»º Pull Request"
          else
            echo "â„¹ï¸ æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi